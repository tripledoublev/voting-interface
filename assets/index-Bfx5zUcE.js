var Qs=Object.defineProperty;var Ks=(r,e,t)=>e in r?Qs(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var zr=(r,e,t)=>(Ks(r,typeof e!="symbol"?e+"":e,t),t);function Gs(r,e){for(var t=0;t<e.length;t++){const n=e[t];if(typeof n!="string"&&!Array.isArray(n)){for(const u in n)if(u!=="default"&&!(u in r)){const s=Object.getOwnPropertyDescriptor(n,u);s&&Object.defineProperty(r,u,s.get?s:{enumerable:!0,get:()=>n[u]})}}}return Object.freeze(Object.defineProperty(r,Symbol.toStringTag,{value:"Module"}))}(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const u of document.querySelectorAll('link[rel="modulepreload"]'))n(u);new MutationObserver(u=>{for(const s of u)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function t(u){const s={};return u.integrity&&(s.integrity=u.integrity),u.referrerPolicy&&(s.referrerPolicy=u.referrerPolicy),u.crossOrigin==="use-credentials"?s.credentials="include":u.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(u){if(u.ep)return;u.ep=!0;const s=t(u);fetch(u.href,s)}})();function W(){}const Rr=r=>r;function Ru(r){return r()}function Tn(){return Object.create(null)}function Re(r){r.forEach(Ru)}function ar(r){return typeof r=="function"}function Ze(r,e){return r!=r?e==e:r!==e||r&&typeof r=="object"||typeof r=="function"}function Ys(r){return Object.keys(r).length===0}function Xs(r,...e){if(r==null){for(const n of e)n(void 0);return W}const t=r.subscribe(...e);return t.unsubscribe?()=>t.unsubscribe():t}function Mu(r,e,t){r.$$.on_destroy.push(Xs(e,t))}function In(r){const e=typeof r=="string"&&r.match(/^\s*(-?[\d.]+)([^\s]*)\s*$/);return e?[parseFloat(e[1]),e[2]||"px"]:[r,"px"]}const ju=typeof window<"u";let mn=ju?()=>window.performance.now():()=>Date.now(),gn=ju?r=>requestAnimationFrame(r):W;const _t=new Set;function Nu(r){_t.forEach(e=>{e.c(r)||(_t.delete(e),e.f())}),_t.size!==0&&gn(Nu)}function bn(r){let e;return _t.size===0&&gn(Nu),{promise:new Promise(t=>{_t.add(e={c:r,f:t})}),abort(){_t.delete(e)}}}function A(r,e){r.appendChild(e)}function Lu(r){if(!r)return document;const e=r.getRootNode?r.getRootNode():r.ownerDocument;return e&&e.host?e:r.ownerDocument}function Zs(r){const e=F("style");return e.textContent="/* empty */",Js(Lu(r),e),e.sheet}function Js(r,e){return A(r.head||r,e),e.sheet}function $(r,e,t){r.insertBefore(e,t||null)}function j(r){r.parentNode&&r.parentNode.removeChild(r)}function Uu(r,e){for(let t=0;t<r.length;t+=1)r[t]&&r[t].d(e)}function F(r){return document.createElement(r)}function On(r){return document.createElementNS("http://www.w3.org/2000/svg",r)}function oe(r){return document.createTextNode(r)}function M(){return oe(" ")}function $u(){return oe("")}function xe(r,e,t,n){return r.addEventListener(e,t,n),()=>r.removeEventListener(e,t,n)}function C(r,e,t){t==null?r.removeAttribute(e):r.getAttribute(e)!==t&&r.setAttribute(e,t)}function ei(r){return Array.from(r.childNodes)}function Ie(r,e){e=""+e,r.data!==e&&(r.data=e)}function an(r,e,t,n){t==null?r.style.removeProperty(e):r.style.setProperty(e,t,n?"important":"")}function Rn(r,e,t){r.classList.toggle(e,!!t)}function Hu(r,e,{bubbles:t=!1,cancelable:n=!1}={}){return new CustomEvent(r,{detail:e,bubbles:t,cancelable:n})}const Er=new Map;let Fr=0;function ti(r){let e=5381,t=r.length;for(;t--;)e=(e<<5)-e^r.charCodeAt(t);return e>>>0}function ri(r,e){const t={stylesheet:Zs(e),rules:{}};return Er.set(r,t),t}function vr(r,e,t,n,u,s,i,a=0){const o=16.666/n;let c=`{
`;for(let p=0;p<=1;p+=o){const w=e+(t-e)*s(p);c+=p*100+`%{${i(w,1-w)}}
`}const f=c+`100% {${i(t,1-t)}}
}`,h=`__svelte_${ti(f)}_${a}`,l=Lu(r),{stylesheet:d,rules:D}=Er.get(l)||ri(l,r);D[h]||(D[h]=!0,d.insertRule(`@keyframes ${h} ${f}`,d.cssRules.length));const m=r.style.animation||"";return r.style.animation=`${m?`${m}, `:""}${h} ${n}ms linear ${u}ms 1 both`,Fr+=1,h}function Br(r,e){const t=(r.style.animation||"").split(", "),n=t.filter(e?s=>s.indexOf(e)<0:s=>s.indexOf("__svelte")===-1),u=t.length-n.length;u&&(r.style.animation=n.join(", "),Fr-=u,Fr||ni())}function ni(){gn(()=>{Fr||(Er.forEach(r=>{const{ownerNode:e}=r.stylesheet;e&&j(e)}),Er.clear())})}let er;function Xt(r){er=r}function qu(){if(!er)throw new Error("Function called outside component initialization");return er}function Wu(r){qu().$$.on_mount.push(r)}function Vu(){const r=qu();return(e,t,{cancelable:n=!1}={})=>{const u=r.$$.callbacks[e];if(u){const s=Hu(e,t,{cancelable:n});return u.slice().forEach(i=>{i.call(r,s)}),!s.defaultPrevented}return!0}}const Ft=[],on=[];let kt=[];const Mn=[],zu=Promise.resolve();let cn=!1;function Qu(){cn||(cn=!0,zu.then(Ku))}function ui(){return Qu(),zu}function Fe(r){kt.push(r)}const Qr=new Set;let yt=0;function Ku(){if(yt!==0)return;const r=er;do{try{for(;yt<Ft.length;){const e=Ft[yt];yt++,Xt(e),si(e.$$)}}catch(e){throw Ft.length=0,yt=0,e}for(Xt(null),Ft.length=0,yt=0;on.length;)on.pop()();for(let e=0;e<kt.length;e+=1){const t=kt[e];Qr.has(t)||(Qr.add(t),t())}kt.length=0}while(Ft.length);for(;Mn.length;)Mn.pop()();cn=!1,Qr.clear(),Xt(r)}function si(r){if(r.fragment!==null){r.update(),Re(r.before_update);const e=r.dirty;r.dirty=[-1],r.fragment&&r.fragment.p(r.ctx,e),r.after_update.forEach(Fe)}}function ii(r){const e=[],t=[];kt.forEach(n=>r.indexOf(n)===-1?e.push(n):t.push(n)),t.forEach(n=>n()),kt=e}let Lt;function wn(){return Lt||(Lt=Promise.resolve(),Lt.then(()=>{Lt=null})),Lt}function lt(r,e,t){r.dispatchEvent(Hu(`${e?"intro":"outro"}${t}`))}const Ar=new Set;let ke;function Sr(){ke={r:0,c:[],p:ke}}function xr(){ke.r||Re(ke.c),ke=ke.p}function re(r,e){r&&r.i&&(Ar.delete(r),r.i(e))}function ge(r,e,t,n){if(r&&r.o){if(Ar.has(r))return;Ar.add(r),ke.c.push(()=>{Ar.delete(r),n&&(t&&r.d(1),n())}),r.o(e)}else n&&n()}const yn={duration:0};function or(r,e,t){const n={direction:"in"};let u=e(r,t,n),s=!1,i,a,o=0;function c(){i&&Br(r,i)}function f(){const{delay:l=0,duration:d=300,easing:D=Rr,tick:m=W,css:p}=u||yn;p&&(i=vr(r,0,1,d,l,D,p,o++)),m(0,1);const w=mn()+l,B=w+d;a&&a.abort(),s=!0,Fe(()=>lt(r,!0,"start")),a=bn(k=>{if(s){if(k>=B)return m(1,0),lt(r,!0,"end"),c(),s=!1;if(k>=w){const v=D((k-w)/d);m(v,1-v)}}return s})}let h=!1;return{start(){h||(h=!0,Br(r),ar(u)?(u=u(n),wn().then(f)):f())},invalidate(){h=!1},end(){s&&(c(),s=!1)}}}function cr(r,e,t){const n={direction:"out"};let u=e(r,t,n),s=!0,i;const a=ke;a.r+=1;let o;function c(){const{delay:f=0,duration:h=300,easing:l=Rr,tick:d=W,css:D}=u||yn;D&&(i=vr(r,1,0,h,f,l,D));const m=mn()+f,p=m+h;Fe(()=>lt(r,!1,"start")),"inert"in r&&(o=r.inert,r.inert=!0),bn(w=>{if(s){if(w>=p)return d(0,1),lt(r,!1,"end"),--a.r||Re(a.c),!1;if(w>=m){const B=l((w-m)/h);d(1-B,B)}}return s})}return ar(u)?wn().then(()=>{u=u(n),c()}):c(),{end(f){f&&"inert"in r&&(r.inert=o),f&&u.tick&&u.tick(1,0),s&&(i&&Br(r,i),s=!1)}}}function jn(r,e,t,n){let s=e(r,t,{direction:"both"}),i=n?0:1,a=null,o=null,c=null,f;function h(){c&&Br(r,c)}function l(D,m){const p=D.b-i;return m*=Math.abs(p),{a:i,b:D.b,d:p,duration:m,start:D.start,end:D.start+m,group:D.group}}function d(D){const{delay:m=0,duration:p=300,easing:w=Rr,tick:B=W,css:k}=s||yn,v={start:mn()+m,b:D};D||(v.group=ke,ke.r+=1),"inert"in r&&(D?f!==void 0&&(r.inert=f):(f=r.inert,r.inert=!0)),a||o?o=v:(k&&(h(),c=vr(r,i,D,p,m,w,k)),D&&B(0,1),a=l(v,p),Fe(()=>lt(r,D,"start")),bn(H=>{if(o&&H>o.start&&(a=l(o,p),o=null,lt(r,a.b,"start"),k&&(h(),c=vr(r,i,a.b,a.duration,0,w,s.css))),a){if(H>=a.end)B(i=a.b,1-i),lt(r,a.b,"end"),o||(a.b?h():--a.group.r||Re(a.group.c)),a=null;else if(H>=a.start){const R=H-a.start;i=a.a+a.d*w(R/a.duration),B(i,1-i)}}return!!(a||o)}))}return{run(D){ar(s)?wn().then(()=>{s=s({direction:D?"in":"out"}),d(D)}):d(D)},end(){h(),a=o=null}}}function _r(r){return(r==null?void 0:r.length)!==void 0?r:Array.from(r)}function Pt(r){r&&r.c()}function ht(r,e,t){const{fragment:n,after_update:u}=r.$$;n&&n.m(e,t),Fe(()=>{const s=r.$$.on_mount.map(Ru).filter(ar);r.$$.on_destroy?r.$$.on_destroy.push(...s):Re(s),r.$$.on_mount=[]}),u.forEach(Fe)}function ft(r,e){const t=r.$$;t.fragment!==null&&(ii(t.after_update),Re(t.on_destroy),t.fragment&&t.fragment.d(e),t.on_destroy=t.fragment=null,t.ctx=[])}function ai(r,e){r.$$.dirty[0]===-1&&(Ft.push(r),Qu(),r.$$.dirty.fill(0)),r.$$.dirty[e/31|0]|=1<<e%31}function mt(r,e,t,n,u,s,i=null,a=[-1]){const o=er;Xt(r);const c=r.$$={fragment:null,ctx:[],props:s,update:W,not_equal:u,bound:Tn(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(o?o.$$.context:[])),callbacks:Tn(),dirty:a,skip_bound:!1,root:e.target||o.$$.root};i&&i(c.root);let f=!1;if(c.ctx=t?t(r,e.props||{},(h,l,...d)=>{const D=d.length?d[0]:l;return c.ctx&&u(c.ctx[h],c.ctx[h]=D)&&(!c.skip_bound&&c.bound[h]&&c.bound[h](D),f&&ai(r,h)),l}):[],c.update(),f=!0,Re(c.before_update),c.fragment=n?n(c.ctx):!1,e.target){if(e.hydrate){const h=ei(e.target);c.fragment&&c.fragment.l(h),h.forEach(j)}else c.fragment&&c.fragment.c();e.intro&&re(r.$$.fragment),ht(r,e.target,e.anchor),Ku()}Xt(o)}class gt{constructor(){zr(this,"$$");zr(this,"$$set")}$destroy(){ft(this,1),this.$destroy=W}$on(e,t){if(!ar(t))return W;const n=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return n.push(t),()=>{const u=n.indexOf(t);u!==-1&&n.splice(u,1)}}$set(e){this.$$set&&!Ys(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}const oi="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(oi);class De extends Error{constructor(e){super(e||""),this.name="EarthstarError"}}class b extends De{constructor(e){super(e||"Validation error"),this.name="ValidationError"}}class K extends De{constructor(e){super(e||"a Replica or ReplicaDriver was used after being closed"),this.name="ReplicaIsClosedError"}}class Je extends De{constructor(e){super(e||"a ReplicaCache was used after being closed"),this.name="ReplicaCacheIsClosedError"}}class Gt extends De{constructor(e){super(e||"Not supported"),this.name="NotSupportedError"}}function y(r){return r instanceof De}function Gu(r){return!(r instanceof De)}var fr=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function ci(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}function li(r){if(r.__esModule)return r;var e=r.default;if(typeof e=="function"){var t=function n(){return this instanceof n?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(r).forEach(function(n){var u=Object.getOwnPropertyDescriptor(r,n);Object.defineProperty(t,n,u.get?u:{enumerable:!0,get:function(){return r[n]}})}),t}var Yu={};const Xu={},hi=Object.freeze(Object.defineProperty({__proto__:null,default:Xu},Symbol.toStringTag,{value:"Module"})),fi=li(hi);var Zu={};Object.defineProperty(Zu,"__esModule",{value:!0});(function(r){var e=fr&&fr.__createBinding||(Object.create?function(s,i,a,o){o===void 0&&(o=a);var c=Object.getOwnPropertyDescriptor(i,a);(!c||("get"in c?!i.__esModule:c.writable||c.configurable))&&(c={enumerable:!0,get:function(){return i[a]}}),Object.defineProperty(s,o,c)}:function(s,i,a,o){o===void 0&&(o=a),s[o]=i[a]}),t=fr&&fr.__exportStar||function(s,i){for(var a in s)a!=="default"&&!Object.prototype.hasOwnProperty.call(i,a)&&e(i,s,a)};Object.defineProperty(r,"__esModule",{value:!0}),r.crypto=void 0;const u=fi.webcrypto;r.crypto=u,t(Zu,r)})(Yu);var tr={};Object.defineProperty(tr,"__esModule",{value:!0});var Mr=tr.setInterval=dt=tr.setTimeout=void 0;const di=globalThis.setTimeout;function Di(r,e,...t){const n=di(r,e,...t);return typeof n=="number"?n:n[Symbol.toPrimitive]()}var dt=tr.setTimeout=Di;const pi=globalThis.setInterval;function mi(r,e,...t){const n=pi(r,e,...t);return typeof n=="number"?n:n[Symbol.toPrimitive]()}Mr=tr.setInterval=mi;var An={},Kr,Nn;Object.defineProperty(An,"__esModule",{value:!0});var Ju=An.WeakRef=void 0;Ju=An.WeakRef=(Kr=globalThis.WeakRef)!==null&&Kr!==void 0?Kr:(Nn=class{constructor(e){}deref(){throw new Error("WeakRef is not supported in Node 14 and below.")}},Nn);const{Blob:es}=window,{Request:gi,Response:bi,Headers:wi,fetch:Mc}=window,{ReadableStream:Dt,ReadableStreamDefaultReader:jc,ReadableStreamBYOBReader:Nc,ReadableStreamBYOBRequest:Lc,ReadableByteStreamController:Uc,ReadableStreamDefaultController:$c,TransformStream:Rt,TransformStreamDefaultController:yi,WritableStream:Ce,WritableStreamDefaultWriter:Ai,WritableStreamDefaultController:Hc,ByteLengthQueuingStrategy:qc,CountQueuingStrategy:Wc,TextEncoderStream:Vc,TextDecoderStream:zc}=window;if(!Dt.prototype[Symbol.asyncIterator]){async function*r(){const e=this.getReader();try{for(;;){const{done:t,value:n}=await e.read();if(t)return;yield n}}finally{e.releaseLock()}}Dt.prototype[Symbol.asyncIterator]=r}var vt=null;typeof WebSocket<"u"?vt=WebSocket:typeof MozWebSocket<"u"?vt=MozWebSocket:typeof global<"u"?vt=global.WebSocket||global.MozWebSocket:typeof window<"u"?vt=window.WebSocket||window.MozWebSocket:typeof self<"u"&&(vt=self.WebSocket||self.MozWebSocket);const Tt=vt,{TextDecoder:ts,TextEncoder:Cn}=window;function Ln(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}function rs(r,e,t){return e&&Ln(r.prototype,e),t&&Ln(r,t),r}function Un(r,e){(e==null||e>r.length)&&(e=r.length);for(var t=0,n=new Array(e);t<e;t++)n[t]=r[t];return n}function kr(r,e){var t=typeof Symbol<"u"&&r[Symbol.iterator]||r["@@iterator"];if(t)return(t=t.call(r)).next.bind(t);if(Array.isArray(r)||(t=function(u,s){if(u){if(typeof u=="string")return Un(u,s);var i=Object.prototype.toString.call(u).slice(8,-1);return i==="Object"&&u.constructor&&(i=u.constructor.name),i==="Map"||i==="Set"?Array.from(u):i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?Un(u,s):void 0}}(r))||e&&r&&typeof r.length=="number"){t&&(r=t);var n=0;return function(){return n>=r.length?{done:!0}:{done:!1,value:r[n++]}}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var Ci=/(?:[\$A-Z_a-z\xAA\xB5\xBA\xC0-\xD6\xD8-\xF6\xF8-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0370-\u0374\u0376\u0377\u037A-\u037D\u037F\u0386\u0388-\u038A\u038C\u038E-\u03A1\u03A3-\u03F5\u03F7-\u0481\u048A-\u052F\u0531-\u0556\u0559\u0560-\u0588\u05D0-\u05EA\u05EF-\u05F2\u0620-\u064A\u066E\u066F\u0671-\u06D3\u06D5\u06E5\u06E6\u06EE\u06EF\u06FA-\u06FC\u06FF\u0710\u0712-\u072F\u074D-\u07A5\u07B1\u07CA-\u07EA\u07F4\u07F5\u07FA\u0800-\u0815\u081A\u0824\u0828\u0840-\u0858\u0860-\u086A\u08A0-\u08B4\u08B6-\u08C7\u0904-\u0939\u093D\u0950\u0958-\u0961\u0971-\u0980\u0985-\u098C\u098F\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BD\u09CE\u09DC\u09DD\u09DF-\u09E1\u09F0\u09F1\u09FC\u0A05-\u0A0A\u0A0F\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32\u0A33\u0A35\u0A36\u0A38\u0A39\u0A59-\u0A5C\u0A5E\u0A72-\u0A74\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2\u0AB3\u0AB5-\u0AB9\u0ABD\u0AD0\u0AE0\u0AE1\u0AF9\u0B05-\u0B0C\u0B0F\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32\u0B33\u0B35-\u0B39\u0B3D\u0B5C\u0B5D\u0B5F-\u0B61\u0B71\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99\u0B9A\u0B9C\u0B9E\u0B9F\u0BA3\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BD0\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C39\u0C3D\u0C58-\u0C5A\u0C60\u0C61\u0C80\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBD\u0CDE\u0CE0\u0CE1\u0CF1\u0CF2\u0D04-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3A\u0D3D\u0D4E\u0D54-\u0D56\u0D5F-\u0D61\u0D7A-\u0D7F\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0E01-\u0E30\u0E32\u0E33\u0E40-\u0E46\u0E81\u0E82\u0E84\u0E86-\u0E8A\u0E8C-\u0EA3\u0EA5\u0EA7-\u0EB0\u0EB2\u0EB3\u0EBD\u0EC0-\u0EC4\u0EC6\u0EDC-\u0EDF\u0F00\u0F40-\u0F47\u0F49-\u0F6C\u0F88-\u0F8C\u1000-\u102A\u103F\u1050-\u1055\u105A-\u105D\u1061\u1065\u1066\u106E-\u1070\u1075-\u1081\u108E\u10A0-\u10C5\u10C7\u10CD\u10D0-\u10FA\u10FC-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u1380-\u138F\u13A0-\u13F5\u13F8-\u13FD\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u16EE-\u16F8\u1700-\u170C\u170E-\u1711\u1720-\u1731\u1740-\u1751\u1760-\u176C\u176E-\u1770\u1780-\u17B3\u17D7\u17DC\u1820-\u1878\u1880-\u18A8\u18AA\u18B0-\u18F5\u1900-\u191E\u1950-\u196D\u1970-\u1974\u1980-\u19AB\u19B0-\u19C9\u1A00-\u1A16\u1A20-\u1A54\u1AA7\u1B05-\u1B33\u1B45-\u1B4B\u1B83-\u1BA0\u1BAE\u1BAF\u1BBA-\u1BE5\u1C00-\u1C23\u1C4D-\u1C4F\u1C5A-\u1C7D\u1C80-\u1C88\u1C90-\u1CBA\u1CBD-\u1CBF\u1CE9-\u1CEC\u1CEE-\u1CF3\u1CF5\u1CF6\u1CFA\u1D00-\u1DBF\u1E00-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FBC\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FCC\u1FD0-\u1FD3\u1FD6-\u1FDB\u1FE0-\u1FEC\u1FF2-\u1FF4\u1FF6-\u1FFC\u2071\u207F\u2090-\u209C\u2102\u2107\u210A-\u2113\u2115\u2118-\u211D\u2124\u2126\u2128\u212A-\u2139\u213C-\u213F\u2145-\u2149\u214E\u2160-\u2188\u2C00-\u2C2E\u2C30-\u2C5E\u2C60-\u2CE4\u2CEB-\u2CEE\u2CF2\u2CF3\u2D00-\u2D25\u2D27\u2D2D\u2D30-\u2D67\u2D6F\u2D80-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u3005-\u3007\u3021-\u3029\u3031-\u3035\u3038-\u303C\u3041-\u3096\u309B-\u309F\u30A1-\u30FA\u30FC-\u30FF\u3105-\u312F\u3131-\u318E\u31A0-\u31BF\u31F0-\u31FF\u3400-\u4DBF\u4E00-\u9FFC\uA000-\uA48C\uA4D0-\uA4FD\uA500-\uA60C\uA610-\uA61F\uA62A\uA62B\uA640-\uA66E\uA67F-\uA69D\uA6A0-\uA6EF\uA717-\uA71F\uA722-\uA788\uA78B-\uA7BF\uA7C2-\uA7CA\uA7F5-\uA801\uA803-\uA805\uA807-\uA80A\uA80C-\uA822\uA840-\uA873\uA882-\uA8B3\uA8F2-\uA8F7\uA8FB\uA8FD\uA8FE\uA90A-\uA925\uA930-\uA946\uA960-\uA97C\uA984-\uA9B2\uA9CF\uA9E0-\uA9E4\uA9E6-\uA9EF\uA9FA-\uA9FE\uAA00-\uAA28\uAA40-\uAA42\uAA44-\uAA4B\uAA60-\uAA76\uAA7A\uAA7E-\uAAAF\uAAB1\uAAB5\uAAB6\uAAB9-\uAABD\uAAC0\uAAC2\uAADB-\uAADD\uAAE0-\uAAEA\uAAF2-\uAAF4\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uAB30-\uAB5A\uAB5C-\uAB69\uAB70-\uABE2\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB00-\uFB06\uFB13-\uFB17\uFB1D\uFB1F-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40\uFB41\uFB43\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE70-\uFE74\uFE76-\uFEFC\uFF21-\uFF3A\uFF41-\uFF5A\uFF66-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC]|\uD800[\uDC00-\uDC0B\uDC0D-\uDC26\uDC28-\uDC3A\uDC3C\uDC3D\uDC3F-\uDC4D\uDC50-\uDC5D\uDC80-\uDCFA\uDD40-\uDD74\uDE80-\uDE9C\uDEA0-\uDED0\uDF00-\uDF1F\uDF2D-\uDF4A\uDF50-\uDF75\uDF80-\uDF9D\uDFA0-\uDFC3\uDFC8-\uDFCF\uDFD1-\uDFD5]|\uD801[\uDC00-\uDC9D\uDCB0-\uDCD3\uDCD8-\uDCFB\uDD00-\uDD27\uDD30-\uDD63\uDE00-\uDF36\uDF40-\uDF55\uDF60-\uDF67]|\uD802[\uDC00-\uDC05\uDC08\uDC0A-\uDC35\uDC37\uDC38\uDC3C\uDC3F-\uDC55\uDC60-\uDC76\uDC80-\uDC9E\uDCE0-\uDCF2\uDCF4\uDCF5\uDD00-\uDD15\uDD20-\uDD39\uDD80-\uDDB7\uDDBE\uDDBF\uDE00\uDE10-\uDE13\uDE15-\uDE17\uDE19-\uDE35\uDE60-\uDE7C\uDE80-\uDE9C\uDEC0-\uDEC7\uDEC9-\uDEE4\uDF00-\uDF35\uDF40-\uDF55\uDF60-\uDF72\uDF80-\uDF91]|\uD803[\uDC00-\uDC48\uDC80-\uDCB2\uDCC0-\uDCF2\uDD00-\uDD23\uDE80-\uDEA9\uDEB0\uDEB1\uDF00-\uDF1C\uDF27\uDF30-\uDF45\uDFB0-\uDFC4\uDFE0-\uDFF6]|\uD804[\uDC03-\uDC37\uDC83-\uDCAF\uDCD0-\uDCE8\uDD03-\uDD26\uDD44\uDD47\uDD50-\uDD72\uDD76\uDD83-\uDDB2\uDDC1-\uDDC4\uDDDA\uDDDC\uDE00-\uDE11\uDE13-\uDE2B\uDE80-\uDE86\uDE88\uDE8A-\uDE8D\uDE8F-\uDE9D\uDE9F-\uDEA8\uDEB0-\uDEDE\uDF05-\uDF0C\uDF0F\uDF10\uDF13-\uDF28\uDF2A-\uDF30\uDF32\uDF33\uDF35-\uDF39\uDF3D\uDF50\uDF5D-\uDF61]|\uD805[\uDC00-\uDC34\uDC47-\uDC4A\uDC5F-\uDC61\uDC80-\uDCAF\uDCC4\uDCC5\uDCC7\uDD80-\uDDAE\uDDD8-\uDDDB\uDE00-\uDE2F\uDE44\uDE80-\uDEAA\uDEB8\uDF00-\uDF1A]|\uD806[\uDC00-\uDC2B\uDCA0-\uDCDF\uDCFF-\uDD06\uDD09\uDD0C-\uDD13\uDD15\uDD16\uDD18-\uDD2F\uDD3F\uDD41\uDDA0-\uDDA7\uDDAA-\uDDD0\uDDE1\uDDE3\uDE00\uDE0B-\uDE32\uDE3A\uDE50\uDE5C-\uDE89\uDE9D\uDEC0-\uDEF8]|\uD807[\uDC00-\uDC08\uDC0A-\uDC2E\uDC40\uDC72-\uDC8F\uDD00-\uDD06\uDD08\uDD09\uDD0B-\uDD30\uDD46\uDD60-\uDD65\uDD67\uDD68\uDD6A-\uDD89\uDD98\uDEE0-\uDEF2\uDFB0]|\uD808[\uDC00-\uDF99]|\uD809[\uDC00-\uDC6E\uDC80-\uDD43]|[\uD80C\uD81C-\uD820\uD822\uD840-\uD868\uD86A-\uD86C\uD86F-\uD872\uD874-\uD879\uD880-\uD883][\uDC00-\uDFFF]|\uD80D[\uDC00-\uDC2E]|\uD811[\uDC00-\uDE46]|\uD81A[\uDC00-\uDE38\uDE40-\uDE5E\uDED0-\uDEED\uDF00-\uDF2F\uDF40-\uDF43\uDF63-\uDF77\uDF7D-\uDF8F]|\uD81B[\uDE40-\uDE7F\uDF00-\uDF4A\uDF50\uDF93-\uDF9F\uDFE0\uDFE1\uDFE3]|\uD821[\uDC00-\uDFF7]|\uD823[\uDC00-\uDCD5\uDD00-\uDD08]|\uD82C[\uDC00-\uDD1E\uDD50-\uDD52\uDD64-\uDD67\uDD70-\uDEFB]|\uD82F[\uDC00-\uDC6A\uDC70-\uDC7C\uDC80-\uDC88\uDC90-\uDC99]|\uD835[\uDC00-\uDC54\uDC56-\uDC9C\uDC9E\uDC9F\uDCA2\uDCA5\uDCA6\uDCA9-\uDCAC\uDCAE-\uDCB9\uDCBB\uDCBD-\uDCC3\uDCC5-\uDD05\uDD07-\uDD0A\uDD0D-\uDD14\uDD16-\uDD1C\uDD1E-\uDD39\uDD3B-\uDD3E\uDD40-\uDD44\uDD46\uDD4A-\uDD50\uDD52-\uDEA5\uDEA8-\uDEC0\uDEC2-\uDEDA\uDEDC-\uDEFA\uDEFC-\uDF14\uDF16-\uDF34\uDF36-\uDF4E\uDF50-\uDF6E\uDF70-\uDF88\uDF8A-\uDFA8\uDFAA-\uDFC2\uDFC4-\uDFCB]|\uD838[\uDD00-\uDD2C\uDD37-\uDD3D\uDD4E\uDEC0-\uDEEB]|\uD83A[\uDC00-\uDCC4\uDD00-\uDD43\uDD4B]|\uD83B[\uDE00-\uDE03\uDE05-\uDE1F\uDE21\uDE22\uDE24\uDE27\uDE29-\uDE32\uDE34-\uDE37\uDE39\uDE3B\uDE42\uDE47\uDE49\uDE4B\uDE4D-\uDE4F\uDE51\uDE52\uDE54\uDE57\uDE59\uDE5B\uDE5D\uDE5F\uDE61\uDE62\uDE64\uDE67-\uDE6A\uDE6C-\uDE72\uDE74-\uDE77\uDE79-\uDE7C\uDE7E\uDE80-\uDE89\uDE8B-\uDE9B\uDEA1-\uDEA3\uDEA5-\uDEA9\uDEAB-\uDEBB]|\uD869[\uDC00-\uDEDD\uDF00-\uDFFF]|\uD86D[\uDC00-\uDF34\uDF40-\uDFFF]|\uD86E[\uDC00-\uDC1D\uDC20-\uDFFF]|\uD873[\uDC00-\uDEA1\uDEB0-\uDFFF]|\uD87A[\uDC00-\uDFE0]|\uD87E[\uDC00-\uDE1D]|\uD884[\uDC00-\uDF4A])/,Ei=/(?:[\$0-9A-Z_a-z\xAA\xB5\xB7\xBA\xC0-\xD6\xD8-\xF6\xF8-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0300-\u0374\u0376\u0377\u037A-\u037D\u037F\u0386-\u038A\u038C\u038E-\u03A1\u03A3-\u03F5\u03F7-\u0481\u0483-\u0487\u048A-\u052F\u0531-\u0556\u0559\u0560-\u0588\u0591-\u05BD\u05BF\u05C1\u05C2\u05C4\u05C5\u05C7\u05D0-\u05EA\u05EF-\u05F2\u0610-\u061A\u0620-\u0669\u066E-\u06D3\u06D5-\u06DC\u06DF-\u06E8\u06EA-\u06FC\u06FF\u0710-\u074A\u074D-\u07B1\u07C0-\u07F5\u07FA\u07FD\u0800-\u082D\u0840-\u085B\u0860-\u086A\u08A0-\u08B4\u08B6-\u08C7\u08D3-\u08E1\u08E3-\u0963\u0966-\u096F\u0971-\u0983\u0985-\u098C\u098F\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BC-\u09C4\u09C7\u09C8\u09CB-\u09CE\u09D7\u09DC\u09DD\u09DF-\u09E3\u09E6-\u09F1\u09FC\u09FE\u0A01-\u0A03\u0A05-\u0A0A\u0A0F\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32\u0A33\u0A35\u0A36\u0A38\u0A39\u0A3C\u0A3E-\u0A42\u0A47\u0A48\u0A4B-\u0A4D\u0A51\u0A59-\u0A5C\u0A5E\u0A66-\u0A75\u0A81-\u0A83\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2\u0AB3\u0AB5-\u0AB9\u0ABC-\u0AC5\u0AC7-\u0AC9\u0ACB-\u0ACD\u0AD0\u0AE0-\u0AE3\u0AE6-\u0AEF\u0AF9-\u0AFF\u0B01-\u0B03\u0B05-\u0B0C\u0B0F\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32\u0B33\u0B35-\u0B39\u0B3C-\u0B44\u0B47\u0B48\u0B4B-\u0B4D\u0B55-\u0B57\u0B5C\u0B5D\u0B5F-\u0B63\u0B66-\u0B6F\u0B71\u0B82\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99\u0B9A\u0B9C\u0B9E\u0B9F\u0BA3\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BBE-\u0BC2\u0BC6-\u0BC8\u0BCA-\u0BCD\u0BD0\u0BD7\u0BE6-\u0BEF\u0C00-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C39\u0C3D-\u0C44\u0C46-\u0C48\u0C4A-\u0C4D\u0C55\u0C56\u0C58-\u0C5A\u0C60-\u0C63\u0C66-\u0C6F\u0C80-\u0C83\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBC-\u0CC4\u0CC6-\u0CC8\u0CCA-\u0CCD\u0CD5\u0CD6\u0CDE\u0CE0-\u0CE3\u0CE6-\u0CEF\u0CF1\u0CF2\u0D00-\u0D0C\u0D0E-\u0D10\u0D12-\u0D44\u0D46-\u0D48\u0D4A-\u0D4E\u0D54-\u0D57\u0D5F-\u0D63\u0D66-\u0D6F\u0D7A-\u0D7F\u0D81-\u0D83\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0DCA\u0DCF-\u0DD4\u0DD6\u0DD8-\u0DDF\u0DE6-\u0DEF\u0DF2\u0DF3\u0E01-\u0E3A\u0E40-\u0E4E\u0E50-\u0E59\u0E81\u0E82\u0E84\u0E86-\u0E8A\u0E8C-\u0EA3\u0EA5\u0EA7-\u0EBD\u0EC0-\u0EC4\u0EC6\u0EC8-\u0ECD\u0ED0-\u0ED9\u0EDC-\u0EDF\u0F00\u0F18\u0F19\u0F20-\u0F29\u0F35\u0F37\u0F39\u0F3E-\u0F47\u0F49-\u0F6C\u0F71-\u0F84\u0F86-\u0F97\u0F99-\u0FBC\u0FC6\u1000-\u1049\u1050-\u109D\u10A0-\u10C5\u10C7\u10CD\u10D0-\u10FA\u10FC-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u135D-\u135F\u1369-\u1371\u1380-\u138F\u13A0-\u13F5\u13F8-\u13FD\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u16EE-\u16F8\u1700-\u170C\u170E-\u1714\u1720-\u1734\u1740-\u1753\u1760-\u176C\u176E-\u1770\u1772\u1773\u1780-\u17D3\u17D7\u17DC\u17DD\u17E0-\u17E9\u180B-\u180D\u1810-\u1819\u1820-\u1878\u1880-\u18AA\u18B0-\u18F5\u1900-\u191E\u1920-\u192B\u1930-\u193B\u1946-\u196D\u1970-\u1974\u1980-\u19AB\u19B0-\u19C9\u19D0-\u19DA\u1A00-\u1A1B\u1A20-\u1A5E\u1A60-\u1A7C\u1A7F-\u1A89\u1A90-\u1A99\u1AA7\u1AB0-\u1ABD\u1ABF\u1AC0\u1B00-\u1B4B\u1B50-\u1B59\u1B6B-\u1B73\u1B80-\u1BF3\u1C00-\u1C37\u1C40-\u1C49\u1C4D-\u1C7D\u1C80-\u1C88\u1C90-\u1CBA\u1CBD-\u1CBF\u1CD0-\u1CD2\u1CD4-\u1CFA\u1D00-\u1DF9\u1DFB-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FBC\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FCC\u1FD0-\u1FD3\u1FD6-\u1FDB\u1FE0-\u1FEC\u1FF2-\u1FF4\u1FF6-\u1FFC\u200C\u200D\u203F\u2040\u2054\u2071\u207F\u2090-\u209C\u20D0-\u20DC\u20E1\u20E5-\u20F0\u2102\u2107\u210A-\u2113\u2115\u2118-\u211D\u2124\u2126\u2128\u212A-\u2139\u213C-\u213F\u2145-\u2149\u214E\u2160-\u2188\u2C00-\u2C2E\u2C30-\u2C5E\u2C60-\u2CE4\u2CEB-\u2CF3\u2D00-\u2D25\u2D27\u2D2D\u2D30-\u2D67\u2D6F\u2D7F-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u2DE0-\u2DFF\u3005-\u3007\u3021-\u302F\u3031-\u3035\u3038-\u303C\u3041-\u3096\u3099-\u309F\u30A1-\u30FA\u30FC-\u30FF\u3105-\u312F\u3131-\u318E\u31A0-\u31BF\u31F0-\u31FF\u3400-\u4DBF\u4E00-\u9FFC\uA000-\uA48C\uA4D0-\uA4FD\uA500-\uA60C\uA610-\uA62B\uA640-\uA66F\uA674-\uA67D\uA67F-\uA6F1\uA717-\uA71F\uA722-\uA788\uA78B-\uA7BF\uA7C2-\uA7CA\uA7F5-\uA827\uA82C\uA840-\uA873\uA880-\uA8C5\uA8D0-\uA8D9\uA8E0-\uA8F7\uA8FB\uA8FD-\uA92D\uA930-\uA953\uA960-\uA97C\uA980-\uA9C0\uA9CF-\uA9D9\uA9E0-\uA9FE\uAA00-\uAA36\uAA40-\uAA4D\uAA50-\uAA59\uAA60-\uAA76\uAA7A-\uAAC2\uAADB-\uAADD\uAAE0-\uAAEF\uAAF2-\uAAF6\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uAB30-\uAB5A\uAB5C-\uAB69\uAB70-\uABEA\uABEC\uABED\uABF0-\uABF9\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB00-\uFB06\uFB13-\uFB17\uFB1D-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40\uFB41\uFB43\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE00-\uFE0F\uFE20-\uFE2F\uFE33\uFE34\uFE4D-\uFE4F\uFE70-\uFE74\uFE76-\uFEFC\uFF10-\uFF19\uFF21-\uFF3A\uFF3F\uFF41-\uFF5A\uFF66-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC]|\uD800[\uDC00-\uDC0B\uDC0D-\uDC26\uDC28-\uDC3A\uDC3C\uDC3D\uDC3F-\uDC4D\uDC50-\uDC5D\uDC80-\uDCFA\uDD40-\uDD74\uDDFD\uDE80-\uDE9C\uDEA0-\uDED0\uDEE0\uDF00-\uDF1F\uDF2D-\uDF4A\uDF50-\uDF7A\uDF80-\uDF9D\uDFA0-\uDFC3\uDFC8-\uDFCF\uDFD1-\uDFD5]|\uD801[\uDC00-\uDC9D\uDCA0-\uDCA9\uDCB0-\uDCD3\uDCD8-\uDCFB\uDD00-\uDD27\uDD30-\uDD63\uDE00-\uDF36\uDF40-\uDF55\uDF60-\uDF67]|\uD802[\uDC00-\uDC05\uDC08\uDC0A-\uDC35\uDC37\uDC38\uDC3C\uDC3F-\uDC55\uDC60-\uDC76\uDC80-\uDC9E\uDCE0-\uDCF2\uDCF4\uDCF5\uDD00-\uDD15\uDD20-\uDD39\uDD80-\uDDB7\uDDBE\uDDBF\uDE00-\uDE03\uDE05\uDE06\uDE0C-\uDE13\uDE15-\uDE17\uDE19-\uDE35\uDE38-\uDE3A\uDE3F\uDE60-\uDE7C\uDE80-\uDE9C\uDEC0-\uDEC7\uDEC9-\uDEE6\uDF00-\uDF35\uDF40-\uDF55\uDF60-\uDF72\uDF80-\uDF91]|\uD803[\uDC00-\uDC48\uDC80-\uDCB2\uDCC0-\uDCF2\uDD00-\uDD27\uDD30-\uDD39\uDE80-\uDEA9\uDEAB\uDEAC\uDEB0\uDEB1\uDF00-\uDF1C\uDF27\uDF30-\uDF50\uDFB0-\uDFC4\uDFE0-\uDFF6]|\uD804[\uDC00-\uDC46\uDC66-\uDC6F\uDC7F-\uDCBA\uDCD0-\uDCE8\uDCF0-\uDCF9\uDD00-\uDD34\uDD36-\uDD3F\uDD44-\uDD47\uDD50-\uDD73\uDD76\uDD80-\uDDC4\uDDC9-\uDDCC\uDDCE-\uDDDA\uDDDC\uDE00-\uDE11\uDE13-\uDE37\uDE3E\uDE80-\uDE86\uDE88\uDE8A-\uDE8D\uDE8F-\uDE9D\uDE9F-\uDEA8\uDEB0-\uDEEA\uDEF0-\uDEF9\uDF00-\uDF03\uDF05-\uDF0C\uDF0F\uDF10\uDF13-\uDF28\uDF2A-\uDF30\uDF32\uDF33\uDF35-\uDF39\uDF3B-\uDF44\uDF47\uDF48\uDF4B-\uDF4D\uDF50\uDF57\uDF5D-\uDF63\uDF66-\uDF6C\uDF70-\uDF74]|\uD805[\uDC00-\uDC4A\uDC50-\uDC59\uDC5E-\uDC61\uDC80-\uDCC5\uDCC7\uDCD0-\uDCD9\uDD80-\uDDB5\uDDB8-\uDDC0\uDDD8-\uDDDD\uDE00-\uDE40\uDE44\uDE50-\uDE59\uDE80-\uDEB8\uDEC0-\uDEC9\uDF00-\uDF1A\uDF1D-\uDF2B\uDF30-\uDF39]|\uD806[\uDC00-\uDC3A\uDCA0-\uDCE9\uDCFF-\uDD06\uDD09\uDD0C-\uDD13\uDD15\uDD16\uDD18-\uDD35\uDD37\uDD38\uDD3B-\uDD43\uDD50-\uDD59\uDDA0-\uDDA7\uDDAA-\uDDD7\uDDDA-\uDDE1\uDDE3\uDDE4\uDE00-\uDE3E\uDE47\uDE50-\uDE99\uDE9D\uDEC0-\uDEF8]|\uD807[\uDC00-\uDC08\uDC0A-\uDC36\uDC38-\uDC40\uDC50-\uDC59\uDC72-\uDC8F\uDC92-\uDCA7\uDCA9-\uDCB6\uDD00-\uDD06\uDD08\uDD09\uDD0B-\uDD36\uDD3A\uDD3C\uDD3D\uDD3F-\uDD47\uDD50-\uDD59\uDD60-\uDD65\uDD67\uDD68\uDD6A-\uDD8E\uDD90\uDD91\uDD93-\uDD98\uDDA0-\uDDA9\uDEE0-\uDEF6\uDFB0]|\uD808[\uDC00-\uDF99]|\uD809[\uDC00-\uDC6E\uDC80-\uDD43]|[\uD80C\uD81C-\uD820\uD822\uD840-\uD868\uD86A-\uD86C\uD86F-\uD872\uD874-\uD879\uD880-\uD883][\uDC00-\uDFFF]|\uD80D[\uDC00-\uDC2E]|\uD811[\uDC00-\uDE46]|\uD81A[\uDC00-\uDE38\uDE40-\uDE5E\uDE60-\uDE69\uDED0-\uDEED\uDEF0-\uDEF4\uDF00-\uDF36\uDF40-\uDF43\uDF50-\uDF59\uDF63-\uDF77\uDF7D-\uDF8F]|\uD81B[\uDE40-\uDE7F\uDF00-\uDF4A\uDF4F-\uDF87\uDF8F-\uDF9F\uDFE0\uDFE1\uDFE3\uDFE4\uDFF0\uDFF1]|\uD821[\uDC00-\uDFF7]|\uD823[\uDC00-\uDCD5\uDD00-\uDD08]|\uD82C[\uDC00-\uDD1E\uDD50-\uDD52\uDD64-\uDD67\uDD70-\uDEFB]|\uD82F[\uDC00-\uDC6A\uDC70-\uDC7C\uDC80-\uDC88\uDC90-\uDC99\uDC9D\uDC9E]|\uD834[\uDD65-\uDD69\uDD6D-\uDD72\uDD7B-\uDD82\uDD85-\uDD8B\uDDAA-\uDDAD\uDE42-\uDE44]|\uD835[\uDC00-\uDC54\uDC56-\uDC9C\uDC9E\uDC9F\uDCA2\uDCA5\uDCA6\uDCA9-\uDCAC\uDCAE-\uDCB9\uDCBB\uDCBD-\uDCC3\uDCC5-\uDD05\uDD07-\uDD0A\uDD0D-\uDD14\uDD16-\uDD1C\uDD1E-\uDD39\uDD3B-\uDD3E\uDD40-\uDD44\uDD46\uDD4A-\uDD50\uDD52-\uDEA5\uDEA8-\uDEC0\uDEC2-\uDEDA\uDEDC-\uDEFA\uDEFC-\uDF14\uDF16-\uDF34\uDF36-\uDF4E\uDF50-\uDF6E\uDF70-\uDF88\uDF8A-\uDFA8\uDFAA-\uDFC2\uDFC4-\uDFCB\uDFCE-\uDFFF]|\uD836[\uDE00-\uDE36\uDE3B-\uDE6C\uDE75\uDE84\uDE9B-\uDE9F\uDEA1-\uDEAF]|\uD838[\uDC00-\uDC06\uDC08-\uDC18\uDC1B-\uDC21\uDC23\uDC24\uDC26-\uDC2A\uDD00-\uDD2C\uDD30-\uDD3D\uDD40-\uDD49\uDD4E\uDEC0-\uDEF9]|\uD83A[\uDC00-\uDCC4\uDCD0-\uDCD6\uDD00-\uDD4B\uDD50-\uDD59]|\uD83B[\uDE00-\uDE03\uDE05-\uDE1F\uDE21\uDE22\uDE24\uDE27\uDE29-\uDE32\uDE34-\uDE37\uDE39\uDE3B\uDE42\uDE47\uDE49\uDE4B\uDE4D-\uDE4F\uDE51\uDE52\uDE54\uDE57\uDE59\uDE5B\uDE5D\uDE5F\uDE61\uDE62\uDE64\uDE67-\uDE6A\uDE6C-\uDE72\uDE74-\uDE77\uDE79-\uDE7C\uDE7E\uDE80-\uDE89\uDE8B-\uDE9B\uDEA1-\uDEA3\uDEA5-\uDEA9\uDEAB-\uDEBB]|\uD83E[\uDFF0-\uDFF9]|\uD869[\uDC00-\uDEDD\uDF00-\uDFFF]|\uD86D[\uDC00-\uDF34\uDF40-\uDFFF]|\uD86E[\uDC00-\uDC1D\uDC20-\uDFFF]|\uD873[\uDC00-\uDEA1\uDEB0-\uDFFF]|\uD87A[\uDC00-\uDFE0]|\uD87E[\uDC00-\uDE1D]|\uD884[\uDC00-\uDF4A]|\uDB40[\uDD00-\uDDEF])/;function Fi(r,e){return(e?/^[\x00-\xFF]*$/:/^[\x00-\x7F]*$/).test(r)}function ns(r,e){e===void 0&&(e=!1);for(var t=[],n=0;n<r.length;){var u=r[n],s=function(d){if(!e)throw new TypeError(d);t.push({type:"INVALID_CHAR",index:n,value:r[n++]})};if(u!=="*")if(u!=="+"&&u!=="?")if(u!=="\\")if(u!=="{")if(u!=="}")if(u!==":")if(u!=="(")t.push({type:"CHAR",index:n,value:r[n++]});else{var i=1,a="",o=n+1,c=!1;if(r[o]==="?"){s('Pattern cannot start with "?" at '+o);continue}for(;o<r.length;){if(!Fi(r[o],!1)){s("Invalid character '"+r[o]+"' at "+o+"."),c=!0;break}if(r[o]!=="\\"){if(r[o]===")"){if(--i==0){o++;break}}else if(r[o]==="("&&(i++,r[o+1]!=="?")){s("Capturing groups are not allowed at "+o),c=!0;break}a+=r[o++]}else a+=r[o++]+r[o++]}if(c)continue;if(i){s("Unbalanced pattern at "+n);continue}if(!a){s("Missing pattern at "+n);continue}t.push({type:"PATTERN",index:n,value:a}),n=o}else{for(var f="",h=n+1;h<r.length;){var l=r.substr(h,1);if(!(h===n+1&&Ci.test(l)||h!==n+1&&Ei.test(l)))break;f+=r[h++]}if(!f){s("Missing parameter name at "+n);continue}t.push({type:"NAME",index:n,value:f}),n=h}else t.push({type:"CLOSE",index:n,value:r[n++]});else t.push({type:"OPEN",index:n,value:r[n++]});else t.push({type:"ESCAPED_CHAR",index:n++,value:r[n++]});else t.push({type:"MODIFIER",index:n,value:r[n++]});else t.push({type:"ASTERISK",index:n,value:r[n++]})}return t.push({type:"END",index:n,value:""}),t}function us(r,e){e===void 0&&(e={});for(var t=ns(r),n=e.prefixes,u=n===void 0?"./":n,s="[^"+Bt(e.delimiter||"/#?")+"]+?",i=[],a=0,o=0,c="",f=new Set,h=function(q){if(o<t.length&&t[o].type===q)return t[o++].value},l=function(){return h("MODIFIER")||h("ASTERISK")},d=function(q){var S=h(q);if(S!==void 0)return S;var L=t[o];throw new TypeError("Unexpected "+L.type+" at "+L.index+", expected "+q)},D=function(){for(var q,S="";q=h("CHAR")||h("ESCAPED_CHAR");)S+=q;return S},m=e.encodePart||function(q){return q};o<t.length;){var p=h("CHAR"),w=h("NAME"),B=h("PATTERN");if(w||B||!h("ASTERISK")||(B=".*"),w||B){var k=p||"";u.indexOf(k)===-1&&(c+=k,k=""),c&&(i.push(m(c)),c="");var v=w||a++;if(f.has(v))throw new TypeError("Duplicate name '"+v+"'.");f.add(v),i.push({name:v,prefix:m(k),suffix:"",pattern:B||s,modifier:l()||""})}else{var H=p||h("ESCAPED_CHAR");if(H)c+=H;else if(h("OPEN")){var R=D(),I=h("NAME")||"",E=h("PATTERN")||"";I||E||!h("ASTERISK")||(E=".*");var O=D();d("CLOSE");var Q=l()||"";if(!I&&!E&&!Q){c+=R;continue}if(!I&&!E&&!R)continue;c&&(i.push(m(c)),c=""),i.push({name:I||(E?a++:""),pattern:I&&!E?s:E,prefix:m(R),suffix:m(O),modifier:Q})}else c&&(i.push(m(c)),c=""),d("END")}}return i}function Bt(r){return r.replace(/([.+*?^${}()[\]|/\\])/g,"\\$1")}function ss(r){return r&&r.sensitive?"u":"ui"}function is(r,e,t){t===void 0&&(t={});for(var n,u=t.strict,s=u!==void 0&&u,i=t.start,a=i===void 0||i,o=t.end,c=o===void 0||o,f=t.encode,h=f===void 0?function(H){return H}:f,l="["+Bt(t.endsWith||"")+"]|$",d="["+Bt(t.delimiter||"/#?")+"]",D=a?"^":"",m=kr(r);!(n=m()).done;){var p=n.value;if(typeof p=="string")D+=Bt(h(p));else{var w=Bt(h(p.prefix)),B=Bt(h(p.suffix));p.pattern?(e&&e.push(p),D+=w||B?p.modifier==="+"||p.modifier==="*"?"(?:"+w+"((?:"+p.pattern+")(?:"+B+w+"(?:"+p.pattern+"))*)"+B+")"+(p.modifier==="*"?"?":""):"(?:"+w+"("+p.pattern+")"+B+")"+p.modifier:p.modifier==="+"||p.modifier==="*"?"((?:"+p.pattern+")"+p.modifier+")":"("+p.pattern+")"+p.modifier):D+="(?:"+w+B+")"+p.modifier}}if(c)s||(D+=d+"?"),D+=t.endsWith?"(?="+l+")":"$";else{var k=r[r.length-1],v=typeof k=="string"?d.indexOf(k[k.length-1])>-1:k===void 0;s||(D+="(?:"+d+"(?="+l+"))?"),v||(D+="(?="+d+"|"+l+")")}return new RegExp(D,ss(t))}function as(r,e,t){return r instanceof RegExp?function(n,u){if(!u)return n;for(var s=/\((?:\?<(.*?)>)?(?!\?)/g,i=0,a=s.exec(n.source);a;)u.push({name:a[1]||i++,prefix:"",suffix:"",modifier:"",pattern:""}),a=s.exec(n.source);return n}(r,e):Array.isArray(r)?function(n,u,s){var i=n.map(function(a){return as(a,u,s).source});return new RegExp("(?:"+i.join("|")+")",ss(s))}(r,e,t):function(n,u,s){return is(us(n,s),u,s)}(r,e,t)}var Ge={delimiter:"",prefixes:"",sensitive:!0,strict:!0},vi={delimiter:".",prefixes:"",sensitive:!0,strict:!0},Bi={delimiter:"/",prefixes:"/",sensitive:!0,strict:!0};function $n(r,e){return r.startsWith(e)?r.substring(e.length,r.length):r}function os(r){return!(!r||r.length<2||r[0]!=="["&&(r[0]!=="\\"&&r[0]!=="{"||r[1]!=="["))}var x,cs=["ftp","file","http","https","ws","wss"];function ls(r){if(!r)return!0;for(var e,t=kr(cs);!(e=t()).done;)if(r.test(e.value))return!0;return!1}function hs(r){switch(r){case"ws":case"http":return"80";case"wws":case"https":return"443";case"ftp":return"21";default:return""}}function En(r){if(r==="")return r;if(/^[-+.A-Za-z0-9]*$/.test(r))return r.toLowerCase();throw new TypeError("Invalid protocol '"+r+"'.")}function Si(r){if(r==="")return r;var e=new URL("https://example.com");return e.username=r,e.username}function xi(r){if(r==="")return r;var e=new URL("https://example.com");return e.password=r,e.password}function fs(r){if(r==="")return r;if(/[\t\n\r #%/:<>?@[\]^\\|]/g.test(r))throw new TypeError("Invalid hostname '"+r+"'");var e=new URL("https://example.com");return e.hostname=r,e.hostname}function ds(r){if(r==="")return r;if(/[^0-9a-fA-F[\]:]/g.test(r))throw new TypeError("Invalid IPv6 hostname '"+r+"'");return r.toLowerCase()}function Ds(r){if(r===""||/^[0-9]*$/.test(r)&&parseInt(r)<=65535)return r;throw new TypeError("Invalid port '"+r+"'.")}function _i(r){if(r==="")return r;var e=new URL("https://example.com");return e.pathname=r[0]!=="/"?"/-"+r:r,r[0]!=="/"?e.pathname.substring(2,e.pathname.length):e.pathname}function ki(r){return r===""?r:new URL("data:"+r).pathname}function Pi(r){if(r==="")return r;var e=new URL("https://example.com");return e.search=r,e.search.substring(1,e.search.length)}function Ti(r){if(r==="")return r;var e=new URL("https://example.com");return e.hash=r,e.hash.substring(1,e.hash.length)}(function(r){r[r.INIT=0]="INIT",r[r.PROTOCOL=1]="PROTOCOL",r[r.AUTHORITY=2]="AUTHORITY",r[r.USERNAME=3]="USERNAME",r[r.PASSWORD=4]="PASSWORD",r[r.HOSTNAME=5]="HOSTNAME",r[r.PORT=6]="PORT",r[r.PATHNAME=7]="PATHNAME",r[r.SEARCH=8]="SEARCH",r[r.HASH=9]="HASH",r[r.DONE=10]="DONE"})(x||(x={}));var Ii=function(){function r(t){this.input=void 0,this.tokenList=[],this.internalResult={},this.tokenIndex=0,this.tokenIncrement=1,this.componentStart=0,this.state=x.INIT,this.groupDepth=0,this.hostnameIPv6BracketDepth=0,this.shouldTreatAsStandardURL=!1,this.input=t}var e=r.prototype;return e.parse=function(){for(this.tokenList=ns(this.input,!0);this.tokenIndex<this.tokenList.length;this.tokenIndex+=this.tokenIncrement){if(this.tokenIncrement=1,this.tokenList[this.tokenIndex].type==="END"){if(this.state===x.INIT){this.rewind(),this.isHashPrefix()?this.changeState(x.HASH,1):this.isSearchPrefix()?(this.changeState(x.SEARCH,1),this.internalResult.hash=""):(this.changeState(x.PATHNAME,0),this.internalResult.search="",this.internalResult.hash="");continue}if(this.state===x.AUTHORITY){this.rewindAndSetState(x.HOSTNAME);continue}this.changeState(x.DONE,0);break}if(this.groupDepth>0){if(!this.isGroupClose())continue;this.groupDepth-=1}if(this.isGroupOpen())this.groupDepth+=1;else switch(this.state){case x.INIT:this.isProtocolSuffix()&&(this.internalResult.username="",this.internalResult.password="",this.internalResult.hostname="",this.internalResult.port="",this.internalResult.pathname="",this.internalResult.search="",this.internalResult.hash="",this.rewindAndSetState(x.PROTOCOL));break;case x.PROTOCOL:if(this.isProtocolSuffix()){this.computeShouldTreatAsStandardURL();var t=x.PATHNAME,n=1;this.shouldTreatAsStandardURL&&(this.internalResult.pathname="/"),this.nextIsAuthoritySlashes()?(t=x.AUTHORITY,n=3):this.shouldTreatAsStandardURL&&(t=x.AUTHORITY),this.changeState(t,n)}break;case x.AUTHORITY:this.isIdentityTerminator()?this.rewindAndSetState(x.USERNAME):(this.isPathnameStart()||this.isSearchPrefix()||this.isHashPrefix())&&this.rewindAndSetState(x.HOSTNAME);break;case x.USERNAME:this.isPasswordPrefix()?this.changeState(x.PASSWORD,1):this.isIdentityTerminator()&&this.changeState(x.HOSTNAME,1);break;case x.PASSWORD:this.isIdentityTerminator()&&this.changeState(x.HOSTNAME,1);break;case x.HOSTNAME:this.isIPv6Open()?this.hostnameIPv6BracketDepth+=1:this.isIPv6Close()&&(this.hostnameIPv6BracketDepth-=1),this.isPortPrefix()&&!this.hostnameIPv6BracketDepth?this.changeState(x.PORT,1):this.isPathnameStart()?this.changeState(x.PATHNAME,0):this.isSearchPrefix()?this.changeState(x.SEARCH,1):this.isHashPrefix()&&this.changeState(x.HASH,1);break;case x.PORT:this.isPathnameStart()?this.changeState(x.PATHNAME,0):this.isSearchPrefix()?this.changeState(x.SEARCH,1):this.isHashPrefix()&&this.changeState(x.HASH,1);break;case x.PATHNAME:this.isSearchPrefix()?this.changeState(x.SEARCH,1):this.isHashPrefix()&&this.changeState(x.HASH,1);break;case x.SEARCH:this.isHashPrefix()&&this.changeState(x.HASH,1)}}},e.changeState=function(t,n){switch(this.state){case x.INIT:break;case x.PROTOCOL:this.internalResult.protocol=this.makeComponentString();break;case x.AUTHORITY:break;case x.USERNAME:this.internalResult.username=this.makeComponentString();break;case x.PASSWORD:this.internalResult.password=this.makeComponentString();break;case x.HOSTNAME:this.internalResult.hostname=this.makeComponentString();break;case x.PORT:this.internalResult.port=this.makeComponentString();break;case x.PATHNAME:this.internalResult.pathname=this.makeComponentString();break;case x.SEARCH:this.internalResult.search=this.makeComponentString();break;case x.HASH:this.internalResult.hash=this.makeComponentString()}this.changeStateWithoutSettingComponent(t,n)},e.changeStateWithoutSettingComponent=function(t,n){this.state=t,this.componentStart=this.tokenIndex+n,this.tokenIndex+=n,this.tokenIncrement=0},e.rewind=function(){this.tokenIndex=this.componentStart,this.tokenIncrement=0},e.rewindAndSetState=function(t){this.rewind(),this.state=t},e.safeToken=function(t){return t<0&&(t=this.tokenList.length-t),t<this.tokenList.length?this.tokenList[t]:this.tokenList[this.tokenList.length-1]},e.isNonSpecialPatternChar=function(t,n){var u=this.safeToken(t);return u.value===n&&(u.type==="CHAR"||u.type==="ESCAPED_CHAR"||u.type==="INVALID_CHAR")},e.isProtocolSuffix=function(){return this.isNonSpecialPatternChar(this.tokenIndex,":")},e.nextIsAuthoritySlashes=function(){return this.isNonSpecialPatternChar(this.tokenIndex+1,"/")&&this.isNonSpecialPatternChar(this.tokenIndex+2,"/")},e.isIdentityTerminator=function(){return this.isNonSpecialPatternChar(this.tokenIndex,"@")},e.isPasswordPrefix=function(){return this.isNonSpecialPatternChar(this.tokenIndex,":")},e.isPortPrefix=function(){return this.isNonSpecialPatternChar(this.tokenIndex,":")},e.isPathnameStart=function(){return this.isNonSpecialPatternChar(this.tokenIndex,"/")},e.isSearchPrefix=function(){if(this.isNonSpecialPatternChar(this.tokenIndex,"?"))return!0;if(this.tokenList[this.tokenIndex].value!=="?")return!1;var t=this.safeToken(this.tokenIndex-1);return t.type!=="NAME"&&t.type!=="PATTERN"&&t.type!=="CLOSE"&&t.type!=="ASTERISK"},e.isHashPrefix=function(){return this.isNonSpecialPatternChar(this.tokenIndex,"#")},e.isGroupOpen=function(){return this.tokenList[this.tokenIndex].type=="OPEN"},e.isGroupClose=function(){return this.tokenList[this.tokenIndex].type=="CLOSE"},e.isIPv6Open=function(){return this.isNonSpecialPatternChar(this.tokenIndex,"[")},e.isIPv6Close=function(){return this.isNonSpecialPatternChar(this.tokenIndex,"]")},e.makeComponentString=function(){var t=this.tokenList[this.tokenIndex],n=this.safeToken(this.componentStart).index;return this.input.substring(n,t.index)},e.computeShouldTreatAsStandardURL=function(){var t={};Object.assign(t,Ge),t.encodePart=En;var n=as(this.makeComponentString(),void 0,t);this.shouldTreatAsStandardURL=ls(n)},rs(r,[{key:"result",get:function(){return this.internalResult}}]),r}(),Oi=["protocol","username","password","hostname","port","pathname","search","hash"];function Hn(r,e){if(typeof r!="string")throw new TypeError("parameter 1 is not of type 'string'.");var t=new URL(r,e);return{protocol:t.protocol.substring(0,t.protocol.length-1),username:t.username,password:t.password,hostname:t.hostname,port:t.port,pathname:t.pathname,search:t.search!=""?t.search.substring(1,t.search.length):void 0,hash:t.hash!=""?t.hash.substring(1,t.hash.length):void 0}}function Gr(r,e,t){var n;if(typeof e.baseURL=="string")try{n=new URL(e.baseURL),r.protocol=n.protocol?n.protocol.substring(0,n.protocol.length-1):"",r.username=n.username,r.password=n.password,r.hostname=n.hostname,r.port=n.port,r.pathname=n.pathname,r.search=n.search?n.search.substring(1,n.search.length):"",r.hash=n.hash?n.hash.substring(1,n.hash.length):""}catch{throw new TypeError("invalid baseURL '"+e.baseURL+"'.")}if(typeof e.protocol=="string"&&(r.protocol=function(s,i){var a;return s=(a=s).endsWith(":")?a.substr(0,a.length-1):a,i||s===""?s:En(s)}(e.protocol,t)),typeof e.username=="string"&&(r.username=function(s,i){if(i||s==="")return s;var a=new URL("https://example.com");return a.username=s,a.username}(e.username,t)),typeof e.password=="string"&&(r.password=function(s,i){if(i||s==="")return s;var a=new URL("https://example.com");return a.password=s,a.password}(e.password,t)),typeof e.hostname=="string"&&(r.hostname=function(s,i){return i||s===""?s:os(s)?ds(s):fs(s)}(e.hostname,t)),typeof e.port=="string"&&(r.port=function(s,i,a){return hs(i)===s&&(s=""),a||s===""?s:Ds(s)}(e.port,r.protocol,t)),typeof e.pathname=="string"){if(r.pathname=e.pathname,n&&!function(s,i){return!(!s.length||s[0]!=="/"&&(!i||s.length<2||s[0]!="\\"&&s[0]!="{"||s[1]!="/"))}(r.pathname,t)){var u=n.pathname.lastIndexOf("/");u>=0&&(r.pathname=n.pathname.substring(0,u+1)+r.pathname)}r.pathname=function(s,i,a){if(a||s==="")return s;if(i&&!cs.includes(i))return new URL(i+":"+s).pathname;var o=s[0]=="/";return s=new URL(o?s:"/-"+s,"https://example.com").pathname,o||(s=s.substring(2,s.length)),s}(r.pathname,r.protocol,t)}return typeof e.search=="string"&&(r.search=function(s,i){if(s=$n(s,"?"),i||s==="")return s;var a=new URL("https://example.com");return a.search=s,a.search?a.search.substring(1,a.search.length):""}(e.search,t)),typeof e.hash=="string"&&(r.hash=function(s,i){if(s=$n(s,"#"),i||s==="")return s;var a=new URL("https://example.com");return a.hash=s,a.hash?a.hash.substring(1,a.hash.length):""}(e.hash,t)),r}function Ut(r){return r.replace(/([+*?:{}()\\])/g,"\\$1")}function Ri(r,e){for(var t="[^"+(e.delimiter||"/#?").replace(/([.+*?^${}()[\]|/\\])/g,"\\$1")+"]+?",n=/(?:[\$0-9A-Z_a-z\xAA\xB5\xB7\xBA\xC0-\xD6\xD8-\xF6\xF8-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0300-\u0374\u0376\u0377\u037A-\u037D\u037F\u0386-\u038A\u038C\u038E-\u03A1\u03A3-\u03F5\u03F7-\u0481\u0483-\u0487\u048A-\u052F\u0531-\u0556\u0559\u0560-\u0588\u0591-\u05BD\u05BF\u05C1\u05C2\u05C4\u05C5\u05C7\u05D0-\u05EA\u05EF-\u05F2\u0610-\u061A\u0620-\u0669\u066E-\u06D3\u06D5-\u06DC\u06DF-\u06E8\u06EA-\u06FC\u06FF\u0710-\u074A\u074D-\u07B1\u07C0-\u07F5\u07FA\u07FD\u0800-\u082D\u0840-\u085B\u0860-\u086A\u08A0-\u08B4\u08B6-\u08C7\u08D3-\u08E1\u08E3-\u0963\u0966-\u096F\u0971-\u0983\u0985-\u098C\u098F\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BC-\u09C4\u09C7\u09C8\u09CB-\u09CE\u09D7\u09DC\u09DD\u09DF-\u09E3\u09E6-\u09F1\u09FC\u09FE\u0A01-\u0A03\u0A05-\u0A0A\u0A0F\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32\u0A33\u0A35\u0A36\u0A38\u0A39\u0A3C\u0A3E-\u0A42\u0A47\u0A48\u0A4B-\u0A4D\u0A51\u0A59-\u0A5C\u0A5E\u0A66-\u0A75\u0A81-\u0A83\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2\u0AB3\u0AB5-\u0AB9\u0ABC-\u0AC5\u0AC7-\u0AC9\u0ACB-\u0ACD\u0AD0\u0AE0-\u0AE3\u0AE6-\u0AEF\u0AF9-\u0AFF\u0B01-\u0B03\u0B05-\u0B0C\u0B0F\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32\u0B33\u0B35-\u0B39\u0B3C-\u0B44\u0B47\u0B48\u0B4B-\u0B4D\u0B55-\u0B57\u0B5C\u0B5D\u0B5F-\u0B63\u0B66-\u0B6F\u0B71\u0B82\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99\u0B9A\u0B9C\u0B9E\u0B9F\u0BA3\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BBE-\u0BC2\u0BC6-\u0BC8\u0BCA-\u0BCD\u0BD0\u0BD7\u0BE6-\u0BEF\u0C00-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C39\u0C3D-\u0C44\u0C46-\u0C48\u0C4A-\u0C4D\u0C55\u0C56\u0C58-\u0C5A\u0C60-\u0C63\u0C66-\u0C6F\u0C80-\u0C83\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBC-\u0CC4\u0CC6-\u0CC8\u0CCA-\u0CCD\u0CD5\u0CD6\u0CDE\u0CE0-\u0CE3\u0CE6-\u0CEF\u0CF1\u0CF2\u0D00-\u0D0C\u0D0E-\u0D10\u0D12-\u0D44\u0D46-\u0D48\u0D4A-\u0D4E\u0D54-\u0D57\u0D5F-\u0D63\u0D66-\u0D6F\u0D7A-\u0D7F\u0D81-\u0D83\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0DCA\u0DCF-\u0DD4\u0DD6\u0DD8-\u0DDF\u0DE6-\u0DEF\u0DF2\u0DF3\u0E01-\u0E3A\u0E40-\u0E4E\u0E50-\u0E59\u0E81\u0E82\u0E84\u0E86-\u0E8A\u0E8C-\u0EA3\u0EA5\u0EA7-\u0EBD\u0EC0-\u0EC4\u0EC6\u0EC8-\u0ECD\u0ED0-\u0ED9\u0EDC-\u0EDF\u0F00\u0F18\u0F19\u0F20-\u0F29\u0F35\u0F37\u0F39\u0F3E-\u0F47\u0F49-\u0F6C\u0F71-\u0F84\u0F86-\u0F97\u0F99-\u0FBC\u0FC6\u1000-\u1049\u1050-\u109D\u10A0-\u10C5\u10C7\u10CD\u10D0-\u10FA\u10FC-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u135D-\u135F\u1369-\u1371\u1380-\u138F\u13A0-\u13F5\u13F8-\u13FD\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u16EE-\u16F8\u1700-\u170C\u170E-\u1714\u1720-\u1734\u1740-\u1753\u1760-\u176C\u176E-\u1770\u1772\u1773\u1780-\u17D3\u17D7\u17DC\u17DD\u17E0-\u17E9\u180B-\u180D\u1810-\u1819\u1820-\u1878\u1880-\u18AA\u18B0-\u18F5\u1900-\u191E\u1920-\u192B\u1930-\u193B\u1946-\u196D\u1970-\u1974\u1980-\u19AB\u19B0-\u19C9\u19D0-\u19DA\u1A00-\u1A1B\u1A20-\u1A5E\u1A60-\u1A7C\u1A7F-\u1A89\u1A90-\u1A99\u1AA7\u1AB0-\u1ABD\u1ABF\u1AC0\u1B00-\u1B4B\u1B50-\u1B59\u1B6B-\u1B73\u1B80-\u1BF3\u1C00-\u1C37\u1C40-\u1C49\u1C4D-\u1C7D\u1C80-\u1C88\u1C90-\u1CBA\u1CBD-\u1CBF\u1CD0-\u1CD2\u1CD4-\u1CFA\u1D00-\u1DF9\u1DFB-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FBC\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FCC\u1FD0-\u1FD3\u1FD6-\u1FDB\u1FE0-\u1FEC\u1FF2-\u1FF4\u1FF6-\u1FFC\u200C\u200D\u203F\u2040\u2054\u2071\u207F\u2090-\u209C\u20D0-\u20DC\u20E1\u20E5-\u20F0\u2102\u2107\u210A-\u2113\u2115\u2118-\u211D\u2124\u2126\u2128\u212A-\u2139\u213C-\u213F\u2145-\u2149\u214E\u2160-\u2188\u2C00-\u2C2E\u2C30-\u2C5E\u2C60-\u2CE4\u2CEB-\u2CF3\u2D00-\u2D25\u2D27\u2D2D\u2D30-\u2D67\u2D6F\u2D7F-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u2DE0-\u2DFF\u3005-\u3007\u3021-\u302F\u3031-\u3035\u3038-\u303C\u3041-\u3096\u3099-\u309F\u30A1-\u30FA\u30FC-\u30FF\u3105-\u312F\u3131-\u318E\u31A0-\u31BF\u31F0-\u31FF\u3400-\u4DBF\u4E00-\u9FFC\uA000-\uA48C\uA4D0-\uA4FD\uA500-\uA60C\uA610-\uA62B\uA640-\uA66F\uA674-\uA67D\uA67F-\uA6F1\uA717-\uA71F\uA722-\uA788\uA78B-\uA7BF\uA7C2-\uA7CA\uA7F5-\uA827\uA82C\uA840-\uA873\uA880-\uA8C5\uA8D0-\uA8D9\uA8E0-\uA8F7\uA8FB\uA8FD-\uA92D\uA930-\uA953\uA960-\uA97C\uA980-\uA9C0\uA9CF-\uA9D9\uA9E0-\uA9FE\uAA00-\uAA36\uAA40-\uAA4D\uAA50-\uAA59\uAA60-\uAA76\uAA7A-\uAAC2\uAADB-\uAADD\uAAE0-\uAAEF\uAAF2-\uAAF6\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uAB30-\uAB5A\uAB5C-\uAB69\uAB70-\uABEA\uABEC\uABED\uABF0-\uABF9\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB00-\uFB06\uFB13-\uFB17\uFB1D-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40\uFB41\uFB43\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE00-\uFE0F\uFE20-\uFE2F\uFE33\uFE34\uFE4D-\uFE4F\uFE70-\uFE74\uFE76-\uFEFC\uFF10-\uFF19\uFF21-\uFF3A\uFF3F\uFF41-\uFF5A\uFF66-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC]|\uD800[\uDC00-\uDC0B\uDC0D-\uDC26\uDC28-\uDC3A\uDC3C\uDC3D\uDC3F-\uDC4D\uDC50-\uDC5D\uDC80-\uDCFA\uDD40-\uDD74\uDDFD\uDE80-\uDE9C\uDEA0-\uDED0\uDEE0\uDF00-\uDF1F\uDF2D-\uDF4A\uDF50-\uDF7A\uDF80-\uDF9D\uDFA0-\uDFC3\uDFC8-\uDFCF\uDFD1-\uDFD5]|\uD801[\uDC00-\uDC9D\uDCA0-\uDCA9\uDCB0-\uDCD3\uDCD8-\uDCFB\uDD00-\uDD27\uDD30-\uDD63\uDE00-\uDF36\uDF40-\uDF55\uDF60-\uDF67]|\uD802[\uDC00-\uDC05\uDC08\uDC0A-\uDC35\uDC37\uDC38\uDC3C\uDC3F-\uDC55\uDC60-\uDC76\uDC80-\uDC9E\uDCE0-\uDCF2\uDCF4\uDCF5\uDD00-\uDD15\uDD20-\uDD39\uDD80-\uDDB7\uDDBE\uDDBF\uDE00-\uDE03\uDE05\uDE06\uDE0C-\uDE13\uDE15-\uDE17\uDE19-\uDE35\uDE38-\uDE3A\uDE3F\uDE60-\uDE7C\uDE80-\uDE9C\uDEC0-\uDEC7\uDEC9-\uDEE6\uDF00-\uDF35\uDF40-\uDF55\uDF60-\uDF72\uDF80-\uDF91]|\uD803[\uDC00-\uDC48\uDC80-\uDCB2\uDCC0-\uDCF2\uDD00-\uDD27\uDD30-\uDD39\uDE80-\uDEA9\uDEAB\uDEAC\uDEB0\uDEB1\uDF00-\uDF1C\uDF27\uDF30-\uDF50\uDFB0-\uDFC4\uDFE0-\uDFF6]|\uD804[\uDC00-\uDC46\uDC66-\uDC6F\uDC7F-\uDCBA\uDCD0-\uDCE8\uDCF0-\uDCF9\uDD00-\uDD34\uDD36-\uDD3F\uDD44-\uDD47\uDD50-\uDD73\uDD76\uDD80-\uDDC4\uDDC9-\uDDCC\uDDCE-\uDDDA\uDDDC\uDE00-\uDE11\uDE13-\uDE37\uDE3E\uDE80-\uDE86\uDE88\uDE8A-\uDE8D\uDE8F-\uDE9D\uDE9F-\uDEA8\uDEB0-\uDEEA\uDEF0-\uDEF9\uDF00-\uDF03\uDF05-\uDF0C\uDF0F\uDF10\uDF13-\uDF28\uDF2A-\uDF30\uDF32\uDF33\uDF35-\uDF39\uDF3B-\uDF44\uDF47\uDF48\uDF4B-\uDF4D\uDF50\uDF57\uDF5D-\uDF63\uDF66-\uDF6C\uDF70-\uDF74]|\uD805[\uDC00-\uDC4A\uDC50-\uDC59\uDC5E-\uDC61\uDC80-\uDCC5\uDCC7\uDCD0-\uDCD9\uDD80-\uDDB5\uDDB8-\uDDC0\uDDD8-\uDDDD\uDE00-\uDE40\uDE44\uDE50-\uDE59\uDE80-\uDEB8\uDEC0-\uDEC9\uDF00-\uDF1A\uDF1D-\uDF2B\uDF30-\uDF39]|\uD806[\uDC00-\uDC3A\uDCA0-\uDCE9\uDCFF-\uDD06\uDD09\uDD0C-\uDD13\uDD15\uDD16\uDD18-\uDD35\uDD37\uDD38\uDD3B-\uDD43\uDD50-\uDD59\uDDA0-\uDDA7\uDDAA-\uDDD7\uDDDA-\uDDE1\uDDE3\uDDE4\uDE00-\uDE3E\uDE47\uDE50-\uDE99\uDE9D\uDEC0-\uDEF8]|\uD807[\uDC00-\uDC08\uDC0A-\uDC36\uDC38-\uDC40\uDC50-\uDC59\uDC72-\uDC8F\uDC92-\uDCA7\uDCA9-\uDCB6\uDD00-\uDD06\uDD08\uDD09\uDD0B-\uDD36\uDD3A\uDD3C\uDD3D\uDD3F-\uDD47\uDD50-\uDD59\uDD60-\uDD65\uDD67\uDD68\uDD6A-\uDD8E\uDD90\uDD91\uDD93-\uDD98\uDDA0-\uDDA9\uDEE0-\uDEF6\uDFB0]|\uD808[\uDC00-\uDF99]|\uD809[\uDC00-\uDC6E\uDC80-\uDD43]|[\uD80C\uD81C-\uD820\uD822\uD840-\uD868\uD86A-\uD86C\uD86F-\uD872\uD874-\uD879\uD880-\uD883][\uDC00-\uDFFF]|\uD80D[\uDC00-\uDC2E]|\uD811[\uDC00-\uDE46]|\uD81A[\uDC00-\uDE38\uDE40-\uDE5E\uDE60-\uDE69\uDED0-\uDEED\uDEF0-\uDEF4\uDF00-\uDF36\uDF40-\uDF43\uDF50-\uDF59\uDF63-\uDF77\uDF7D-\uDF8F]|\uD81B[\uDE40-\uDE7F\uDF00-\uDF4A\uDF4F-\uDF87\uDF8F-\uDF9F\uDFE0\uDFE1\uDFE3\uDFE4\uDFF0\uDFF1]|\uD821[\uDC00-\uDFF7]|\uD823[\uDC00-\uDCD5\uDD00-\uDD08]|\uD82C[\uDC00-\uDD1E\uDD50-\uDD52\uDD64-\uDD67\uDD70-\uDEFB]|\uD82F[\uDC00-\uDC6A\uDC70-\uDC7C\uDC80-\uDC88\uDC90-\uDC99\uDC9D\uDC9E]|\uD834[\uDD65-\uDD69\uDD6D-\uDD72\uDD7B-\uDD82\uDD85-\uDD8B\uDDAA-\uDDAD\uDE42-\uDE44]|\uD835[\uDC00-\uDC54\uDC56-\uDC9C\uDC9E\uDC9F\uDCA2\uDCA5\uDCA6\uDCA9-\uDCAC\uDCAE-\uDCB9\uDCBB\uDCBD-\uDCC3\uDCC5-\uDD05\uDD07-\uDD0A\uDD0D-\uDD14\uDD16-\uDD1C\uDD1E-\uDD39\uDD3B-\uDD3E\uDD40-\uDD44\uDD46\uDD4A-\uDD50\uDD52-\uDEA5\uDEA8-\uDEC0\uDEC2-\uDEDA\uDEDC-\uDEFA\uDEFC-\uDF14\uDF16-\uDF34\uDF36-\uDF4E\uDF50-\uDF6E\uDF70-\uDF88\uDF8A-\uDFA8\uDFAA-\uDFC2\uDFC4-\uDFCB\uDFCE-\uDFFF]|\uD836[\uDE00-\uDE36\uDE3B-\uDE6C\uDE75\uDE84\uDE9B-\uDE9F\uDEA1-\uDEAF]|\uD838[\uDC00-\uDC06\uDC08-\uDC18\uDC1B-\uDC21\uDC23\uDC24\uDC26-\uDC2A\uDD00-\uDD2C\uDD30-\uDD3D\uDD40-\uDD49\uDD4E\uDEC0-\uDEF9]|\uD83A[\uDC00-\uDCC4\uDCD0-\uDCD6\uDD00-\uDD4B\uDD50-\uDD59]|\uD83B[\uDE00-\uDE03\uDE05-\uDE1F\uDE21\uDE22\uDE24\uDE27\uDE29-\uDE32\uDE34-\uDE37\uDE39\uDE3B\uDE42\uDE47\uDE49\uDE4B\uDE4D-\uDE4F\uDE51\uDE52\uDE54\uDE57\uDE59\uDE5B\uDE5D\uDE5F\uDE61\uDE62\uDE64\uDE67-\uDE6A\uDE6C-\uDE72\uDE74-\uDE77\uDE79-\uDE7C\uDE7E\uDE80-\uDE89\uDE8B-\uDE9B\uDEA1-\uDEA3\uDEA5-\uDEA9\uDEAB-\uDEBB]|\uD83E[\uDFF0-\uDFF9]|\uD869[\uDC00-\uDEDD\uDF00-\uDFFF]|\uD86D[\uDC00-\uDF34\uDF40-\uDFFF]|\uD86E[\uDC00-\uDC1D\uDC20-\uDFFF]|\uD873[\uDC00-\uDEA1\uDEB0-\uDFFF]|\uD87A[\uDC00-\uDFE0]|\uD87E[\uDC00-\uDE1D]|\uD884[\uDC00-\uDF4A]|\uDB40[\uDD00-\uDDEF])/,u="",s=0;s<r.length;++s){var i=r[s],a=s>0?r[s-1]:null,o=s<r.length-1?r[s+1]:null;if(typeof i!="string")if(i.pattern!==""){var c=typeof i.name!="number",f=e.prefixes!==void 0?e.prefixes:"./",h=i.suffix!==""||i.prefix!==""&&(i.prefix.length!==1||!f.includes(i.prefix));h||!c||i.pattern!==t||i.modifier!==""||!o||o.prefix||o.suffix||(h=typeof o=="string"?n.test(o.length>0?o[0]:""):typeof o.name=="number"),!h&&i.prefix===""&&a&&typeof a=="string"&&a.length>0&&(h=f.includes(a[a.length-1])),h&&(u+="{"),u+=Ut(i.prefix),c&&(u+=":"+i.name),i.pattern===".*"?u+=c||a&&typeof a!="string"&&!a.modifier&&!h&&i.prefix===""?"(.*)":"*":i.pattern===t?c||(u+="("+t+")"):u+="("+i.pattern+")",i.pattern===t&&c&&i.suffix!==""&&n.test(i.suffix[0])&&(u+="\\"),u+=Ut(i.suffix),h&&(u+="}"),u+=i.modifier}else{if(i.modifier===""){u+=Ut(i.prefix);continue}u+="{"+Ut(i.prefix)+"}"+i.modifier}else u+=Ut(i)}return u}var Mi=function(){function r(t,n){t===void 0&&(t={}),this.pattern=void 0,this.regexp={},this.keys={},this.component_pattern={};try{if(typeof t=="string"){var u=new Ii(t);if(u.parse(),t=u.result,n){if(typeof n!="string")throw new TypeError("'baseURL' parameter is not of type 'string'.");t.baseURL=n}else if(typeof t.protocol!="string")throw new TypeError("A base URL must be provided for a relative constructor string.")}else if(n)throw new TypeError("parameter 1 is not of type 'string'.");if(!t||typeof t!="object")throw new TypeError("parameter 1 is not of type 'string' and cannot convert to dictionary.");var s;this.pattern=Gr({pathname:"*",protocol:"*",username:"*",password:"*",hostname:"*",port:"*",search:"*",hash:"*"},t,!0),hs(this.pattern.protocol)===this.pattern.port&&(this.pattern.port="");for(var i,a=kr(Oi);!(i=a()).done;)if((s=i.value)in this.pattern){var o={},c=this.pattern[s];switch(this.keys[s]=[],s){case"protocol":Object.assign(o,Ge),o.encodePart=En;break;case"username":Object.assign(o,Ge),o.encodePart=Si;break;case"password":Object.assign(o,Ge),o.encodePart=xi;break;case"hostname":Object.assign(o,vi),o.encodePart=os(c)?ds:fs;break;case"port":Object.assign(o,Ge),o.encodePart=Ds;break;case"pathname":ls(this.regexp.protocol)?(Object.assign(o,Bi),o.encodePart=_i):(Object.assign(o,Ge),o.encodePart=ki);break;case"search":Object.assign(o,Ge),o.encodePart=Pi;break;case"hash":Object.assign(o,Ge),o.encodePart=Ti}try{var f=us(c,o);this.regexp[s]=is(f,this.keys[s],o),this.component_pattern[s]=Ri(f,o)}catch{throw new TypeError("invalid "+s+" pattern '"+this.pattern[s]+"'.")}}}catch(h){throw new TypeError("Failed to construct 'URLPattern': "+h.message)}}var e=r.prototype;return e.test=function(t,n){t===void 0&&(t={});var u,s={pathname:"",protocol:"",username:"",password:"",hostname:"",port:"",search:"",hash:""};if(typeof t!="string"&&n)throw new TypeError("parameter 1 is not of type 'string'.");if(t===void 0)return!1;try{s=Gr(s,typeof t=="object"?t:Hn(t,n),!1)}catch{return!1}for(u in this.pattern)if(!this.regexp[u].exec(s[u]))return!1;return!0},e.exec=function(t,n){t===void 0&&(t={});var u={pathname:"",protocol:"",username:"",password:"",hostname:"",port:"",search:"",hash:""};if(typeof t!="string"&&n)throw new TypeError("parameter 1 is not of type 'string'.");if(t!==void 0){try{u=Gr(u,typeof t=="object"?t:Hn(t,n),!1)}catch{return null}var s,i={};for(s in i.inputs=n?[t,n]:[t],this.pattern){var a=this.regexp[s].exec(u[s]);if(!a)return null;for(var o,c={},f=kr(this.keys[s].entries());!(o=f()).done;){var h=o.value,l=h[1];typeof l.name!="string"&&typeof l.name!="number"||(c[l.name]=a[h[0]+1]||"")}i[s]={input:u[s]||"",groups:c}}return i}},rs(r,[{key:"protocol",get:function(){return this.component_pattern.protocol}},{key:"username",get:function(){return this.component_pattern.username}},{key:"password",get:function(){return this.component_pattern.password}},{key:"hostname",get:function(){return this.component_pattern.hostname}},{key:"port",get:function(){return this.component_pattern.port}},{key:"pathname",get:function(){return this.component_pattern.pathname}},{key:"search",get:function(){return this.component_pattern.search}},{key:"hash",get:function(){return this.component_pattern.hash}}]),r}();const ji={crypto:Yu.crypto,setInterval:Mr,setTimeout:dt,WeakRef:Ju,Blob:es,Request:gi,Response:bi,Headers:wi,WritableStream:Ce,TransformStream:Rt,ReadableStream:Dt,TransformStreamDefaultController:yi,WritableStreamDefaultWriter:Ai,WebSocket:Tt,TextEncoder:Cn,TextDecoder:ts,URLPattern:Mi},ps=Ni(globalThis,ji);function Ni(r,e){return new Proxy(r,{get(t,n,u){return n in e?e[n]:r[n]},set(t,n,u){return n in e&&delete e[n],r[n]=u,!0},deleteProperty(t,n){let u=!1;return n in e&&(delete e[n],u=!0),n in r&&(delete r[n],u=!0),u},ownKeys(t){const n=Reflect.ownKeys(r),u=Reflect.ownKeys(e),s=new Set(u);return[...n.filter(i=>!s.has(i)),...u]},defineProperty(t,n,u){return n in e&&delete e[n],Reflect.defineProperty(r,n,u),!0},getOwnPropertyDescriptor(t,n){return n in e?Reflect.getOwnPropertyDescriptor(e,n):Reflect.getOwnPropertyDescriptor(r,n)},has(t,n){return n in e||n in r}})}function ms(r,e){if(r===e)return!0;if(!r||!e)return!1;var t=r.length;if(e.length!==t)return!1;for(var n=0;n<t;n++)if(r[n]!==e[n])return!1;return!0}function Pr(r,e){if(r===e)return!0;if(!r||!e)return!1;var t=Object.keys(r),n=Object.keys(e),u=t.length;if(n.length!==u)return!1;for(var s=0;s<u;s++){var i=t[s];if(r[i]!==e[i]||!Object.prototype.hasOwnProperty.call(e,i))return!1}return!0}var Li=function(r,e){e||(e={}),typeof e=="function"&&(e={cmp:e});var t=typeof e.cycles=="boolean"?e.cycles:!1,n=e.cmp&&function(s){return function(i){return function(a,o){var c={key:a,value:i[a]},f={key:o,value:i[o]};return s(c,f)}}}(e.cmp),u=[];return function s(i){if(i&&i.toJSON&&typeof i.toJSON=="function"&&(i=i.toJSON()),i!==void 0){if(typeof i=="number")return isFinite(i)?""+i:"null";if(typeof i!="object")return JSON.stringify(i);var a,o;if(Array.isArray(i)){for(o="[",a=0;a<i.length;a++)a&&(o+=","),o+=s(i[a])||"null";return o+"]"}if(i===null)return"null";if(u.indexOf(i)!==-1){if(t)return JSON.stringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}var c=u.push(i)-1,f=Object.keys(i).sort(n&&n(i));for(o="",a=0;a<f.length;a++){var h=f[a],l=s(i[h]);l&&(o&&(o+=","),o+=JSON.stringify(h)+":"+l)}return u.splice(c,1),"{"+o+"}"}}(r)};const Ui=ci(Li);var be={};Object.defineProperty(be,"__esModule",{value:!0});function Mt(r,e,t){var n;if(t===void 0&&(t={}),!e.codes){e.codes={};for(var u=0;u<e.chars.length;++u)e.codes[e.chars[u]]=u}if(!t.loose&&r.length*e.bits&7)throw new SyntaxError("Invalid padding");for(var s=r.length;r[s-1]==="=";)if(--s,!t.loose&&!((r.length-s)*e.bits&7))throw new SyntaxError("Invalid padding");for(var i=new((n=t.out)!=null?n:Uint8Array)(s*e.bits/8|0),a=0,o=0,c=0,f=0;f<s;++f){var h=e.codes[r[f]];if(h===void 0)throw new SyntaxError("Invalid character "+r[f]);o=o<<e.bits|h,a+=e.bits,a>=8&&(a-=8,i[c++]=255&o>>a)}if(a>=e.bits||255&o<<8-a)throw new SyntaxError("Unexpected end of data");return i}function jt(r,e,t){t===void 0&&(t={});for(var n=t,u=n.pad,s=u===void 0?!0:u,i=(1<<e.bits)-1,a="",o=0,c=0,f=0;f<r.length;++f)for(c=c<<8|255&r[f],o+=8;o>e.bits;)o-=e.bits,a+=e.chars[i&c>>o];if(o&&(a+=e.chars[i&c<<e.bits-o]),s)for(;a.length*e.bits&7;)a+="=";return a}var qn={chars:"0123456789ABCDEF",bits:4},Wn={chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bits:5},Vn={chars:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bits:5},zn={chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bits:6},Qn={chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bits:6},$i={parse:function(e,t){return Mt(e.toUpperCase(),qn,t)},stringify:function(e,t){return jt(e,qn,t)}},Hi={parse:function(e,t){return t===void 0&&(t={}),Mt(t.loose?e.toUpperCase().replace(/0/g,"O").replace(/1/g,"L").replace(/8/g,"B"):e,Wn,t)},stringify:function(e,t){return jt(e,Wn,t)}},qi={parse:function(e,t){return Mt(e,Vn,t)},stringify:function(e,t){return jt(e,Vn,t)}},Wi={parse:function(e,t){return Mt(e,zn,t)},stringify:function(e,t){return jt(e,zn,t)}},Vi={parse:function(e,t){return Mt(e,Qn,t)},stringify:function(e,t){return jt(e,Qn,t)}},zi={parse:Mt,stringify:jt};be.base16=$i;be.base32=Hi;be.base32hex=qi;be.base64=Wi;be.base64url=Vi;be.codec=zi;const Qi=be.base16,Ki=be.base32,Gi=be.base32hex,Yi=be.base64,Xi=be.base64url,Zi=be.codec,Ji=Object.freeze(Object.defineProperty({__proto__:null,base16:Qi,base32:Ki,base32hex:Gi,base64:Yi,base64url:Xi,codec:Zi,default:be},Symbol.toStringTag,{value:"Module"}));var pt={};Object.defineProperty(pt,"__esModule",{value:!0});var gs=pt.Hash=bs=pt.createHash=void 0;const ea=[1116352408,1899447441,-1245643825,-373957723,961987163,1508970993,-1841331548,-1424204075,-670586216,310598401,607225278,1426881987,1925078388,-2132889090,-1680079193,-1046744716,-459576895,-272742522,264347078,604807628,770255983,1249150122,1555081692,1996064986,-1740746414,-1473132947,-1341970488,-1084653625,-958395405,-710438585,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,-2117940946,-1838011259,-1564481375,-1474664885,-1035236496,-949202525,-778901479,-694614492,-200395387,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,-2067236844,-1933114872,-1866530822,-1538233109,-1090935817,-965641998],Kn={sha256:1};function ta(r){if(r&&!Kn[r]&&!Kn[r.toLowerCase()])throw new Error("Digest method not supported");return new ws}var bs=pt.createHash=ta;class ws{constructor(){this.A=1779033703,this.B=-1150833019,this.C=1013904242,this.D=-1521486534,this.E=1359893119,this.F=-1694144372,this.G=528734635,this.H=1541459225,this._size=0,this._sp=0,(!dr||$t>=8e3)&&(dr=new ArrayBuffer(8e3),$t=0),this._byte=new Uint8Array(dr,$t,80),this._word=new Int32Array(dr,$t,20),$t+=80}update(e){if(typeof e=="string")return this._utf8(e);if(e==null)throw new TypeError("Invalid type: "+typeof e);const t=e.byteOffset,n=e.byteLength;let u=n/64|0,s=0;if(u&&!(t&3)&&!(this._size%64)){const a=new Int32Array(e.buffer,t,u*16);for(;u--;)this._int32(a,s>>2),s+=64;this._size+=s}if(e.BYTES_PER_ELEMENT!==1&&e.buffer){const a=new Uint8Array(e.buffer,t+s,n-s);return this._uint8(a)}return s===n?this:this._uint8(e,s)}_uint8(e,t){const{_byte:n,_word:u}=this,s=e.length;for(t=t|0;t<s;){const i=this._size%64;let a=i;for(;t<s&&a<64;)n[a++]=e[t++];a>=64&&this._int32(u),this._size+=a-i}return this}_utf8(e){const{_byte:t,_word:n}=this,u=e.length;let s=this._sp;for(let i=0;i<u;){const a=this._size%64;let o=a;for(;i<u&&o<64;){let c=e.charCodeAt(i++)|0;c<128?t[o++]=c:c<2048?(t[o++]=192|c>>>6,t[o++]=128|c&63):c<55296||c>57343?(t[o++]=224|c>>>12,t[o++]=128|c>>>6&63,t[o++]=128|c&63):s?(c=((s&1023)<<10)+(c&1023)+65536,t[o++]=240|c>>>18,t[o++]=128|c>>>12&63,t[o++]=128|c>>>6&63,t[o++]=128|c&63,s=0):s=c}o>=64&&(this._int32(n),n[0]=n[16]),this._size+=o-a}return this._sp=s,this}_int32(e,t){let{A:n,B:u,C:s,D:i,E:a,F:o,G:c,H:f}=this,h=0;for(t=t|0;h<16;)et[h++]=ve(e[t++]);for(h=16;h<64;h++)et[h]=ca(et[h-2])+et[h-7]+oa(et[h-15])+et[h-16]|0;for(h=0;h<64;h++){const l=f+aa(a)+ua(a,o,c)+ea[h]+et[h]|0,d=ia(n)+sa(n,u,s)|0;f=c,c=o,o=a,a=i+l|0,i=s,s=u,u=n,n=l+d|0}this.A=n+this.A|0,this.B=u+this.B|0,this.C=s+this.C|0,this.D=i+this.D|0,this.E=a+this.E|0,this.F=o+this.F|0,this.G=c+this.G|0,this.H=f+this.H|0}digest(e){const{_byte:t,_word:n}=this;let u=this._size%64|0;for(t[u++]=128;u&3;)t[u++]=0;if(u>>=2,u>14){for(;u<16;)n[u++]=0;u=0,this._int32(n)}for(;u<16;)n[u++]=0;const s=this._size*8,i=(s&4294967295)>>>0,a=(s-i)/4294967296;return a&&(n[14]=ve(a)),i&&(n[15]=ve(i)),this._int32(n),e==="hex"?this._hex():this._bin()}_hex(){const{A:e,B:t,C:n,D:u,E:s,F:i,G:a,H:o}=this;return Qe(e)+Qe(t)+Qe(n)+Qe(u)+Qe(s)+Qe(i)+Qe(a)+Qe(o)}_bin(){const{A:e,B:t,C:n,D:u,E:s,F:i,G:a,H:o,_byte:c,_word:f}=this;return f[0]=ve(e),f[1]=ve(t),f[2]=ve(n),f[3]=ve(u),f[4]=ve(s),f[5]=ve(i),f[6]=ve(a),f[7]=ve(o),c.slice(0,32)}}gs=pt.Hash=ws;const et=new Int32Array(64);let dr,$t=0;const Qe=r=>(r+4294967296).toString(16).substr(-8),ra=r=>r<<24&4278190080|r<<8&16711680|r>>8&65280|r>>24&255,na=r=>r,ve=la()?na:ra,ua=(r,e,t)=>t^r&(e^t),sa=(r,e,t)=>r&e|t&(r|e),ia=r=>(r>>>2|r<<30)^(r>>>13|r<<19)^(r>>>22|r<<10),aa=r=>(r>>>6|r<<26)^(r>>>11|r<<21)^(r>>>25|r<<7),oa=r=>(r>>>7|r<<25)^(r>>>18|r<<14)^r>>>3,ca=r=>(r>>>17|r<<15)^(r>>>19|r<<13)^r>>>10;function la(){return new Uint8Array(new Uint16Array([65279]).buffer)[0]===254}const ha=Gs({__proto__:null,get Hash(){return gs},get createHash(){return bs},default:pt},[pt]);/*! noble-ed25519 - MIT License (c) 2019 Paul Miller (paulmillr.com) */const ne=BigInt(0),N=BigInt(1),de=BigInt(2),ys=BigInt(255),Gn=de**BigInt(252)+BigInt("27742317777372353535851937790883648493"),z={a:BigInt(-1),d:BigInt("37095705934669439343138083508754565189542113879843219016388785533085940283555"),P:de**ys-BigInt(19),l:Gn,n:Gn,h:BigInt(8),Gx:BigInt("15112221349535400772501151409588531511454012693041857206046113283949847762202"),Gy:BigInt("46316835694926478169428394003475163141307993866256225615783033603165251855960")},As=de**BigInt(256),Zt=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");BigInt("6853475219497561581579357271197624642482790079785650197046958215289687604742");const fa=BigInt("25063068953384623474111414158702152701244531502492656460079210482610430750235"),da=BigInt("54469307008909316920995813868745141605393597292927456921205312896311721017578"),Da=BigInt("1159843021668779879193775521855586647937357759715417654439879720876111806838"),pa=BigInt("40440834346308536858101042469323190826248399146238708352240133220865137265952");class U{constructor(e,t,n,u){this.x=e,this.y=t,this.z=n,this.t=u}static fromAffine(e){if(!(e instanceof J))throw new TypeError("ExtendedPoint#fromAffine: expected Point");return e.equals(J.ZERO)?U.ZERO:new U(e.x,e.y,N,g(e.x*e.y))}static toAffineBatch(e){const t=ba(e.map(n=>n.z));return e.map((n,u)=>n.toAffine(t[u]))}static normalizeZ(e){return this.toAffineBatch(e).map(this.fromAffine)}equals(e){Yn(e);const{x:t,y:n,z:u}=this,{x:s,y:i,z:a}=e,o=g(t*a),c=g(s*u),f=g(n*a),h=g(i*u);return o===c&&f===h}negate(){return new U(g(-this.x),this.y,this.z,g(-this.t))}double(){const{x:e,y:t,z:n}=this,{a:u}=z,s=g(e**de),i=g(t**de),a=g(de*g(n**de)),o=g(u*s),c=g(g((e+t)**de)-s-i),f=o+i,h=f-a,l=o-i,d=g(c*h),D=g(f*l),m=g(c*l),p=g(h*f);return new U(d,D,p,m)}add(e){Yn(e);const{x:t,y:n,z:u,t:s}=this,{x:i,y:a,z:o,t:c}=e,f=g((n-t)*(a+i)),h=g((n+t)*(a-i)),l=g(h-f);if(l===ne)return this.double();const d=g(u*de*c),D=g(s*de*o),m=D+d,p=h+f,w=D-d,B=g(m*l),k=g(p*w),v=g(m*w),H=g(l*p);return new U(B,k,H,v)}subtract(e){return this.add(e.negate())}precomputeWindow(e){const t=1+256/e,n=[];let u=this,s=u;for(let i=0;i<t;i++){s=u,n.push(s);for(let a=1;a<2**(e-1);a++)s=s.add(u),n.push(s);u=s.double()}return n}wNAF(e,t){!t&&this.equals(U.BASE)&&(t=J.BASE);const n=t&&t._WINDOW_SIZE||1;if(256%n)throw new Error("Point#wNAF: Invalid precomputation window, must be power of 2");let u=t&&ln.get(t);u||(u=this.precomputeWindow(n),t&&n!==1&&(u=U.normalizeZ(u),ln.set(t,u)));let s=U.ZERO,i=U.ZERO;const a=1+256/n,o=2**(n-1),c=BigInt(2**n-1),f=2**n,h=BigInt(n);for(let l=0;l<a;l++){const d=l*o;let D=Number(e&c);if(e>>=h,D>o&&(D-=f,e+=N),D===0){let m=u[d];l%2&&(m=m.negate()),i=i.add(m)}else{let m=u[d+Math.abs(D)-1];D<0&&(m=m.negate()),s=s.add(m)}}return U.normalizeZ([s,i])[0]}multiply(e,t){return this.wNAF(Tr(e,z.l),t)}multiplyUnsafe(e){let t=Tr(e,z.l,!1);const n=U.BASE,u=U.ZERO;if(t===ne)return u;if(this.equals(u)||t===N)return this;if(this.equals(n))return this.wNAF(t);let s=u,i=this;for(;t>ne;)t&N&&(s=s.add(i)),i=i.double(),t>>=N;return s}isSmallOrder(){return this.multiplyUnsafe(z.h).equals(U.ZERO)}isTorsionFree(){return this.multiplyUnsafe(z.l).equals(U.ZERO)}toAffine(e=jr(this.z)){const{x:t,y:n,z:u}=this,s=g(t*e),i=g(n*e);if(g(u*e)!==N)throw new Error("invZ was invalid");return new J(s,i)}fromRistrettoBytes(){Xr()}toRistrettoBytes(){Xr()}fromRistrettoHash(){Xr()}}U.BASE=new U(z.Gx,z.Gy,N,g(z.Gx*z.Gy));U.ZERO=new U(ne,N,N,ne);function Yn(r){if(!(r instanceof U))throw new TypeError("ExtendedPoint expected")}function Yr(r){if(!(r instanceof Ee))throw new TypeError("RistrettoPoint expected")}function Xr(){throw new Error("Legacy method: switch to RistrettoPoint")}class Ee{constructor(e){this.ep=e}static calcElligatorRistrettoMap(e){const{d:t}=z,n=g(Zt*e*e),u=g((n+N)*Da);let s=BigInt(-1);const i=g((s-t*n)*g(n+t));let{isValid:a,value:o}=Fn(u,i),c=g(o*e);Ye(c)||(c=g(-c)),a||(o=c),a||(s=n);const f=g(s*(n-N)*pa-i),h=o*o,l=g((o+o)*i),d=g(f*fa),D=g(N-h),m=g(N+h);return new U(g(l*m),g(D*d),g(d*m),g(l*D))}static hashToCurve(e){e=Xe(e,64);const t=Zr(e.slice(0,32)),n=this.calcElligatorRistrettoMap(t),u=Zr(e.slice(32,64)),s=this.calcElligatorRistrettoMap(u);return new Ee(n.add(s))}static fromHex(e){e=Xe(e,32);const{a:t,d:n}=z,u="RistrettoPoint.fromHex: the hex is not valid encoding of RistrettoPoint",s=Zr(e);if(!ya(nr(s),e)||Ye(s))throw new Error(u);const i=g(s*s),a=g(N+t*i),o=g(N-t*i),c=g(a*a),f=g(o*o),h=g(t*n*c-f),{isValid:l,value:d}=Xn(g(h*f)),D=g(d*o),m=g(d*D*h);let p=g((s+s)*D);Ye(p)&&(p=g(-p));const w=g(a*m),B=g(p*w);if(!l||Ye(B)||w===ne)throw new Error(u);return new Ee(new U(p,w,N,B))}toRawBytes(){let{x:e,y:t,z:n,t:u}=this.ep;const s=g(g(n+t)*g(n-t)),i=g(e*t),{value:a}=Xn(g(s*i**de)),o=g(a*s),c=g(a*i),f=g(o*c*u);let h;if(Ye(u*f)){let d=g(t*Zt),D=g(e*Zt);e=d,t=D,h=g(o*da)}else h=c;Ye(e*f)&&(t=g(-t));let l=g((n-t)*h);return Ye(l)&&(l=g(-l)),nr(l)}toHex(){return lr(this.toRawBytes())}toString(){return this.toHex()}equals(e){Yr(e);const t=this.ep,n=e.ep,u=g(t.x*n.y)===g(t.y*n.x),s=g(t.y*n.y)===g(t.x*n.x);return u||s}add(e){return Yr(e),new Ee(this.ep.add(e.ep))}subtract(e){return Yr(e),new Ee(this.ep.subtract(e.ep))}multiply(e){return new Ee(this.ep.multiply(e))}multiplyUnsafe(e){return new Ee(this.ep.multiplyUnsafe(e))}}Ee.BASE=new Ee(U.BASE);Ee.ZERO=new Ee(U.ZERO);const ln=new WeakMap;class J{constructor(e,t){this.x=e,this.y=t}_setWindowSize(e){this._WINDOW_SIZE=e,ln.delete(this)}static fromHex(e,t=!0){const{d:n,P:u}=z;e=Xe(e,32);const s=e.slice();s[31]=e[31]&-129;const i=Nt(s);if(t&&i>=u)throw new Error("Expected 0 < hex < P");if(!t&&i>=As)throw new Error("Expected 0 < hex < 2**256");const a=g(i*i),o=g(a-N),c=g(n*a+N);let{isValid:f,value:h}=Fn(o,c);if(!f)throw new Error("Point.fromHex: invalid y coordinate");const l=(h&N)===N;return(e[31]&128)!==0!==l&&(h=g(-h)),new J(h,i)}static async fromPrivateKey(e){return(await Nr(e)).point}toRawBytes(){const e=nr(this.y);return e[31]|=this.x&N?128:0,e}toHex(){return lr(this.toRawBytes())}toX25519(){const{y:e}=this,t=g((N+e)*jr(N-e));return nr(t)}isTorsionFree(){return U.fromAffine(this).isTorsionFree()}equals(e){return this.x===e.x&&this.y===e.y}negate(){return new J(g(-this.x),this.y)}add(e){return U.fromAffine(this).add(U.fromAffine(e)).toAffine()}subtract(e){return this.add(e.negate())}multiply(e){return U.fromAffine(this).multiply(e,this).toAffine()}}J.BASE=new J(z.Gx,z.Gy);J.ZERO=new J(ne,N);class rr{constructor(e,t){this.r=e,this.s=t,this.assertValidity()}static fromHex(e){const t=Xe(e,64),n=J.fromHex(t.slice(0,32),!1),u=Nt(t.slice(32,64));return new rr(n,u)}assertValidity(){const{r:e,s:t}=this;if(!(e instanceof J))throw new Error("Expected Point instance");return Tr(t,z.l,!1),this}toRawBytes(){const e=new Uint8Array(64);return e.set(this.r.toRawBytes()),e.set(nr(this.s),32),e}toHex(){return lr(this.toRawBytes())}}function ma(...r){if(!r.every(n=>n instanceof Uint8Array))throw new Error("Expected Uint8Array list");if(r.length===1)return r[0];const e=r.reduce((n,u)=>n+u.length,0),t=new Uint8Array(e);for(let n=0,u=0;n<r.length;n++){const s=r[n];t.set(s,u),u+=s.length}return t}const ga=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function lr(r){if(!(r instanceof Uint8Array))throw new Error("Uint8Array expected");let e="";for(let t=0;t<r.length;t++)e+=ga[r[t]];return e}function Cs(r){if(typeof r!="string")throw new TypeError("hexToBytes: expected string, got "+typeof r);if(r.length%2)throw new Error("hexToBytes: received invalid unpadded hex");const e=new Uint8Array(r.length/2);for(let t=0;t<e.length;t++){const n=t*2,u=r.slice(n,n+2),s=Number.parseInt(u,16);if(Number.isNaN(s)||s<0)throw new Error("Invalid byte sequence");e[t]=s}return e}function Es(r){const t=r.toString(16).padStart(64,"0");return Cs(t)}function nr(r){return Es(r).reverse()}function Ye(r){return(g(r)&N)===N}function Nt(r){if(!(r instanceof Uint8Array))throw new Error("Expected Uint8Array");return BigInt("0x"+lr(Uint8Array.from(r).reverse()))}function Zr(r){return g(Nt(r)&de**ys-N)}function g(r,e=z.P){const t=r%e;return t>=ne?t:e+t}function jr(r,e=z.P){if(r===ne||e<=ne)throw new Error(`invert: expected positive integers, got n=${r} mod=${e}`);let t=g(r,e),n=e,u=ne,s=N;for(;t!==ne;){const a=n/t,o=n%t,c=u-s*a;n=t,t=o,u=s,s=c}if(n!==N)throw new Error("invert: does not exist");return g(u,e)}function ba(r,e=z.P){const t=new Array(r.length),n=r.reduce((s,i,a)=>i===ne?s:(t[a]=s,g(s*i,e)),N),u=jr(n,e);return r.reduceRight((s,i,a)=>i===ne?s:(t[a]=g(s*t[a],e),g(s*i,e)),u),t}function _e(r,e){const{P:t}=z;let n=r;for(;e-- >ne;)n*=n,n%=t;return n}function wa(r){const{P:e}=z,t=BigInt(5),n=BigInt(10),u=BigInt(20),s=BigInt(40),i=BigInt(80),o=r*r%e*r%e,c=_e(o,de)*o%e,f=_e(c,N)*r%e,h=_e(f,t)*f%e,l=_e(h,n)*h%e,d=_e(l,u)*l%e,D=_e(d,s)*d%e,m=_e(D,i)*D%e,p=_e(m,i)*D%e,w=_e(p,n)*h%e;return{pow_p_5_8:_e(w,de)*r%e,b2:o}}function Fn(r,e){const t=g(e*e*e),n=g(t*t*e),u=wa(r*n).pow_p_5_8;let s=g(r*t*u);const i=g(e*s*s),a=s,o=g(s*Zt),c=i===r,f=i===g(-r),h=i===g(-r*Zt);return c&&(s=a),(f||h)&&(s=o),Ye(s)&&(s=g(-s)),{isValid:c||f,value:s}}function Xn(r){return Fn(N,r)}async function hn(...r){const e=await Lr.sha512(ma(...r)),t=Nt(e);return g(t,z.l)}function ya(r,e){if(r.length!==e.length)return!1;for(let t=0;t<r.length;t++)if(r[t]!==e[t])return!1;return!0}function Xe(r,e){const t=r instanceof Uint8Array?Uint8Array.from(r):Cs(r);if(typeof e=="number"&&t.length!==e)throw new Error(`Expected ${e} bytes`);return t}function Tr(r,e,t=!0){if(!e)throw new TypeError("Specify max value");if(typeof r=="number"&&Number.isSafeInteger(r)&&(r=BigInt(r)),typeof r=="bigint"&&r<e){if(t){if(ne<r)return r}else if(ne<=r)return r}throw new TypeError("Expected valid scalar: 0 < scalar < max")}function Aa(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}async function Nr(r){if(r=typeof r=="bigint"||typeof r=="number"?Es(Tr(r,As)):Xe(r),r.length!==32)throw new Error("Expected 32 bytes");const e=await Lr.sha512(r),t=Aa(e.slice(0,32)),n=e.slice(32,64),u=g(Nt(t),z.l),s=J.BASE.multiply(u),i=s.toRawBytes();return{head:t,prefix:n,scalar:u,point:s,pointBytes:i}}async function Ca(r){return(await Nr(r)).pointBytes}async function Ea(r,e){r=Xe(r);const{prefix:t,scalar:n,pointBytes:u}=await Nr(e),s=await hn(t,r),i=J.BASE.multiply(s),a=await hn(i.toRawBytes(),u,r),o=g(s+a*n,z.l);return new rr(i,o).toRawBytes()}async function Fa(r,e,t){e=Xe(e),t instanceof J||(t=J.fromHex(t,!1));const{r:n,s:u}=r instanceof rr?r.assertValidity():rr.fromHex(r),s=U.BASE.multiplyUnsafe(u),i=await hn(n.toRawBytes(),t.toRawBytes(),e),a=U.fromAffine(t).multiplyUnsafe(i);return U.fromAffine(n).add(a).subtract(s).multiplyUnsafe(z.h).equals(U.ZERO)}J.BASE._setWindowSize(8);const Ke={node:Xu,web:typeof self=="object"&&"crypto"in self?self.crypto:void 0},Lr={TORSION_SUBGROUP:["0100000000000000000000000000000000000000000000000000000000000000","c7176a703d4dd84fba3c0b760d10670f2a2053fa2c39ccc64ec7fd7792ac037a","0000000000000000000000000000000000000000000000000000000000000080","26e8958fc2b227b045c3f489f2ef98f0d5dfac05d3c63339b13802886d53fc05","ecffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff7f","26e8958fc2b227b045c3f489f2ef98f0d5dfac05d3c63339b13802886d53fc85","0000000000000000000000000000000000000000000000000000000000000000","c7176a703d4dd84fba3c0b760d10670f2a2053fa2c39ccc64ec7fd7792ac03fa"],bytesToHex:lr,getExtendedPublicKey:Nr,mod:g,invert:jr,hashToPrivateScalar:r=>{if(r=Xe(r),r.length<40||r.length>1024)throw new Error("Expected 40-1024 bytes of private key as per FIPS 186");const e=g(Nt(r),z.l);if(e===ne||e===N)throw new Error("Invalid private key");return e},randomBytes:(r=32)=>{if(Ke.web)return Ke.web.getRandomValues(new Uint8Array(r));if(Ke.node){const{randomBytes:e}=Ke.node;return new Uint8Array(e(r).buffer)}else throw new Error("The environment doesn't have randomBytes function")},randomPrivateKey:()=>Lr.randomBytes(32),sha512:async r=>{if(Ke.web){const e=await Ke.web.subtle.digest("SHA-512",r.buffer);return new Uint8Array(e)}else{if(Ke.node)return Uint8Array.from(Ke.node.createHash("sha512").update(r).digest());throw new Error("The environment doesn't have sha512 function")}},precompute(r=8,e=J.BASE){const t=e.equals(J.BASE)?e:new J(e.x,e.y);return t._setWindowSize(r),t.multiply(de),t}};var T=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},Z=function(r,e,t,n,u){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!u)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!u:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?u.call(r,t):u?u.value=t:e.set(r,t),t},Ne,Le,Ue,$e,He,qe,at,ae;const Y=11400714785074694791n,ue=14029467366897019727n,Zn=1609587929392839161n,Ht=9650029242287828579n,Jn=2870177450012600261n,Fs=64n,va=2n**Fs-1n,Ba=new Cn;function eu(r,e,t,n){return BigInt(r)|BigInt(e)<<16n|BigInt(t)<<32n|BigInt(n)<<48n}function Me(r,e){return BigInt(r[e])|BigInt(r[e+1])<<8n|BigInt(r[e+2])<<16n|BigInt(r[e+3])<<24n|BigInt(r[e+4])<<32n|BigInt(r[e+5])<<40n|BigInt(r[e+6])<<48n|BigInt(r[e+7])<<56n}function ee(r,e){return r<<e&va|r>>Fs-e}function P(r){return BigInt.asUintN(64,r)}class vn{constructor(e=0){Ne.set(this,void 0),Le.set(this,void 0),Ue.set(this,void 0),$e.set(this,void 0),He.set(this,void 0),qe.set(this,void 0),at.set(this,void 0),ae.set(this,void 0),this.reset(e)}reset(e=T(this,Ne,"f")){return Z(this,Ne,BigInt.asUintN(32,BigInt(e)),"f"),Z(this,Le,P(T(this,Ne,"f")+Y+ue),"f"),Z(this,Ue,P(T(this,Ne,"f")+ue),"f"),Z(this,$e,T(this,Ne,"f"),"f"),Z(this,He,P(T(this,Ne,"f")-Y),"f"),Z(this,qe,null,"f"),Z(this,at,0,"f"),Z(this,ae,0,"f"),this}update(e){typeof e=="string"&&(e=Ba.encode(e));let t=0,n=e.length,u=t+n;if(n===0)return this;if(Z(this,at,T(this,at,"f")+n,"f"),T(this,ae,"f")===0&&Z(this,qe,new Uint8Array(32),"f"),T(this,ae,"f")+n<32)return T(this,qe,"f").set(e.subarray(0,n),T(this,ae,"f")),Z(this,ae,T(this,ae,"f")+n,"f"),this;if(T(this,ae,"f")>0){T(this,qe,"f").set(e.subarray(0,32-T(this,ae,"f")),T(this,ae,"f"));let s=0,i;i=Me(T(this,qe,"f"),s),Z(this,Le,P(ee(P(T(this,Le,"f")+i*ue),31n)*Y),"f"),s+=8,i=Me(this.memory,s),Z(this,Ue,P(ee(P(T(this,Ue,"f")+i*ue),31n)*Y),"f"),s+=8,i=Me(this.memory,s),Z(this,$e,P(ee(P(T(this,$e,"f")+i*ue),31n)*Y),"f"),s+=8,i=Me(this.memory,s),Z(this,He,P(ee(P(T(this,He,"f")+i*ue),31n)*Y),"f"),t+=32-T(this,ae,"f"),Z(this,ae,0,"f")}if(t<=u-32){const s=u-32;do{let i;i=Me(e,t),Z(this,Le,P(ee(P(T(this,Le,"f")+i*ue),31n)*Y),"f"),t+=8,i=Me(e,t),Z(this,Ue,P(ee(P(T(this,Ue,"f")+i*ue),31n)*Y),"f"),t+=8,i=Me(e,t),Z(this,$e,P(ee(P(T(this,$e,"f")+i*ue),31n)*Y),"f"),t+=8,i=Me(e,t),Z(this,He,P(ee(P(T(this,He,"f")+i*ue),31n)*Y),"f"),t+=8}while(t<=s)}return t<u&&(T(this,qe,"f").set(e.subarray(t,u),T(this,ae,"f")),Z(this,ae,u-t,"f")),this}digest(){let e=T(this,qe,"f"),t=T(this,ae,"f"),n=0,u=0n,s=0n,i=0n;for(T(this,at,"f")>=32?(u=ee(T(this,Le,"f"),1n)+ee(T(this,Ue,"f"),7n)+ee(T(this,$e,"f"),12n)+ee(T(this,He,"f"),18n),u=P(u^ee(P(T(this,Le,"f")*ue),31n)*Y),u=P(u*Y+Ht),u=P(u^ee(P(T(this,Ue,"f")*ue),31n)*Y),u=P(u*Y+Ht),u=P(u^ee(P(T(this,$e,"f")*ue),31n)*Y),u=P(u*Y+Ht),u=P(u^ee(P(T(this,He,"f")*ue),31n)*Y),u=P(u*Y+Ht)):u=P(T(this,Ne,"f")+Jn),u+=BigInt(T(this,at,"f"));n<=t-8;)i=Me(e,n),i=P(ee(P(i*ue),31n)*Y),u=P(ee(u^i,27n)*Y+Ht),n+=8;for(n+4<=t&&(i=eu(e[n+1]<<8|e[n],e[n+3]<<8|e[n+2],0,0),u=P(ee(u^P(i*Y),23n)*ue+Zn),n+=4);n<t;)i=eu(e[n++],0,0,0),u=P(ee(u^P(i*Jn),11n)*Y);return s=P(u>>33n),u=P((u^s)*ue),s=P(u>>29n),u=P((u^s)*Zn),s=P(u>>32n),u=P(u^s),u}}Ne=new WeakMap,Le=new WeakMap,Ue=new WeakMap,$e=new WeakMap,He=new WeakMap,qe=new WeakMap,at=new WeakMap,ae=new WeakMap;function Sa(r,e=0){return new vn(e).update(r).digest()}function vs(r,e){return r<e?-1:r>e?1:0}class ot{constructor(e,t){Object.defineProperty(this,"parent",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"left",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"right",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.left=null,this.right=null}static from(e){const t=new ot(e.parent,e.value);return t.left=e.left,t.right=e.right,t}directionFromParent(){return this.parent===null?null:this===this.parent.left?"left":this===this.parent.right?"right":null}findMinNode(){let e=this.left;for(;e!=null&&e.left;)e=e.left;return e??this}findMaxNode(){let e=this.right;for(;e!=null&&e.right;)e=e.right;return e??this}findSuccessorNode(){if(this.right!==null)return this.right.findMinNode();let e=this.parent,t=this.directionFromParent();for(;e&&t==="right";)t=e.directionFromParent(),e=e.parent;return e}}class St{constructor(e=vs){Object.defineProperty(this,"compare",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"root",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"_size",{enumerable:!0,configurable:!0,writable:!0,value:0})}static from(e,t){let n,u=[];if(e instanceof St)if(n=new St((t==null?void 0:t.compare)??e.compare),t!=null&&t.compare||t!=null&&t.map)u=e;else{const i=[];for(e.root&&(n.root=ot.from(e.root),i.push(n.root));i.length;){const a=i.pop(),o=a.left?ot.from(a.left):null,c=a.right?ot.from(a.right):null;o&&(o.parent=a,i.push(o)),c&&(c.parent=a,i.push(c))}}else n=t!=null&&t.compare?new St(t.compare):new St,u=e;const s=t!=null&&t.map?Array.from(u,t.map,t.thisArg):u;for(const i of s)n.insert(i);return n}get size(){return this._size}findNode(e){let t=this.root;for(;t;){const n=this.compare(e,t.value);if(n===0)break;const u=n<0?"left":"right";t=t[u]}return t}rotateNode(e,t){const n=t==="left"?"right":"left";if(!e[n])throw new TypeError(`cannot rotate ${t} without ${n} child`);const u=e[n];if(e[n]=u[t]??null,u[t]&&(u[t].parent=e),u.parent=e.parent,e.parent){const s=e===e.parent[t]?t:n;e.parent[s]=u}else this.root=u;u[t]=e,e.parent=u}insertNode(e,t){if(this.root){let n=this.root;for(;;){const u=this.compare(t,n.value);if(u===0)break;const s=u<0?"left":"right";if(n[s])n=n[s];else return n[s]=new e(n,t),this._size++,n[s]}}else return this.root=new e(null,t),this._size++,this.root;return null}removeNode(e){let t=this.findNode(e);if(t){const n=!t.left||!t.right?t:t.findSuccessorNode(),u=n.left??n.right;u&&(u.parent=n.parent),n.parent?n.parent[n.directionFromParent()]=u:this.root=u,n!==t&&(t.value=n.value,t=n),this._size--}return t}insert(e){return!!this.insertNode(ot,e)}remove(e){return!!this.removeNode(e)}find(e){var t;return((t=this.findNode(e))==null?void 0:t.value)??null}min(){return this.root?this.root.findMinNode().value:null}max(){return this.root?this.root.findMaxNode().value:null}clear(){this.root=null,this._size=0}isEmpty(){return this.size===0}*lnrValues(){const e=[];let t=this.root;for(;e.length||t;)t?(e.push(t),t=t.left):(t=e.pop(),yield t.value,t=t.right)}*rnlValues(){const e=[];let t=this.root;for(;e.length||t;)t?(e.push(t),t=t.right):(t=e.pop(),yield t.value,t=t.left)}*nlrValues(){const e=[];for(this.root&&e.push(this.root);e.length;){const t=e.pop();yield t.value,t.right&&e.push(t.right),t.left&&e.push(t.left)}}*lrnValues(){const e=[];let t=this.root,n=null;for(;e.length||t;)if(t)e.push(t),t=t.left;else{const u=e[e.length-1];u.right&&u.right!==n?t=u.right:(yield u.value,n=e.pop())}}*lvlValues(){const e=[];let t=this.root;for(;t;)yield t.value,t.left&&e.push(t.left),t.right&&e.push(t.right),t=e.shift()??null}*[Symbol.iterator](){yield*this.lnrValues()}}class ct extends ot{constructor(e,t){super(e,t),Object.defineProperty(this,"red",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.red=!0}static from(e){const t=new ct(e.parent,e.value);return t.left=e.left,t.right=e.right,t.red=e.red,t}}class xt extends St{constructor(e=vs){super(e)}static from(e,t){let n,u=[];if(e instanceof xt)if(n=new xt((t==null?void 0:t.compare)??e.compare),t!=null&&t.compare||t!=null&&t.map)u=e;else{const i=[];for(e.root&&(n.root=ct.from(e.root),i.push(n.root));i.length;){const a=i.pop(),o=a.left?ct.from(a.left):null,c=a.right?ct.from(a.right):null;o&&(o.parent=a,i.push(o)),c&&(c.parent=a,i.push(c))}}else n=t!=null&&t.compare?new xt(t.compare):new xt,u=e;const s=t!=null&&t.map?Array.from(u,t.map,t.thisArg):u;for(const i of s)n.insert(i);return n}removeFixup(e,t){var n,u,s;for(;e&&!(t!=null&&t.red);){const i=e.left===t?"left":"right",a=i==="right"?"left":"right";let o=e[a];o!=null&&o.red&&(o.red=!1,e.red=!0,this.rotateNode(e,i),o=e[a]),o&&(!((n=o.left)!=null&&n.red)&&!((u=o.right)!=null&&u.red)?(o.red=!0,t=e,e=t.parent):((s=o[a])!=null&&s.red||(o[i].red=!1,o.red=!0,this.rotateNode(o,a),o=e[a]),o.red=e.red,e.red=!1,o[a].red=!1,this.rotateNode(e,i),t=this.root,e=null))}t&&(t.red=!1)}insert(e){var n;let t=this.insertNode(ct,e);if(t){for(;(n=t.parent)!=null&&n.red;){let u=t.parent;const s=u.directionFromParent(),i=s==="right"?"left":"right",a=u.parent[i]??null;a!=null&&a.red?(u.red=!1,a.red=!1,u.parent.red=!0,t=u.parent):(t===u[i]&&(t=u,this.rotateNode(t,s),u=t.parent),u.red=!1,u.parent.red=!0,this.rotateNode(u.parent,i))}this.root.red=!1}return!!t}remove(e){const t=this.removeNode(e);return t&&!t.red&&this.removeFixup(t.parent,t.left??t.right),!!t}}function Jr(r,e){return{lift:t=>[r.lift(t),e.lift(t)],combine:(t,n)=>{const u=r.combine(t[0],n[0]),s=e.combine(t[1],n[1]);return[u,s]},neutral:[r.neutral,e.neutral]}}const xa={lift:r=>1,combine:(r,e)=>r+e,neutral:0};class tu extends ct{constructor(e,t,n){super(e,t),Object.defineProperty(this,"label",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"liftedValue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"monoid",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.label=n.neutral,this.liftedValue=n.lift(t),this.monoid=n}updateLabel(e=!0,t){var n;this.left!==null&&this.right===null?this.label=this.monoid.combine(this.left.label,this.liftedValue):this.left===null&&this.right!==null?this.label=this.monoid.combine(this.liftedValue,this.right.label):this.left&&this.right?this.label=this.monoid.combine(this.left.label,this.monoid.combine(this.liftedValue,this.right.label)):this.label=this.liftedValue,e&&((n=this.parent)==null||n.updateLabel(!0,"Updated by child"))}}class _a extends xt{constructor(e,t){super(t),Object.defineProperty(this,"monoid",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cachedMinNode",{enumerable:!0,configurable:!0,writable:!0,value:null});const s=Jr({lift:i=>[i],combine:(i,a)=>i.concat(a),neutral:[]},{lift:i=>i,combine:(i,a)=>{if(!(i===void 0&&a===void 0))return a===void 0?i:i===void 0?a:t(i,a)>0?i:a},neutral:void 0});this.monoid=Jr(e,Jr(xa,s))}getLowestValue(){if(!this.root)throw new Error("Can't get a range from a tree with no items");return this.cachedMinNode?this.cachedMinNode.value:this.root.findMinNode().value}rotateNode(e,t){var s;const n=t==="left"?"right":"left";if(!e[n])throw new TypeError(`cannot rotate ${t} without ${n} child`);const u=e[n];if(e[n]=u[t]??null,u[t]&&(u[t].parent=e),u.parent=e.parent,e.parent){const i=e===e.parent[t]?t:n;e.parent[i]=u}else this.root=u;u[t]=e,e.parent=u,(s=u[t])==null||s.updateLabel(!1,"Node rotated")}removeFixup(e,t){var n,u,s;for(;e&&!(t!=null&&t.red);){const i=e.left===t?"left":"right",a=i==="right"?"left":"right";let o=e[a];o!=null&&o.red&&(o.red=!1,e.red=!0,this.rotateNode(e,i),o=e[a]),o&&(!((n=o.left)!=null&&n.red)&&!((u=o.right)!=null&&u.red)?(o.red=!0,t=e,e=t.parent):((s=o[a])!=null&&s.red||(o[i].red=!1,o.red=!0,this.rotateNode(o,a),o=e[a]),o.red=e.red,e.red=!1,o[a].red=!1,this.rotateNode(e,i),t=this.root,e=null))}t&&(t.red=!1)}insertFingerprintNode(e){if(this.root){let t=this.root,n=!0;for(;;){const u=this.compare(e,t.value);if(u===0){n=!1;break}const s=u<0?"left":"right";if(n&&s==="right"&&(n=!1),t[s])t=t[s];else return t[s]=new tu(t,e,this.monoid),this._size++,n&&(this.cachedMinNode=t[s]),t[s]}}else return this.root=new tu(null,e,this.monoid),this._size++,this.cachedMinNode=this.root,this.root;return null}insert(e){var u;const t=this.insertFingerprintNode(e);let n=t;if(n){for(;(u=n.parent)!=null&&u.red;){let s=n.parent;const i=s.directionFromParent(),a=i==="right"?"left":"right",o=s.parent[a]??null;o!=null&&o.red?(s.red=!1,o.red=!1,s.parent.red=!0,n=s.parent):(n===s[a]&&(n=s,this.rotateNode(n,i),s=n.parent),s.red=!1,s.parent.red=!0,this.rotateNode(s.parent,a))}this.root.red=!1}return t==null||t.updateLabel(!0,"Node inserted"),!!n}remove(e){var n;const t=this.removeNode(e);return t&&!t.red&&this.removeFixup(t.parent,t.left??t.right),t&&((n=t.parent)==null||n.updateLabel(!0,"Child node removed")),!!t}getFingerprint(e,t,n){if(this.root===null)return{fingerprint:this.monoid.neutral[0],size:0,items:[],nextTree:null};const u=this.compare(e,t);if(u===0)return{fingerprint:this.root.label[0],size:this.root.label[1][0],items:this.root.label[1][1][0],nextTree:this.cachedMinNode};if(u<0){const s=this.compare(e,this.cachedMinNode.value)<=0?this.cachedMinNode:null,i=n||s||this.findGteNode(e),{label:a,nextTree:o}=this.aggregateUntil(i,e,t);return{fingerprint:a[0],size:a[1][0],items:a[1][1][0],nextTree:o}}else{const s=this.cachedMinNode,i=this.root.label[1][1][1],a=this.compare(t,s.value)>0,o=this.compare(e,i)<=0;if(a&&o){const{label:c,nextTree:f}=this.aggregateUntil(s,s.value,t),l=[this.monoid.lift(i)[0],[1,[[i],i]]],d=n||this.findGteNode(e),{label:D}=this.aggregateUntil(d,e,i),m=this.monoid.combine(D,l),p=this.monoid.combine(c,m);return{fingerprint:p[0],size:p[1][0],items:p[1][1][0],nextTree:f}}else if(a){const{label:c,nextTree:f}=this.aggregateUntil(s,s.value,t);return{fingerprint:c[0],size:c[1][0],items:c[1][1][0],nextTree:f}}else{const c=this.compare(e,this.cachedMinNode.value)<=0?this.cachedMinNode:null,f=n||c||this.findGteNode(e),{label:h}=this.aggregateUntil(f,e,i),d=[this.monoid.lift(i)[0],[1,[[i],i]]],D=this.monoid.combine(h,d);return{fingerprint:D[0],size:D[1][0],items:D[1][1][0],nextTree:c}}}}findGteNode(e){let t=this.root;for(;t;){const n=this.compare(e,t.value);if(n===0)break;const u=n<0?"left":"right";if(t[u])t=t[u];else break}return t}aggregateUntil(e,t,n){const{label:u,nextTree:s}=this.aggregateUp(e,t,n);return s===null||this.compare(s.value,n)>=0?{label:u,nextTree:s}:this.aggregateDown(s.right,n,this.monoid.combine(u,s.liftedValue))}aggregateUp(e,t,n){var i;let u=this.monoid.neutral,s=e;for(;this.compare(s.label[1][1][1],n)<0;){if(this.compare(s.value,t)>=0&&(u=this.monoid.combine(u,this.monoid.combine(s.liftedValue,((i=s.right)==null?void 0:i.label)||this.monoid.neutral))),s.parent===null)return{label:u,nextTree:null};s=s.parent}return{label:u,nextTree:s}}aggregateDown(e,t,n){var i,a;let u=e,s=n;for(;u!==null;)if(this.compare(u.value,t)<0)s=this.monoid.combine(s,this.monoid.combine(((i=u.left)==null?void 0:i.label)||this.monoid.neutral,u.liftedValue)),u=u.right;else{if(u.left===null||this.compare(u.label[1][1][1],t)<0)return{label:this.monoid.combine(s,((a=u.left)==null?void 0:a.label)||this.monoid.neutral),nextTree:u};u=u.left}return{label:s,nextTree:null}}isValueEqual(e,t){return this.compare(e,t)===0}}function ka(){let r,e="pending";const t=new Promise((n,u)=>{r={async resolve(s){await s,e="fulfilled",n(s)},reject(s){e="rejected",u(s)}}});return Object.defineProperty(t,"state",{get:()=>e}),Object.assign(t,r)}class Pa{constructor(){Object.defineProperty(this,"deferreds",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:"pending"})}resolve(e){if(this.state==="pending"){this.state="fulfilled";for(const t of this.deferreds)t.resolve(e)}}reject(e){if(this.state==="pending"){this.state="rejected";for(const t of this.deferreds)t.reject(e)}}tee(){const e=ka();return this.state==="fulfilled"?e.resolve():this.state==="rejected"?e.reject():this.deferreds.add(e),e}}class Ta{constructor(e){Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"isDoneTee",{enumerable:!0,configurable:!0,writable:!0,value:new Pa}),Object.defineProperty(this,"insertionCallbacks",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"fingerprintEquals",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"payloadThreshold",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"rangeDivision",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lowerBoundFromPrev",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"collatedPayload",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"collatePayloads",{enumerable:!0,configurable:!0,writable:!0,value:t=>{switch(t.type){case"payload":{let n=this.collatedPayload;if(n===null&&(n={type:"payload",lowerBound:t.lowerBound,payload:[],end:{canRespond:!1,upperBound:t.payload}}),n.payload.push(t.payload),this.collatedPayload=n,t.end)return t.end.upperBound?n.end=t.end:n.end={...t.end,upperBound:t.payload},this.collatedPayload=null,n;break}default:return this.collatedPayload&&(this.collatedPayload=null),t}}}),Object.defineProperty(this,"reusableTree",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lastAdjacentDoneUpperBound",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"isDoneSoFar",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.tree=e.tree,this.fingerprintEquals=e.fingerprintEquals,this.encoding=e.encoding,this.payloadThreshold=e.payloadThreshold,this.rangeDivision=e.rangeDivision}decode(e){const t=this.lowerBoundFromPrev;try{switch(this.encoding.decode.getType(e)){case"payload":{const u=this.encoding.decode.payload(e);return u.end&&(this.lowerBoundFromPrev=u.end.upperBound),{type:"payload",lowerBound:t,payload:u.value,...u.end?{end:u.end}:{}}}case"fingerprint":{const u=this.encoding.decode.fingerprint(e);return this.lowerBoundFromPrev=u.upperBound,{type:"fingerprint",lowerBound:t,fingerprint:u.fingerprint,upperBound:u.upperBound}}case"emptyPayload":{const u=this.encoding.decode.emptyPayload(e);return this.lowerBoundFromPrev=u,{lowerBound:t,type:"emptyPayload",upperBound:u}}case"done":{const u=this.encoding.decode.done(e);return this.lowerBoundFromPrev=u,{lowerBound:t,type:"done",upperBound:u}}case"emptySet":return{type:"emptySet",canRespond:this.encoding.decode.emptySet(e)};case"lowerBound":{const u=this.encoding.decode.lowerBound(e);return this.lowerBoundFromPrev=u,{type:"lowerBound",value:u}}case"terminal":return this.encoding.decode.terminal(e),{type:"terminal"}}}catch(n){console.group("range-reconcile: Could not decode message"),console.warn(e),console.warn(n)}return null}setReusableTree(e){this.reusableTree=e||void 0}process(e){const t=this.reusableTree;switch(e.type){case"lowerBound":case"terminal":case"done":return this.setReusableTree(null),[e];case"emptySet":{if(e.canRespond===!1&&this.isDoneTee.resolve(),this.tree.size===0)return[{type:"emptySet",canRespond:!1}];const n=this.tree.getLowestValue(),u=[{type:"lowerBound",value:n}],{items:s}=this.tree.getFingerprint(n,n);for(let i=0;i<s.length;i++){const a=s[i];i===s.length-1?u.push({type:"payload",payload:a,end:{upperBound:n,canRespond:!1}}):u.push({type:"payload",payload:a})}return u.push({type:"terminal"}),u}case"fingerprint":{const{fingerprint:n,size:u,items:s,nextTree:i}=this.tree.getFingerprint(e.lowerBound,e.upperBound,t);if(this.setReusableTree(i),this.fingerprintEquals(n,e.fingerprint))return[{type:"done",upperBound:e.upperBound}];if(u<=this.payloadThreshold){if(u===0)return[{type:"emptyPayload",upperBound:e.upperBound}];const a=[];for(let o=0;o<u;o++)a.push({type:"payload",payload:s[o],...o===s.length-1?{end:{upperBound:e.upperBound,canRespond:!0}}:{}});return a}else{const a=Math.ceil(u/this.rangeDivision),o=[];if(a<=this.payloadThreshold){for(let l=0;l<s.length;l++)o.push({type:"payload",payload:s[l],...l===s.length-1?{end:{upperBound:e.upperBound,canRespond:!0}}:{}});return o}let c;const f=s;let h=!1;if(e.lowerBound>=e.upperBound){let l=0;for(let d=0;d<=s.length;d++)if(s[d]>=e.lowerBound){l=d;break}if(l>0){const d=f.splice(0,l);f.push(...d),h=!0}}for(let l=0;l<u;l+=a){const d=f[l],D=f[l+a]||e.upperBound,{fingerprint:m,nextTree:p}=this.tree.getFingerprint(d,D,c);c=h?void 0:p||void 0,o.push({type:"fingerprint",fingerprint:m,upperBound:D})}return o}}case"payload":{for(const n of e.payload){this.tree.insert(n);for(const u of this.insertionCallbacks)u(n)}if(e.end.canRespond){const{items:n,size:u,nextTree:s}=this.tree.getFingerprint(e.lowerBound,e.end.upperBound,t);if(this.setReusableTree(s),u===0)return[{type:"emptyPayload",upperBound:e.end.upperBound}];const i=[];for(let o=0;o<u;o++){let c=!1;for(let f=0;f<e.payload.length;f++)this.tree.isValueEqual(n[o],e.payload[f])&&(c=!0);c||i.push({type:"payload",payload:n[o]})}const a=i[i.length-1];return i[i.length-1]={...a,end:{upperBound:e.end.upperBound,canRespond:!1}},i}else return this.setReusableTree(null),[{type:"done",upperBound:e.end.upperBound}]}case"emptyPayload":{this.setReusableTree(null);const{items:n,size:u,nextTree:s}=this.tree.getFingerprint(e.lowerBound,e.upperBound);if(this.setReusableTree(s),u===0)return this.setReusableTree(null),[];const i=[];for(let a=0;a<u;a++)i.push({type:"payload",payload:n[a],...a===n.length-1?{end:{upperBound:e.upperBound,canRespond:!1}}:{}});return i}}}consolidateAdjacentDones(e){switch(e.type){case"done":{this.lastAdjacentDoneUpperBound=e.upperBound;break}default:{const t=this.lastAdjacentDoneUpperBound;return t?(this.lastAdjacentDoneUpperBound=null,[{type:"done",upperBound:t},e]):[e]}}}checkIsDone(e){var t;if(this.isDoneTee.state==="pending")switch(e.type){case"emptySet":{e.canRespond&&(this.isDoneSoFar=!1);break}case"lowerBound":break;case"fingerprint":this.isDoneSoFar=!1;break;case"emptyPayload":this.isDoneSoFar=!1;break;case"payload":((t=e.end)==null?void 0:t.canRespond)===!0&&(this.isDoneSoFar=!1);break;case"terminal":this.isDoneSoFar?this.isDoneTee.resolve():this.isDoneSoFar=!0}}encode(e){let t;switch(e.type){case"emptySet":{t=this.encoding.encode.emptySet(e.canRespond);break}case"lowerBound":{t=this.encoding.encode.lowerBound(e.value);break}case"done":{t=this.encoding.encode.done(e.upperBound);break}case"fingerprint":{t=this.encoding.encode.fingerprint(e.fingerprint,e.upperBound);break}case"payload":{t=this.encoding.encode.payload(e.payload,e.end);break}case"emptyPayload":{t=this.encoding.encode.emptyPayload(e.upperBound);break}case"terminal":{t=this.encoding.encode.terminal();break}}return t}respond(e){if(this.isDone().state==="fulfilled")return[];const t=this.decode(e),n=this.collatePayloads(t);if(n===void 0)return[];const u=this.process(n),s=[];for(const a of u){const o=this.consolidateAdjacentDones(a);o&&s.push(...o)}for(const a of s)this.checkIsDone(a);const i=[];for(const a of s)i.push(this.encode(a));return i}isDone(){return this.isDoneTee.tee()}initialMessages(e){const{tree:t,encoding:n,payloadThreshold:u,rangeDivision:s}=this;function*i(){if(t.size===0){yield n.encode.emptySet(!0);return}const a=t.getLowestValue();yield n.encode.lowerBound(a);const{items:c}=t.getFingerprint(a,a),h=(e||(D=>{const m=Math.ceil(D.length/s),p=[];for(let w=0;w<D.length;w+=m){const B=D.slice(w,w+m);p.push(B)}return p}))(c);let l;for(let D=0;D<h.length;D++){const m=h[D+1]?h[D+1][0]:a,p=h[D];if(p.length<=u)for(let w=0;w<p.length;w++)yield n.encode.payload(p[w],w===p.length-1?{upperBound:m,canRespond:!0}:void 0);else{const w=p[0],{fingerprint:B,nextTree:k}=t.getFingerprint(w,m,l);l=k||void 0,yield n.encode.fingerprint(B,m)}}yield n.encode.terminal()}return i()}onInsertion(e){return this.insertionCallbacks.add(e),()=>{this.insertionCallbacks.delete(e)}}}var se=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},Dr=function(r,e,t,n,u){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!u)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!u:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?u.call(r,t):u?u.value=t:e.set(r,t),t},tt,rt,qt,je,en,pr;const ru=Symbol("Stream ended."),tn=Symbol("Stream errored.");class Ve{constructor(e){var t,n,u;tt.add(this),rt.set(this,[]),qt.set(this,null),je.set(this,void 0),Object.defineProperty(this,"push",{enumerable:!0,configurable:!0,writable:!0,value:(...s)=>{s.length?se(this,tt,"m",pr).call(this,!1,s):(se(this,tt,"m",pr).call(this,!1,[tn]),se(this,tt,"m",en).call(this,new Error("AsyncQueueError: queue.push was called with no arguments")))}}),Object.defineProperty(this,"close",{enumerable:!0,configurable:!0,writable:!0,value:({immediately:s=!1,withError:i}={})=>{i&&se(this,tt,"m",en).call(this,i),se(this,tt,"m",pr).call(this,s,[i?tn:ru]),this.push=this.close=()=>{}}}),(u=(n=(t=e==null?void 0:e.catch)==null?void 0:t.call(e,s=>this.close({withError:s})))==null?void 0:n.finally)==null||u.call(n,()=>this.close())}get length(){return se(this,rt,"f").length}async*[(rt=new WeakMap,qt=new WeakMap,je=new WeakMap,tt=new WeakSet,en=function(t){se(this,je,"f")instanceof AggregateError?se(this,je,"f").errors.push(t):se(this,je,"f")?Dr(this,je,new AggregateError([se(this,je,"f"),t]),"f"):Dr(this,je,t,"f")},pr=function(t,n){var u;se(this,rt,"f")[t?"unshift":"push"](...n),(u=se(this,qt,"f"))==null||u.call(this,se(this,rt,"f").shift()),Dr(this,qt,null,"f")},Symbol.asyncIterator)](){for(;;){const e=se(this,rt,"f").length?se(this,rt,"f").shift():await new Promise(t=>{Dr(this,qt,t,"f")});if(e===tn)throw se(this,je,"f");if(e===ru)break;yield e}}}function _(){let r,e="pending";const t=new Promise((n,u)=>{r={async resolve(s){await s,e="fulfilled",n(s)},reject(s){e="rejected",u(s)}}});return Object.defineProperty(t,"state",{get:()=>e}),Object.assign(t,r)}new ts;const Ia=new Cn;function fn(r){return Ia.encode(r)}function Oa(r){return fn(r).length}function dn(r,e){for(let t of r)if(e.indexOf(t)===-1)return!1;return!0}function nu(r){return r===""?!1:Ur.indexOf(r)!==-1}const hr="abcdefghijklmnopqrstuvwxyz",Ra=hr.toUpperCase(),Ur="0123456789",Pe=hr+"234567",Bs=hr+Ur,Ma=Pe,Ss=Bs+Pe+"@.",xs=hr+Ur,ja=Pe,_s=xs+Pe+"+.",Na="/'()-._~!$&+,:=@%",ks=hr+Ra+Ur+Na;function La(r,e){return`@${r}.${e}`}function Ua(r,e){return`+${r}.${e}`}function Bn(r){const e=Ps(r);return Gu(e)?!0:e}function bt(r){const e=Sn(r);return Gu(e)?!0:e}function Dn(r){return r.startsWith("@")?Ps(r):r.startsWith("+")?Sn(r):new b("address must start with either @ or +")}function Ps(r){return Ts(r,{sigil:"@",separator:".",minNameLength:4,maxNameLength:4,minPubkeyLength:53,maxPubkeyLength:53,allowedNameCharacters:Bs,allowedPubkeyCharacters:Ma,pubkeyMustStartWithB:!0})}function Sn(r){return Ts(r,{sigil:"+",separator:".",minNameLength:1,maxNameLength:15,minPubkeyLength:53,maxPubkeyLength:53,allowedNameCharacters:xs,allowedPubkeyCharacters:ja,pubkeyMustStartWithB:!0})}function Ts(r,e){const{sigil:t,separator:n,minNameLength:u,maxNameLength:s,minPubkeyLength:i,maxPubkeyLength:a,allowedNameCharacters:o,allowedPubkeyCharacters:c,pubkeyMustStartWithB:f}=e;if(typeof r!="string")return new b("address must be a string");if(r.length<4)return new b("address is too short");if(r[0]!==t)return new b(`address must start with a sigil: "${t}"`);if(r.indexOf(n)===-1)return new b(`address must contain a separator character: "${n}"`);const h=r.slice(1).split(n);if(h.length!==2)return new b(`address must have exactly 2 parts separated by a "${n}" separator`);const[l,d]=h;return l.length<u||l.length>s?new b(`name must be between ${u} and ${s} characters long, but is ${l.length}`):d.length<i||d.length>a?new b(`pubkey must be between ${i} and ${a} characters long, but is ${d.length}`):dn(l,o)?dn(d,c)?nu(l[0])?new b(`name "${l}" must not start with a digit`):nu(d[0])?new b(`pubkey "${d}" must not start with a digit`):f&&d[0]!=="b"?new b(`pubkey "${d}" must start with 'b'`):{address:r,name:l,pubkey:d}:new b(`pubkey "${d}" must only have allowed characters`):new b(`name "${l}" must only have allowed characters`)}function xn(r){return!(Object.prototype.toString.call(r)!=="[object Object]"||(""+r.constructor).startsWith("class"))}function Is(r){return e=>e!==r?`expected literal value ${JSON.stringify(r)}`:null}function me(r={}){return e=>{if(r.optional!==!0&&e===void 0)return"required";if(r.optional===!0&&e===void 0)return null;let t=Oa(e);return typeof e!="string"?"expected a string but got "+JSON.stringify(e):r.minLen!==void 0&&t<r.minLen?`string shorter than min length of ${r.minLen} chars`:r.maxLen!==void 0&&t>r.maxLen?`string shorter than max length of ${r.maxLen} chars`:r.len!==void 0&&t!==r.len?`string does not have required length of ${r.len} chars: ${e}`:r.allowedChars!==void 0&&!dn(e,r.allowedChars)?"contains disallowed characters":null}}function Jt(r={}){return e=>r.optional!==!0&&e===void 0?"required":r.optional===!0&&e===void 0?null:r.nullable!==!0&&e===null?"not nullable":r.nullable===!0&&e===null?null:typeof e!="number"?"expected a number but got "+JSON.stringify(e):isNaN(e)?"is NaN":isFinite(e)?e!==Math.round(e)?"expected an integer":r.min!==void 0&&e<r.min?`integer too small (must be >= ${r.min})`:r.max!==void 0&&e>r.max?`integer too large (must be <= ${r.max})`:null:"is Infinity"}function Os(r={}){return r.allowLiteralUndefined=r.allowLiteralUndefined??!1,r.allowExtraKeys=r.allowExtraKeys??!1,e=>{if(!xn(e))return"expected an object";if(r.allowLiteralUndefined===!1){for(let[t,n]of Object.entries(e))if(n===void 0)return`${t} is explicitly set to undefined but should be missing instead`}if(r.objSchema!==void 0){if(r.allowExtraKeys===!1){let t=Object.keys(e),n=Object.keys(r.objSchema),u=t.filter(s=>n.indexOf(s)===-1);if(u.length>0)return`object has extra keys not in the schema: ${u.join(", ")}`}for(let[t,n]of Object.entries(r.objSchema)){let u=n(e[t]);if(u!==null)return`${t}: ${u}`}}return null}}const{codec:Rs}=Ji,Ms={chars:"abcdefghijklmnopqrstuvwxyz234567",bits:5};function At(r){return"b"+Rs.stringify(r,Ms,{pad:!1})}function Ir(r){if(!r.startsWith("b"))throw new b("can't decode base32 string - it should start with a 'b'. "+r);if(r[r.length-1]==="=")throw new b("can't decode base32 string - it contains padding characters ('=')");return Rs.parse(r.slice(1),Ms,{loose:!0})}var We;(function(r){r[r.None=-1]="None",r[r.Error=0]="Error",r[r.Warn=1]="Warn",r[r.Log=2]="Log",r[r.Info=3]="Info",r[r.Debug=4]="Debug"})(We||(We={}));const $a=We.Error;let rn={_default:$a};function Ha(r){return r in rn?rn[r]:rn._default}class ce{constructor(e,t){Object.defineProperty(this,"source",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"color",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.source=e,this.color=t||"aqua"}_print(e,t,n,...u){if(e<=Ha(this.source))if(t){const s=`[${this.source}]`;if(this.color!==void 0){const i=[`%c ${s}`,`color: ${this.color}`];console.log(n,...i,...u)}else console.log(n,s,...u)}else console.log(n,...u)}error(...e){this._print(We.Error,!0,"!!",...e)}warn(...e){this._print(We.Warn,!0,"! ",...e)}log(...e){this._print(We.Log,!0,"  ",...e)}info(...e){this._print(We.Info,!0,"    ",...e)}debug(...e){this._print(We.Debug,!0,"      ",...e)}blank(){this._print(We.Info,!1,"")}}class qa{constructor(e){Object.defineProperty(this,"hash",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"internalUpdate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"internalDigest",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.hash=e.hash,this.internalUpdate=e.update,this.internalDigest=e.digest}update(e){return this.hash=this.internalUpdate(this.hash,e),this.hash}digest(){return this.internalDigest(this.hash)}}const{createHash:nn}=ha,un=new ce("crypto-driver-noble","cyan"),Wa=class{static sha256(r){return typeof r=="string"?Promise.resolve(nn("sha256").update(r,"utf-8").digest()):Promise.resolve(nn("sha256").update(r).digest())}static updatableSha256(){return new qa({hash:nn("sha256"),update:(r,e)=>r.update(e),digest:r=>r.digest()})}static async generateKeypairBytes(){un.debug("generateKeypairBytes");const r=Lr.randomPrivateKey();return{pubkey:await Ca(r),secret:r}}static sign(r,e){return un.debug("sign"),typeof e=="string"&&(e=fn(e)),Ea(e,r.secret)}static async verify(r,e,t){un.debug("verify");try{return typeof t=="string"&&(t=fn(t)),await Fa(e,t,r)}catch{return!1}}};function uu(){return Date.now()*1e3}function js(r){return new Promise(e=>{dt(e,r)})}function ze(){return""+Math.floor(Math.random()*1e3)+Math.floor(Math.random()*1e3)}function Va(r){try{const e=Ns(r)?r.address:r.shareAddress,t=Dn(e);if(y(t))return t;const n={pubkey:Ir(t.pubkey),secret:Ir(r.secret)};return n.pubkey.length!==32?new b(`pubkey bytes should be 32 bytes long, not ${n.pubkey.length} after base32 decoding.  ${e}`):n.secret.length!==32?new b(`secret bytes should be 32 bytes long, not ${n.secret.length} after base32 decoding.  ${r.secret}`):n}catch(e){return new b("crash while decoding author keypair: "+e.message)}}function Ns(r){return"address"in r}new ce("crypto","cyan");let Ct=Wa,Wt=new ce("crypto","cyan");const X=class{static async sha256base32(r){const e=await Ct.sha256(r);return At(e)}static updatableSha256(){return Ct.updatableSha256()}static async generateAuthorKeypair(r){Wt.debug(`generateAuthorKeypair("${r}")`);const e=await Ct.generateKeypairBytes(),t={address:La(r,At(e.pubkey)),secret:At(e.secret)},n=Bn(t.address);return y(n)?n:t}static async generateShareKeypair(r){Wt.debug(`generateAuthorKeypair("${r}")`);const e=await Ct.generateKeypairBytes(),t={shareAddress:Ua(r,At(e.pubkey)),secret:At(e.secret)},n=bt(t.shareAddress);return y(n)?n:t}static async sign(r,e){Wt.debug("sign");try{const t=Va(r);if(y(t))return t;const n=await Ct.sign(t,e);return At(n)}catch(t){return new b("unexpected error while signing: "+t.message)}}static verify(r,e,t){Wt.debug("verify");try{const n=Dn(r);return y(n)?Promise.resolve(!1):Ct.verify(Ir(n.pubkey),Ir(e),t)}catch{return Promise.resolve(!1)}}static async checkKeypairIsValid(r){Wt.debug("checkAuthorKeypairIsValid");const e=Ns(r)?r.address:r.shareAddress;try{if(typeof e!="string"||typeof r.secret!="string")return new b("address and secret must be strings");const t=Dn(e);if(y(t))return t;const n="a test message to sign. "+ze(),u=await this.sign(r,n);return y(u)?u:await this.verify(e,u,n)===!1?new b("pubkey does not match secret"):!0}catch(t){return new b("unexpected error in checkAuthorKeypairIsValid: "+t.message)}}};var za=function(r,e,t){return typeof e=="symbol"&&(e=e.description?"[".concat(e.description,"]"):""),Object.defineProperty(r,"name",{configurable:!0,value:t?"".concat(t," ",e):e})},mr;new ce("validator es.4","red");const Qa=10,Ka=Qa*60*1e3*1e3,su=1e13,iu=9007199254740990,Ga=4e6,Ya=53,Xa=104,au={objSchema:{format:Is("es.4"),author:me({allowedChars:Ss}),content:me({maxLen:Ga}),contentHash:me({allowedChars:Pe,len:Ya}),deleteAfter:Jt({min:su,max:iu,nullable:!0}),path:me({allowedChars:ks,minLen:2,maxLen:512}),signature:me({allowedChars:Pe,len:Xa}),timestamp:Jt({min:su,max:iu}),workspace:me({allowedChars:_s})},allowLiteralUndefined:!1,allowExtraKeys:!1};mr=class{static hashDocument(r){const e={...r,signature:"bthisisafakesignatureusedtofillintheobjectwhenvalidatingitforhashingaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"},t=this._checkBasicDocumentValidity(e);return y(t)?Promise.resolve(t):X.sha256base32(`author	${r.author}
contentHash	${r.contentHash}
`+(r.deleteAfter===null?"":`deleteAfter	${r.deleteAfter}
`)+`format	${r.format}
path	${r.path}
timestamp	${r.timestamp}
workspace	${r.workspace}
`)}static async generateDocument({input:r,keypair:e,share:t,timestamp:n}){const u={format:"es.4",author:e.address,content:r.content,contentHash:await X.sha256base32(r.content),deleteAfter:r.deleteAfter??null,path:r.path,timestamp:n,workspace:t,signature:"?"},s=await this.signDocument(e,u);return y(s)?s:{doc:s}}static async signDocument(r,e){const t=await this.hashDocument(e);if(y(t))return t;const n=await X.sign(r,t);return y(n)?n:{...e,signature:n}}static async wipeDocument(r,e){if(e.content.length===0)return e;const t=this.removeExtraFields(e);if(y(t))return t;const u={...t.doc,content:"",contentHash:await X.sha256base32(""),signature:"?"};return this.signDocument(r,u)}static removeExtraFields(r){if(!xn(r))return new b("doc is not a plain javascript object");const e=new Set(Object.keys(au.objSchema||{})),t={},n={};for(const[u,s]of Object.entries(r))if(e.has(u))t[u]=s;else{if(!u.startsWith("_"))return new b("extra document fields must have names starting with an underscore");n[u]=s}return{doc:t,extras:n}}static async checkDocumentIsValid(r,e){e===void 0&&(e=Date.now()*1e3);const t=this._checkBasicDocumentValidity(r);if(y(t))return t;const n=this._checkTimestampIsOk(r.timestamp,r.deleteAfter,e);if(y(n))return n;const u=this._checkAuthorCanWriteToPath(r.author,r.path);if(y(u))return u;const s=this._checkPathIsValid(r.path,r.deleteAfter);if(y(s))return s;const i=Bn(r.author);if(y(i))return i;const a=bt(r.workspace);if(y(a))return a;const o=await this._checkAuthorSignatureIsValid(r);if(y(o))return o;const c=await this._checkContentMatchesHash(r.content,r.contentHash);return y(c)?c:!0}static _checkBasicDocumentValidity(r){const e=Os(au)(r);return e!==null?new b(e):!0}static _checkAuthorCanWriteToPath(r,e){return e.indexOf("~")===-1||e.indexOf("~"+r)!==-1?!0:new b(`author ${r} can't write to path ${e}`)}static _checkTimestampIsOk(r,e,t){if(r>t+Ka)return new b("timestamp too far in the future");if(e!==null){if(t>e)return new b("ephemeral doc has expired");if(e<=r)return new b("ephemeral doc expired before it was created")}return!0}static _checkPathIsValid(r,e){if(!r.startsWith("/"))return new b("invalid path: must start with /");if(r.endsWith("/"))return new b("invalid path: must not end with /");if(r.startsWith("/@"))return new b('invalid path: must not start with "/@"');if(r.indexOf("//")!==-1)return new b("invalid path: must not contain two consecutive slashes");if(e!==void 0){if(r.indexOf("!")===-1&&e!==null)return new b("when deleteAfter is set, path must contain '!'");if(r.indexOf("!")!==-1&&e===null)return new b("when deleteAfter is null, path must not contain '!'")}return!0}static async _checkAuthorSignatureIsValid(r){try{const e=await this.hashDocument(r);return y(e)?e:await X.verify(r.author,r.signature,e)!==!0?new b("signature is invalid"):!0}catch{return new b("signature is invalid (unexpected exception)")}}static async _checkContentMatchesHash(r,e){return await X.sha256base32(r)!==e?new b("content does not match contentHash"):!0}static getAttachmentInfo(r){return new b("es.4 does not support attachments")}static updateAttachmentFields(r,e,t,n){return Promise.resolve(new b("es.4 does not support attachments"))}static authorFromCredentials(r){return r.address}},za(mr,"FormatEs4"),Object.defineProperty(mr,"id",{enumerable:!0,configurable:!0,writable:!0,value:"es.4"});var Za=function(r,e,t){return typeof e=="symbol"&&(e=e.description?"[".concat(e.description,"]"):""),Object.defineProperty(r,"name",{configurable:!0,value:t?"".concat(t," ",e):e})},gr;new ce("validator es.5","red");const Ja=10,eo=Ja*60*1e3*1e3,ou=1e13,cu=9007199254740990,to=8e3,lu=53,hu=104,ro=0,no=Number.MAX_SAFE_INTEGER,fu={objSchema:{format:Is("es.5"),author:me({allowedChars:Ss}),text:me({maxLen:to}),textHash:me({allowedChars:Pe,len:lu}),deleteAfter:Jt({min:ou,max:cu,optional:!0}),path:me({allowedChars:ks,minLen:2,maxLen:512}),signature:me({allowedChars:Pe,len:hu}),shareSignature:me({allowedChars:Pe,len:hu}),timestamp:Jt({min:ou,max:cu}),share:me({allowedChars:_s}),attachmentSize:Jt({min:ro,max:no,optional:!0}),attachmentHash:me({allowedChars:Pe,len:lu,optional:!0})},allowLiteralUndefined:!1,allowExtraKeys:!1},uo=(gr=class{static hashDocument(r){const e={...r,signature:"bthisisafakesignatureusedtofillintheobjectwhenvalidatingitforhashingaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa",shareSignature:"bthisisafakesignatureusedtofillintheobjectwhenvalidatingitforhashingaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"},t=this._checkBasicDocumentValidity(e);return y(t)?Promise.resolve(t):X.sha256base32((r.attachmentHash===void 0?"":`attachmentHash	${r.attachmentHash}
`)+(r.attachmentSize===void 0?"":`attachmentSize	${r.attachmentSize}
`)+`author	${r.author}
`+(r.deleteAfter===void 0?"":`deleteAfter	${r.deleteAfter}
`)+`format	${r.format}
path	${r.path}
textHash	${r.textHash}
timestamp	${r.timestamp}
share	${r.share}
`)}static async generateDocument({input:r,keypair:e,share:t,timestamp:n,prevLatestDoc:u,config:s}){if(r.text===void 0&&(u==null?void 0:u.text)===void 0)return new b("Couldn't determine document text from given input or previous version's text.");const i=r.text!==void 0?r.text:u==null?void 0:u.text,a={...u,format:"es.5",author:e.address,text:i,textHash:await X.sha256base32(i),path:r.path,timestamp:n,share:t,signature:"?",shareSignature:"?"};r.deleteAfter&&(a.deleteAfter=r.deleteAfter);const o=await this.signDocument(e,a,s);return y(o)?o:r.attachment?{doc:o,attachment:r.attachment}:{doc:o}}static async signDocument(r,e,t){const n=await this.hashDocument(e);if(y(n))return n;const u=await X.sign(r,n);if(t.shareSecret===void 0)return new De(`Tried to write a document to ${e.share} without the secret.`);const s=await X.sign({shareAddress:e.share,secret:t.shareSecret},n);return y(u)?u:y(s)?s:{...e,signature:u,shareSignature:s}}static async wipeDocument(r,e,t){if(e.text.length===0)return e;const n=this.removeExtraFields(e);if(y(n))return n;const u=n.doc;if(u.attachmentHash){const i={...u,text:"",textHash:await X.sha256base32(""),signature:"?",shareSignature:"?",attachmentHash:await X.sha256base32(""),attachmentSize:0};return this.signDocument(r,i,t)}const s={...u,text:"",textHash:await X.sha256base32(""),signature:"?",shareSignature:"?"};return this.signDocument(r,s,t)}static removeExtraFields(r){if(!xn(r))return new b("doc is not a plain javascript object");const e=new Set(Object.keys(fu.objSchema||{})),t={},n={};for(const[u,s]of Object.entries(r))if(e.has(u))t[u]=s;else{if(!u.startsWith("_"))return new b("extra document fields must have names starting with an underscore");n[u]=s}return{doc:t,extras:n}}static async checkDocumentIsValid(r,e){e===void 0&&(e=Date.now()*1e3);const t=this._checkBasicDocumentValidity(r);if(y(t))return t;const n=this._checkTimestampIsOk(r.timestamp,r.deleteAfter?r.deleteAfter:null,e);if(y(n))return n;const u=this._checkAuthorCanWriteToPath(r.author,r.path);if(y(u))return u;const s=this._checkAttachmentFieldsConsistent(r);if(y(s))return s;const i=this._checkPathIsValid(r.path,!!r.attachmentHash,r.deleteAfter);if(y(i))return i;const a=Bn(r.author);if(y(a))return a;const o=bt(r.share);if(y(o))return o;const c=await this._checkAuthorSignatureIsValid(r);if(y(c))return c;const f=await this._checkShareSignatureIsValid(r);if(y(f))return f;const h=await this._checkContentMatchesHash(r.text,r.textHash);return y(h)?h:!0}static _checkBasicDocumentValidity(r){const e=Os(fu)(r);return e!==null?new b(e):!0}static _checkAttachmentFieldsConsistent(r){return r.text.length===0&&r.attachmentSize&&r.attachmentSize>0?new b("Documents with attachments must have text."):(r.text.length>0&&r.attachmentSize&&r.attachmentSize,r.attachmentHash&&r.attachmentSize===void 0?new b("Attachment size is undefined while attachment hash is defined"):r.attachmentSize&&r.attachmentHash===void 0?new b("Attachment hash is undefined while attachment size is defined"):!0)}static _checkAuthorCanWriteToPath(r,e){return e.indexOf("~")===-1||e.indexOf("~"+r)!==-1?!0:new b(`author ${r} can't write to path ${e}`)}static _checkTimestampIsOk(r,e,t){if(r>t+eo)return new b("timestamp too far in the future");if(e!==null){if(t>e)return new b("ephemeral doc has expired");if(e<=r)return new b("ephemeral doc expired before it was created")}return!0}static _checkPathIsValid(r,e,t){if(!r.startsWith("/"))return new b("invalid path: must start with /");if(r.endsWith("/"))return new b("invalid path: must not end with /");if(r.startsWith("/@"))return new b('invalid path: must not start with "/@"');if(r.indexOf("//")!==-1)return new b("invalid path: must not contain two consecutive slashes");if(t!==void 0){if(r.indexOf("!")===-1&&t!==null)return new b("when deleteAfter is set, path must contain '!'");if(r.indexOf("!")!==-1&&t===null)return new b("when deleteAfter is null, path must not contain '!'")}return!du(r)&&e?new b("when a attachment is provided, the path must end with a file extension"):du(r)&&e===!1?new b("when no attachment is provided, the path cannot end with a file extension"):!0}static async _checkAuthorSignatureIsValid(r){try{const e=await this.hashDocument(r);return y(e)?e:await X.verify(r.author,r.signature,e)!==!0?new b("signature is invalid"):!0}catch{return new b("signature is invalid (unexpected exception)")}}static async _checkShareSignatureIsValid(r){try{const e=await this.hashDocument(r);return y(e)?e:await X.verify(r.share,r.shareSignature,e)!==!0?new b("share signature is invalid"):!0}catch{return new b("share signature is invalid (unexpected exception)")}}static async _checkContentMatchesHash(r,e){return await X.sha256base32(r)!==e?new b("content does not match contentHash"):!0}static getAttachmentInfo(r){return r.attachmentHash&&r.attachmentSize===0?new b("This document has had its attachment wiped"):!r.attachmentHash||!r.attachmentSize?new b("This document has no attachment."):{size:r.attachmentSize,hash:r.attachmentHash}}static updateAttachmentFields(r,e,t,n,u){const s={...e,attachmentHash:n,attachmentSize:t};return this.signDocument(r,s,u)}static authorFromCredentials(r){return r.address}},Za(gr,"FormatEs5"),Object.defineProperty(gr,"id",{enumerable:!0,configurable:!0,writable:!0,value:"es.5"}),gr),so=/^.*\.(\w+)$/,io=/^.*~@\w{4}\.\w{53}$/;function du(r){if(r.indexOf(".")===-1)return!1;const e=r.match(so);return!(e===null||e[1].length===53&&r.match(io))}const Te=uo,$r=[Te];function Du(r){return r||Te}function It(r){return r||$r}function ao(r,e){const t=[];for(const n of e)r.includes(n.id)&&t.push(n);return t}function Ot(r){const e=r||$r,t={};for(const n of e)t[n.id]=n;return t}class Hr{constructor(){Object.defineProperty(this,"deferreds",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:"pending"})}resolve(e){if(this.state==="pending"){this.state="fulfilled";for(const t of this.deferreds)t.resolve(e)}}reject(e){if(this.state==="pending"){this.state="rejected";for(const t of this.deferreds)t.reject(e)}}getPromise(){const e=_();return this.state==="fulfilled"?e.resolve():this.state==="rejected"?e.reject():this.deferreds.add(e),e}}class ur{constructor(e=!1){Object.defineProperty(this,"promises",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"sealed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"multiDeferred",{enumerable:!0,configurable:!0,writable:!0,value:new Hr}),Object.defineProperty(this,"allowRejectedPromises",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.allowRejectedPromises=e}enrol(e){if(this.sealed)throw new De("Tried to enrol a promise when enrolment was already sealed.");this.promises.add(e),e.then(()=>{this.checkAllDone()}).catch(t=>{if(!this.allowRejectedPromises)throw t})}checkAllDone(){this.sealed&&(this.allowRejectedPromises?Promise.allSettled(this.promises).then(()=>{this.multiDeferred.resolve()}):Promise.all(this.promises).then(()=>{this.multiDeferred.resolve()}).catch(()=>{this.multiDeferred.reject()}))}seal(){this.sealed||(this.sealed=!0,this.checkAllDone())}isSealed(){return this.sealed}isDone(){return this.multiDeferred.getPromise()}}class oo{constructor(){Object.defineProperty(this,"closed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"transform",{enumerable:!0,configurable:!0,writable:!0,value:new Rt({transform(e,t){t.enqueue(e)}})}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:this.transform.writable.getWriter()}),Object.defineProperty(this,"readable",{enumerable:!0,configurable:!0,writable:!0,value:this.transform.readable}),Object.defineProperty(this,"writables",{enumerable:!0,configurable:!0,writable:!0,value:[]})}checkClosed(){if(this.closed)throw"Closed"}getWritableStream(){this.checkClosed();const e=this.writer,t=new Ce({async write(n){await e.ready,await e.write(n)}});return this.writables.push(t),t}async close(){this.checkClosed();for(const e of this.writables)await e.abort();this.transform.writable.abort(),this.closed=!0}isClosed(){return this.closed}}class co{constructor(){Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:new Rt(new fo)}),Object.defineProperty(this,"sourceReadable",{enumerable:!0,configurable:!0,writable:!0,value:this.transformStream.readable}),Object.defineProperty(this,"writable",{enumerable:!0,configurable:!0,writable:!0,value:this.transformStream.writable})}getReadableStream(){const[e,t]=this.sourceReadable.tee();return this.sourceReadable=e,t}}class lo{checkClosed(){if(this.closed)throw"Closed"}constructor(){Object.defineProperty(this,"closed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"subscribers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"writables",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"writable",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const e=this.subscribers;this.writable=new Ce({write(t){const n=e.map(({writer:u})=>new Promise(s=>{u.ready.then(()=>{u.write(t).then(s)})}));Promise.all(n)}})}getReadableStream(){this.checkClosed();const e=new Rt({transform(t,n){n.enqueue(t)}});return this.subscribers.push({transform:e,writer:e.writable.getWriter()}),e.readable}async close(){this.checkClosed();for(const e of this.writables)await e.abort();for(const{transform:e}of this.subscribers)await e.writable.abort(),await e.readable.cancel();this.closed=!0}isClosed(){return this.closed}}class ho{checkClosed(){if(this.closed)throw"Closed"}constructor(e){Object.defineProperty(this,"closed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"combineStream",{enumerable:!0,configurable:!0,writable:!0,value:new oo}),Object.defineProperty(this,"cloneStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e?this.cloneStream=new lo:this.cloneStream=new co,this.combineStream.readable.pipeTo(this.cloneStream.writable)}getWritableStream(){return this.combineStream.getWritableStream()}getReadableStream(){return this.cloneStream.getReadableStream()}close(){this.checkClosed(),this.combineStream.close(),this.closed=!0}isClosed(){return this.closed}}class Ls{constructor(){Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:new Set})}onWrite(e){return this.callbacks.add(e),()=>{this.callbacks.delete(e)}}async write(e){for(const t of this.callbacks)await t(e)}close(){this.callbacks.clear()}}class wt{constructor(){Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"lock",{enumerable:!0,configurable:!0,writable:!0,value:new Us})}on(e){return this.callbacks.add(e),()=>{this.callbacks.delete(e)}}async send(e){for(const t of this.callbacks)await this.lock.run(()=>t(e))}}class fo{transform(e,t){t.enqueue(e)}}class Us{constructor(){Object.defineProperty(this,"doneEnroller",{enumerable:!0,configurable:!0,writable:!0,value:new ur}),Object.defineProperty(this,"writable",{enumerable:!0,configurable:!0,writable:!0,value:new Ce({async write(e){await e()}})}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:this.writable.getWriter()}),Object.defineProperty(this,"closed",{enumerable:!0,configurable:!0,writable:!0,value:!1})}checkClosed(){if(this.closed)throw"Closed"}async run(e){this.checkClosed(),await this.writer.ready;const t=this.writer.write(e);return this.doneEnroller.enrol(t),t}async close(){this.checkClosed(),this.doneEnroller.seal(),await this.doneEnroller.isDone(),this.writer.releaseLock(),await this.writable.abort(),this.closed=!0}isClosed(){return this.closed}}class Do{constructor(e,t){Object.defineProperty(this,"channel",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"channelKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.channel=e,this.channelKey=t}transform(e,t){if(this.channel==="*"||this.channel===e[this.channelKey]){t.enqueue(e);return}}}class po{constructor(e,t){Object.defineProperty(this,"multistream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"channelKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.multistream=new ho(t),this.channelKey=e}getWritableStream(){return this.multistream.getWritableStream()}getReadableStream(e){const t=new Rt(new Do(e,this.channelKey));return this.multistream.getReadableStream().pipeThrough(t)}}function mo(r,e){const t=_(),n=_(),u=()=>{if(n.state==="pending"){let s;r instanceof Tt?s=r:s=new Tt(r),n.resolve(s),s.binaryType="arraybuffer",s.readyState===s.OPEN&&t.resolve(),s.onopen=()=>{t.resolve()}}};return new Ce({async write(s,i){u();const a=await n;await t;try{const o=e(s);a.send(o)}catch(o){i.error(o)}a.onclose=()=>{i.error("Socket closed before we were done")}},async close(){u();const s=await n;await t,s.close()},async abort(){u();const s=await n;await t,s.close()}})}function go(r,e){const t=_();let n=!1;const u=()=>{if(t.state==="pending")if(r instanceof Tt)t.resolve(r);else try{const s=new Tt(r);t.resolve(s)}catch(s){t.reject(s)}};return new Dt({async start(s){u();const i=await t;i.binaryType="arraybuffer",i.onmessage=a=>{const o=e(a);try{s.enqueue(o)}catch{}},i.onclose=()=>{if(!n)try{s.close()}catch{}},i.onerror=a=>{n=!0,s.error(a)}},async cancel(){u(),(await t).close()}})}function bo(r){let t=r.toString(16);return t.length%2&&(t="0"+t),t}function wo(r){return BigInt("0x"+r)}const yo={EMPTY_SET:"emptySet",LOWER_BOUND:"lowerBound",PAYLOAD:"payload",EMPTY_PAYLOAD:"emptyPayload",DONE:"done",FINGERPRINT:"fingerprint",TERMINAL:"terminal"},Ao={encode:{emptySet:r=>({type:"EMPTY_SET",canRespond:r}),lowerBound:r=>({type:"LOWER_BOUND",value:r}),payload:(r,e)=>({type:"PAYLOAD",payload:r,...e?{end:e}:{}}),emptyPayload:r=>({type:"EMPTY_PAYLOAD",upperBound:r}),done:r=>({type:"DONE",upperBound:r}),fingerprint:(r,e)=>({type:"FINGERPRINT",fingerprint:bo(r),upperBound:e}),terminal:()=>({type:"TERMINAL"})},decode:{getType:r=>yo[r.type],emptySet:r=>{if(r.type==="EMPTY_SET")return r.canRespond;throw"Can't decode"},lowerBound:r=>{if(r.type==="LOWER_BOUND")return r.value;throw"Can't decode"},payload:r=>{if(r.type==="PAYLOAD")return{value:r.payload,...r.end?{end:r.end}:{}};throw"Can't decode"},emptyPayload:r=>{if(r.type==="EMPTY_PAYLOAD")return r.upperBound;throw"Can't decode"},done:r=>{if(r.type==="DONE")return r.upperBound;throw"Can't decode"},fingerprint:r=>{if(r.type==="FINGERPRINT")return{fingerprint:wo(r.fingerprint),upperBound:r.upperBound};throw"Can't decode"},terminal:r=>{if(r.type==="TERMINAL")return!0;throw"Can't decode"}}};class Co extends Ta{constructor(e,t,n){super({tree:e,encoding:Ao,fingerprintEquals:(u,s)=>u===s,payloadThreshold:t,rangeDivision:n})}}class Eo{sendEvent(e){return this.inboundEventQueue.push(e)}events(){return this.outboundEventQueue}getStatus(){return{requestedCount:this.requestedCount,receivedCount:this.receivedDocsCount,sentCount:this.sentDocsCount,status:this.isDoneMultiDeferred.state==="rejected"?"aborted":this.hasPrepared.state==="pending"?"preparing":this.hasReconciled.state==="pending"?"reconciling":this.isDoneMultiDeferred.state==="fulfilled"?"done":"gossiping"}}constructor(e){Object.defineProperty(this,"statusBus",{enumerable:!0,configurable:!0,writable:!0,value:new wt}),Object.defineProperty(this,"isDoneMultiDeferred",{enumerable:!0,configurable:!0,writable:!0,value:new Hr}),Object.defineProperty(this,"inboundEventQueue",{enumerable:!0,configurable:!0,writable:!0,value:new Ve}),Object.defineProperty(this,"outboundEventQueue",{enumerable:!0,configurable:!0,writable:!0,value:new Ve}),Object.defineProperty(this,"gossiperInboundQueue",{enumerable:!0,configurable:!0,writable:!0,value:new Ve}),Object.defineProperty(this,"reconcilerInboundQueue",{enumerable:!0,configurable:!0,writable:!0,value:new Ve}),Object.defineProperty(this,"hasPrepared",{enumerable:!0,configurable:!0,writable:!0,value:_()}),Object.defineProperty(this,"hasReconciled",{enumerable:!0,configurable:!0,writable:!0,value:_()}),Object.defineProperty(this,"hasCheckedAllExistingDocsForAttachments",{enumerable:!0,configurable:!0,writable:!0,value:_()}),Object.defineProperty(this,"requestedCount",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"sentDocsCount",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"receivedDocsCount",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"counterpartId",{enumerable:!0,configurable:!0,writable:!0,value:ze()}),Object.defineProperty(this,"replica",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.replica=e.replica,e.replica.onEvent(i=>{i.kind==="willClose"&&this.cancel()});const{treeIsReady:t}=e.syncerManager.getDocThumbnailTreeAndDocLookup(e.replica.share,It(e.formats));t.then(()=>{this.hasPrepared.resolve()}),(async()=>{for await(const i of this.inboundEventQueue)switch(i.kind){case"RANGE_MSG":{this.reconcilerInboundQueue.push(i.message);break}default:this.gossiperInboundQueue.push(i)}})(),new Bo({outboundEventQueue:this.outboundEventQueue,formats:e.formats,replica:e.replica,counterpartId:this.counterpartId,transferManager:e.transferManager,hasCheckedAllExistingDocsForAttachments:this.hasCheckedAllExistingDocsForAttachments});const n=new So,u=new vo({inboundEventQueue:this.reconcilerInboundQueue,outboundEventQueue:this.outboundEventQueue,syncerManager:e.syncerManager,formats:e.formats,replica:e.replica,initiateMessaging:e.initiateMessaging,wantTracker:n,payloadThreshold:e.payloadThreshold,rangeDivision:e.rangeDivision,onDocRequested:async()=>{this.requestedCount++,await this.statusBus.send(this.getStatus())}});u.isDone.then(()=>{this.hasReconciled.resolve()}),new Fo({inboundEventQueue:this.gossiperInboundQueue,outboundEventQueue:this.outboundEventQueue,syncerManager:e.syncerManager,formats:e.formats,replica:e.replica,counterpartId:this.counterpartId,transferManager:e.transferManager,cancel:this.cancel.bind(this),reconciliationIsDone:u.isDone,wantTracker:n,syncAppetite:e.syncAppetite,onDocReceived:async()=>{this.receivedDocsCount++,await this.statusBus.send(this.getStatus())},onDocSent:async()=>{this.sentDocsCount++,await this.statusBus.send(this.getStatus())},onDocRequested:async()=>{this.requestedCount++,await this.statusBus.send(this.getStatus())}}).isDone.then(async()=>{await this.hasCheckedAllExistingDocsForAttachments,this.isDoneMultiDeferred.resolve()}),this.statusBus.send(this.getStatus())}onStatusUpdate(e){return this.statusBus.on(e)}async cancel(e){this.isDoneMultiDeferred.state==="fulfilled"||this.isDoneMultiDeferred.state==="rejected"||(this.isDoneMultiDeferred.reject(e||"Cancelled"),await this.statusBus.send(this.getStatus()),this.outboundEventQueue.push({kind:"ABORT"}),this.outboundEventQueue.close(),this.inboundEventQueue.close({immediately:!0}),this.gossiperInboundQueue.close({immediately:!0}),this.reconcilerInboundQueue.close({immediately:!0}))}isDone(){return this.isDoneMultiDeferred.getPromise()}}class Fo{constructor(e){Object.defineProperty(this,"isPartnerFulfilled",{enumerable:!0,configurable:!0,writable:!0,value:_()}),Object.defineProperty(this,"isFulfilled",{enumerable:!0,configurable:!0,writable:!0,value:_()});const t=Ot(e.formats),n=e.syncerManager.getPlumTree(e.replica.share);if(e.syncAppetite==="continuous"){const i=e.replica.getQueryStream(void 0,"new",e.formats),a=new vn;i.pipeTo(new Ce({async write(o){if(o.kind==="success"&&o.sourceId!==e.counterpartId){const c=n.getMode(o.sourceId);a.reset(),a.update(`${o.doc.path} ${o.doc.author}`);const f=a.digest().toString(16),h=`${o.doc.timestamp} ${f}`;if(c==="EAGER"){const l=t[o.doc.format],d=l.getAttachmentInfo(o.doc),D=!y(d);let m=!1;D&&await e.replica.getAttachment(o.doc,l)&&(m=!0),e.outboundEventQueue.push({kind:"DOC",thumbnail:h,doc:o.doc,attachmentHeld:m}),e.onDocSent()}else e.outboundEventQueue.push({kind:"HAVE",thumbnail:h})}}})).catch(()=>{})}const u=e.replica.onEvent(i=>{i.kind==="attachment_ingest"&&i.sourceId!==e.counterpartId&&e.outboundEventQueue.push({kind:"NEW_ATTACHMENT",path:i.doc.path,author:i.doc.author,format:i.doc.format,hash:i.hash})}),{lookup:s}=e.syncerManager.getDocThumbnailTreeAndDocLookup(e.replica.share,It(e.formats));(async()=>{for await(const i of e.inboundEventQueue)switch(i.kind){case"PRUNE":{n.onPrune(e.counterpartId);break}case"HAVE":{if(e.reconciliationIsDone.state==="fulfilled"&&e.syncAppetite==="once")break;e.wantTracker.addWantedThumbnail(i.thumbnail),n.onLazyMessage(i,a=>{e.outboundEventQueue.push({kind:"WANT",thumbnail:a})}),e.onDocRequested();break}case"WANT":{n.onGraftMessage(e.counterpartId);const[,a]=i.thumbnail.split(" "),o=s[a];if(!o)return;const[,c,f]=o,l=(await e.replica.getAllDocsAtPath(c,e.formats)).find(d=>d.author===f);if(l){const d=t[l.format],D=d.getAttachmentInfo(l),m=!y(D);let p=!1;m&&await e.replica.getAttachment(l,d)&&(p=!0),e.outboundEventQueue.push({kind:"DOC",thumbnail:i.thumbnail,doc:l,attachmentHeld:p}),await e.onDocSent()}else console.error("Got a WANT event for a document not on record.");break}case"DOC":{if(this.isFulfilled.state==="fulfilled"&&e.syncAppetite==="once"||(n.onEagerMessage(e.counterpartId,i)&&e.outboundEventQueue.push({kind:"PRUNE"}),e.wantTracker.isReceived(i.thumbnail)))break;const o=t[i.doc.format];if(!o){console.error(`Was sent a doc with a format we don't know about (${i.doc.format})`);break}if(i.attachmentHeld&&await e.replica.getAttachment(i.doc,t[i.doc.format])===void 0){const f=await e.transferManager.handleDownload(i.doc,e.replica,e.counterpartId);if(y(f)){const h=o.getAttachmentInfo(i.doc);e.transferManager.registerExpectedTransfer(e.replica.share,h.hash),e.outboundEventQueue.push({kind:"WANT_ATTACHMENT",attachmentHash:h.hash,doc:i.doc,shareAddress:e.replica.share})}}await e.replica.ingest(o,i.doc,e.counterpartId),e.wantTracker.receivedWantedThumbnail(i.thumbnail),await e.onDocReceived();break}case"NEW_ATTACHMENT":{if(e.transferManager.isAlreadyQueued(i.hash,"download"))break;const a=t[i.format],c=(await e.replica.getAllDocsAtPath(i.path,[a])).find(h=>i.author===h.author);if(!c)break;if(await e.replica.getAttachment(c,t[c.format])===void 0){const h=await e.transferManager.handleDownload(c,e.replica,e.counterpartId);if(y(h)){const l=a.getAttachmentInfo(c);e.transferManager.registerExpectedTransfer(e.replica.share,l.hash),e.outboundEventQueue.push({kind:"WANT_ATTACHMENT",attachmentHash:l.hash,doc:c,shareAddress:e.replica.share})}}break}case"FULFILLED":this.isPartnerFulfilled.resolve(!0);break;case"WANT_ATTACHMENT":e.transferManager.handleUpload(i,e.replica);break;case"ABORT":await e.cancel()}})(),e.reconciliationIsDone.then(async()=>{e.syncAppetite==="once"&&(u(),e.wantTracker.seal(),await e.wantTracker.isDone(),e.outboundEventQueue.push({kind:"FULFILLED"}),this.isFulfilled.resolve())})}get isDone(){return Promise.all([this.isPartnerFulfilled,this.isFulfilled])}}class vo{constructor(e){Object.defineProperty(this,"communicationRoundsCount",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"isDone",{enumerable:!0,configurable:!0,writable:!0,value:_()});const{tree:t,lookup:n,treeIsReady:u}=e.syncerManager.getDocThumbnailTreeAndDocLookup(e.replica.share,It(e.formats));e.initiateMessaging&&u.then(()=>{for(const i of s.initialMessages())e.outboundEventQueue.push({kind:"RANGE_MSG",message:i})});const s=new Co(t,e.payloadThreshold,e.rangeDivision);s.onInsertion(i=>{const[a,o]=i.split(" "),c=n[o];c&&c[0]>=parseInt(a)||(e.wantTracker.addWantedThumbnail(i),e.outboundEventQueue.push({kind:"WANT",thumbnail:i}),e.onDocRequested())}),(async()=>{await u;for await(const i of e.inboundEventQueue){if(this.isDone.state==="fulfilled")return;i.type==="TERMINAL"&&this.communicationRoundsCount++;const a=s.respond(i);for(const o of a)e.outboundEventQueue.push({kind:"RANGE_MSG",message:o})}})(),s.isDone().then(()=>{this.isDone.resolve(this.communicationRoundsCount)})}}class Bo{constructor(e){const t=e.replica.getQueryStream({orderBy:"localIndex ASC"},"existing",e.formats),n=Ot(e.formats),u=e.transferManager.handleDownload.bind(e.transferManager);t.pipeTo(new Ce({start(s){e.replica.onEvent(i=>{i.kind==="willClose"&&s.error()})},async write(s){if(s.kind==="existing"||s.kind==="success"){const i=n[s.doc.format],a=await e.replica.getAttachment(s.doc,i);if(y(a))return;if(a===void 0){const o=await u(s.doc,e.replica,e.counterpartId);if(y(o)){const c=i.getAttachmentInfo(s.doc);e.transferManager.registerExpectedTransfer(e.replica.share,c.hash),e.outboundEventQueue.push({kind:"WANT_ATTACHMENT",attachmentHash:c.hash,doc:s.doc,shareAddress:e.replica.share})}}}}})).then(()=>{e.hasCheckedAllExistingDocsForAttachments.resolve()}).catch(()=>{e.hasCheckedAllExistingDocsForAttachments.resolve()})}}class So{constructor(){Object.defineProperty(this,"isSealed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"wantedThumbnails",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"enroller",{enumerable:!0,configurable:!0,writable:!0,value:new ur}),Object.defineProperty(this,"received",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:ze()})}addWantedThumbnail(e){if(!this.isSealed&&!this.wantedThumbnails.has(e)){const t=_();this.wantedThumbnails.set(e,t),this.enroller.enrol(t)}}receivedWantedThumbnail(e){const t=this.wantedThumbnails.get(e);t&&(t.resolve(),this.received++)}isRequested(e){return this.wantedThumbnails.has(e)}isReceived(e){const t=this.wantedThumbnails.get(e);return t?t.state==="fulfilled":!1}seal(){this.enroller.seal()}isDone(){return this.enroller.isDone()}get requestedCount(){return this.wantedThumbnails.size}get receivedCount(){return this.received}}class $s{constructor(e,t){Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cb",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"closed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.cb=e,this.ms=t,this.timeout=dt(e,t)}bump(){this.closed||(clearTimeout(this.timeout),this.timeout=dt(this.cb,this.ms))}close(){this.closed=!0,clearTimeout(this.timeout)}}const Hs=1e4;class sn{constructor({stream:e,replica:t,doc:n,format:u,requester:s,counterpartId:i}){Object.defineProperty(this,"kind",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:"ready"}),Object.defineProperty(this,"share",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"loaded",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"expectedSize",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sourceDoc",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"statusBus",{enumerable:!0,configurable:!0,writable:!0,value:new wt}),Object.defineProperty(this,"transferOp",{enumerable:!0,configurable:!0,writable:!0,value:_()}),Object.defineProperty(this,"abortCb",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"multiDeferred",{enumerable:!0,configurable:!0,writable:!0,value:new Hr}),Object.defineProperty(this,"hash",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"requester",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.sourceDoc=n,this.share=t.share,this.requester=s;const a=u.getAttachmentInfo(n);if(y(a))throw new b("AttachmentTransfer was given a doc which has no attachment!");this.hash=a.hash,this.expectedSize=a.size;const o=this.updateLoaded.bind(this);if(e instanceof Dt){this.kind="download";let c;this.abortCb=()=>{c?c.cancel():e.cancel()};const f=()=>this.loaded,h=()=>new Dt({async start(l){const d=e.getReader();c=d;const D=new $s(()=>{l.error("Attachment download timed out.")},Hs);for(;;){const{done:m,value:p}=await d.read();if(D.bump(),m||(o(p.byteLength),l.enqueue(p),f()>=a.size))break}D.close(),l.close()}});this.transferOp.resolve(()=>{const l=_();return t.ingestAttachment(u,n,h(),i).then(d=>{if(y(d)&&this.loaded===0){this.changeStatus("missing_attachment");return}if(y(d)){console.warn(`Couldn't ingest the attachment for ${n.path} by ${n.author}: ${d.message}`),l.reject(d);return}l.resolve()}).catch(d=>{console.log(d),l.reject(d)}),l})}else this.kind="upload",this.abortCb=()=>{e.abort().catch(()=>{})},t.getAttachment(n,u).then(async c=>{if(!c){await this.changeStatus("missing_attachment"),await e.abort();return}if(y(c)){await this.changeStatus("failed"),await e.abort();return}const f=new Rt({transform(h,l){o(h.byteLength),l.enqueue(h)}});this.transferOp.resolve(()=>c.stream().then(h=>h.pipeThrough(f).pipeTo(e)).catch(h=>{console.log(h)}))})}async start(){if(this.status!=="ready")return;const e=await this.transferOp;await this.changeStatus("in_progress"),e().then(async()=>{await this.changeStatus("complete")}).catch(async()=>{await this.changeStatus("failed")})}updateLoaded(e){this.loaded+=e,this.statusBus.send({status:this.status,bytesLoaded:this.loaded,totalBytes:this.expectedSize})}async changeStatus(e){this.status==="complete"||this.status==="failed"||this.status==="missing_attachment"||(this.status=e,await this.statusBus.send({status:e,bytesLoaded:this.loaded,totalBytes:this.expectedSize}),e==="complete"&&this.multiDeferred.resolve(),e==="failed"&&this.multiDeferred.reject("Attachment transfer failed"),e==="missing_attachment"&&this.multiDeferred.reject("The other peer does not have this attachment"))}get doc(){return this.sourceDoc}onProgress(e){return this.statusBus.on(e)}abort(){this.abortCb()}isDone(){return this.multiDeferred.getPromise()}}class xo{constructor(e){Object.defineProperty(this,"waiting",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"active",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"failed",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"completed",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"activeLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"transfersRequestedByUsEnroller",{enumerable:!0,configurable:!0,writable:!0,value:new ur(!0)}),Object.defineProperty(this,"closed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"reports",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"reportBus",{enumerable:!0,configurable:!0,writable:!0,value:new wt}),this.activeLimit=e}async activate(e){this.active.add(e),e.isDone().then(()=>{this.completed.add(e)}).catch(()=>{this.failed.add(e)}).finally(()=>{this.active.delete(e),this.admitNext()}),await e.start()}queue(e){this.waiting.push(e)}admitNext(){if(this.waiting.length===0||this.active.size>=this.activeLimit)return;const e=this.waiting.shift();e&&this.activate(e)}async addTransfer(e){if(this.closed){e.abort();return}e.onProgress(()=>{this.updateTransferStatus(e)}),e.requester==="us"&&this.transfersRequestedByUsEnroller.enrol(e.isDone()),this.active.size<this.activeLimit?await this.activate(e):this.queue(e)}gotAllTransfersRequestedByUs(){this.transfersRequestedByUsEnroller.seal()}cancel(){this.closed=!0,this.transfersRequestedByUsEnroller.seal();for(const e of this.active)e.abort()}updateTransferStatus(e){this.reports[e.share]||(this.reports[e.share]={}),this.reports[e.share][e.hash+e.kind]={author:e.doc.author,path:e.doc.path,format:e.doc.format,hash:e.hash,kind:e.kind,status:e.status,bytesLoaded:e.loaded,totalBytes:e.expectedSize},this.reportBus.send(this.getReport())}getReport(){const e={};for(const t in this.reports){const n=[],u=this.reports[t];for(const s in u){const i=u[s];n.push(i)}e[t]=n}return e}hasQueuedTransfer(e,t){for(const n of this.waiting)if(n.hash===e&&n.kind===t)return!0;for(const n of this.active)if(n.hash===e&&n.kind===t)return!0;for(const n of this.completed)if(n.hash===e&&n.kind===t)return!0;return!1}onReportUpdate(e){return this.reportBus.on(e)}transfersRequestedByUsFinished(){return this.transfersRequestedByUsEnroller.isDone()}}class _o{constructor(e){Object.defineProperty(this,"partner",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"formats",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"otherSyncerId",{enumerable:!0,configurable:!0,writable:!0,value:_()}),Object.defineProperty(this,"receivedAllExpectedTransfersEnroller",{enumerable:!0,configurable:!0,writable:!0,value:new ur}),Object.defineProperty(this,"madeAllAttachmentRequestsEnroller",{enumerable:!0,configurable:!0,writable:!0,value:new ur(!0)}),Object.defineProperty(this,"formatsLookup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reportDidUpdateBus",{enumerable:!0,configurable:!0,writable:!0,value:new wt}),Object.defineProperty(this,"expectedTransferPromises",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),this.partner=e.partner,this.queue=new xo(this.partner.concurrentTransfers),this.formats=e.formats,this.formatsLookup=Ot(this.formats),this.queue.onReportUpdate(async t=>{await this.reportDidUpdateBus.send(t)}),this.madeAllAttachmentRequestsEnroller.isDone().then(()=>{this.receivedAllExpectedTransfersEnroller.seal()}),this.receivedAllExpectedTransfersEnroller.isDone().then(()=>{this.queue.gotAllTransfersRequestedByUs()})}registerSyncAgent(e){this.madeAllAttachmentRequestsEnroller.enrol(e.isDone())}allSyncAgentsKnown(){this.madeAllAttachmentRequestsEnroller.seal()}registerExpectedTransfer(e,t){const n=`${e}_${t}`;if(this.expectedTransferPromises.has(n))return;const u=_();this.expectedTransferPromises.set(n,u),this.receivedAllExpectedTransfersEnroller.enrol(u)}async queueTransfer(e){this.queue.hasQueuedTransfer(e.hash,e.kind)||await this.queue.addTransfer(e)}async handleDownload(e,t,n){const u=this.formatsLookup[e.format],s=u.getAttachmentInfo(e);if(y(s))throw new De("TransferManager: attempted to download doc with no attachment.");if(this.queue.hasQueuedTransfer(s.hash,"download"))return"queued";const i=await this.partner.getDownload({doc:e,shareAddress:t.share,syncerId:await this.otherSyncerId,attachmentHash:s.hash});if(i===void 0)return"no_attachment";if(y(i))return i;const a=new sn({replica:t,doc:e,format:u,stream:i,requester:"us",counterpartId:n});return await this.queueTransfer(a),"queued"}async handleUpload(e,t){if(this.queue.hasQueuedTransfer(e.attachmentHash,"upload"))return!1;const n=this.formatsLookup[e.doc.format];if(!await t.getAttachment(e.doc,n))return!1;const s=await this.partner.handleUploadRequest({shareAddress:e.shareAddress,syncerId:await this.otherSyncerId,doc:e.doc,attachmentHash:e.attachmentHash});if(y(s))return!1;try{const i=new sn({doc:e.doc,format:n,replica:t,stream:s,requester:"them",counterpartId:"unused"});await this.queueTransfer(i)}catch{return!1}return!0}async handleTransferRequest({replica:e,path:t,author:n,source:u,kind:s,formatName:i,counterpartId:a}){const o=await this.partner.handleTransferRequest(u,s);if(o===void 0||y(o))return;const c=Ot(this.formats)[i];if(!c)return;const h=(await e.getAllDocsAtPath(t,[c])).find(d=>d.author===n);if(!h)return;const l=new sn({doc:h,format:c,replica:e,stream:o,requester:s==="upload"?"us":"them",counterpartId:a});if(l.requester==="us"){const d=`${l.share}_${l.hash}`,D=this.expectedTransferPromises.get(d);D&&D.resolve()}await this.queueTransfer(l)}cancel(){this.queue.cancel()}getReport(){return this.queue.getReport()}onReportUpdate(e){return this.reportDidUpdateBus.on(e)}transfersRequestedByUsFinished(){return this.queue.transfersRequestedByUsFinished()}registerOtherSyncerId(e){this.otherSyncerId.resolve(e)}isAlreadyQueued(e,t){return this.queue.hasQueuedTransfer(e,t)}}class qs{constructor(e){Object.defineProperty(this,"peer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:ze()}),Object.defineProperty(this,"manager",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"partner",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"syncAgents",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"syncAgentQueues",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"appetite",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"statusBus",{enumerable:!0,configurable:!0,writable:!0,value:new wt}),Object.defineProperty(this,"formats",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"transferManager",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"partnerIsFulfilled",{enumerable:!0,configurable:!0,writable:!0,value:_()}),Object.defineProperty(this,"isDoneMultiDeferred",{enumerable:!0,configurable:!0,writable:!0,value:new Hr}),Object.defineProperty(this,"heartbeatInterval",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"bumpingTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.manager=e.manager,this.peer=e.manager.peer,this.appetite=e.partner.syncAppetite,this.formats=It(e.formats),this.partner=e.partner,this.transferManager=new _o({partner:this.partner,formats:this.formats}),this.transferManager.onReportUpdate(async()=>{await this.statusBus.send(this.getStatus())}),this.heartbeatInterval=Mr(()=>{this.partner.sendEvent({kind:"HEARTBEAT"})},1e3),(async()=>{try{for await(const n of e.partner.getEvents())this.handleIncomingEvent(n)}catch(n){this.cancel(n||"Partner disconnected")}})();const t=ze();Promise.all(this.peer.shares().map(n=>br(t,n))).then(n=>{this.partner.sendEvent({kind:"DISCLOSE",salt:t,syncerId:this.id,shares:n,formats:this.formats?this.formats.map(u=>u.id):[Te.id],canRespond:!1})}),this.transferManager.transfersRequestedByUsFinished().then(async()=>{e.partner.syncAppetite!=="continuous"&&(await this.partner.sendEvent({kind:"SYNCER_FULFILLED"}),await this.partnerIsFulfilled,clearInterval(this.heartbeatInterval),await this.partner.closeConnection(),this.bumpingTimeout.close(),this.isDoneMultiDeferred.resolve())}),this.peer.onReplicasChange(async n=>{if(this.appetite==="once")return;const u=Array.from(n.keys());for(const[i,a]of this.syncAgents)u.includes(i)===!1&&(await a.cancel("Replica was removed from peer."),this.syncAgents.delete(i));const s=ze();Promise.all(u.map(i=>br(s,i))).then(i=>{this.partner.sendEvent({kind:"DISCLOSE",salt:s,syncerId:this.id,shares:i,formats:this.formats?this.formats.map(a=>a.id):[Te.id],canRespond:!0})})}),this.bumpingTimeout=new $s(()=>{this.cancel("No communication from the other peer in the last three seconds.")},Hs)}addShare(e,t,n){if(this.syncAgents.has(e))return;const u=this.peer.getReplica(e);if(!u){console.error("Couldn't get the replica for a share we had in common.");return}const s=new Eo({replica:u,formats:t,syncerManager:this.manager,transferManager:this.transferManager,initiateMessaging:n,payloadThreshold:this.partner.payloadThreshold,rangeDivision:this.partner.rangeDivision,syncAppetite:this.appetite});s.onStatusUpdate(()=>{this.statusBus.send(this.getStatus())}),this.syncAgents.set(e,s),this.transferManager.registerSyncAgent(s);const i=this.syncAgentQueues.get(e);let a;if(i)a=i;else{const o=new Ve;a=o,this.syncAgentQueues.set(e,o)}(async()=>{for await(const o of a)s.sendEvent(o)})(),(async()=>{for await(const o of s.events())await this.partner.sendEvent({to:e,...o})})()}async handleIncomingEvent(e){if(this.bumpingTimeout.bump(),this.isDoneMultiDeferred.state==="pending")switch(e.kind){case"DISCLOSE":{const t=ao(e.formats,this.formats);if(t.length===0)break;const n=new Set(e.shares),u=new Set,s=new Set;for(const a of this.peer.shares()){const o=await br(e.salt,a);n.has(o)?u.add(a):s.add(a)}const i=this.id>e.syncerId;for(const a of u)this.addShare(a,t,i);for(const a of s){const o=this.syncAgents.get(a);o&&(o.cancel("No longer in common with the other peer."),this.syncAgents.delete(a))}if(this.transferManager.registerOtherSyncerId(e.syncerId),this.appetite==="once"&&this.transferManager.allSyncAgentsKnown(),e.canRespond){const a=ze();Promise.all(this.peer.shares().map(o=>br(a,o))).then(o=>{this.partner.sendEvent({kind:"DISCLOSE",salt:a,syncerId:this.id,shares:o,formats:this.formats?this.formats.map(c=>c.id):[Te.id],canRespond:!1})})}u.size===0&&this.appetite==="once"&&this.partner.sendEvent({kind:"SYNCER_FULFILLED"});break}case"SYNCER_FULFILLED":{this.partnerIsFulfilled.resolve();break}case"HEARTBEAT":break;default:{const{to:t}=e,n=this.syncAgentQueues.get(t);if(!n){const u=new Ve;u.push(e),this.syncAgentQueues.set(t,u);break}n.push(e)}}}getStatus(){const e={};for(const[t,n]of this.syncAgents)e[t]={docs:n.getStatus(),attachments:this.transferManager.getReport()[t]||[]};return e}onStatusChange(e){return this.statusBus.on(e)}async cancel(e){this.bumpingTimeout.close(),this.isDoneMultiDeferred.reject(e);for(const[t,n]of this.syncAgents)await n.cancel();clearInterval(this.heartbeatInterval),this.transferManager.cancel(),await this.partner.closeConnection()}handleTransferRequest({shareAddress:e,path:t,author:n,source:u,kind:s,formatName:i}){if(this.isDoneMultiDeferred.state!=="pending")return;const a=this.peer.getReplica(e);if(!a)return;let o="unused";if(s==="upload"){const c=this.syncAgents.get(e);c&&(o=c.counterpartId)}return this.transferManager.handleTransferRequest({replica:a,author:n,formatName:i,kind:s,path:t,source:u,counterpartId:o})}isDone(){return this.isDoneMultiDeferred.getPromise()}}function br(r,e){return X.sha256base32(r+e+r)}class ko{constructor(e,t,n,u){Object.defineProperty(this,"concurrentTransfers",{enumerable:!0,configurable:!0,writable:!0,value:1024}),Object.defineProperty(this,"payloadThreshold",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"rangeDivision",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(this,"syncAppetite",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outgoingQueue",{enumerable:!0,configurable:!0,writable:!0,value:new Ve}),Object.defineProperty(this,"incomingQueue",{enumerable:!0,configurable:!0,writable:!0,value:new Ve}),Object.defineProperty(this,"partnerPeer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"partnerSyncer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.syncAppetite=n,this.partnerPeer=e;const{incomingQueue:s,outgoingQueue:i}=this;this.partnerSyncer=new qs({manager:e.syncerManager,formats:u,partner:{syncAppetite:n,getEvents(){return s},sendEvent(a){return i.push(a),Promise.resolve()},concurrentTransfers:1024,payloadThreshold:32,rangeDivision:32,async getDownload(a){const o=t.getReplica(a.shareAddress);if(!o)throw new b("Tried to get a receiving transfer for an unknown share.");const c=await o.replicaDriver.attachmentDriver.getAttachment(a.doc.format,a.attachmentHash);if(c&&!y(c))return await c.stream()},closeConnection(){return i.close(),Promise.resolve()},handleUploadRequest(a){return Promise.resolve(new Gt("PartnerLocal does not support uploads."))},handleTransferRequest(a,o){return Promise.resolve(new Gt("PartnerLocal does not support transfer requests."))}}})}getEvents(){return this.outgoingQueue}sendEvent(e){return this.incomingQueue.push(e),Promise.resolve()}closeConnection(){return this.incomingQueue.close(),Promise.resolve()}async getDownload(e){const t=this.partnerPeer.getReplica(e.shareAddress);if(!t)throw new b("Tried to get a receiving transfer for an unknown share.");const n=await t.replicaDriver.attachmentDriver.getAttachment(e.doc.format,e.attachmentHash);if(n&&!y(n))return await n.stream()}handleUploadRequest(e){return Promise.resolve(new Gt("PartnerLocal does not support uploads."))}handleTransferRequest(e,t){return Promise.resolve(new Gt("PartnerLocal does not support transfer requests."))}}class Po{constructor(e){Object.defineProperty(this,"syncAppetite",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"concurrentTransfers",{enumerable:!0,configurable:!0,writable:!0,value:24}),Object.defineProperty(this,"payloadThreshold",{enumerable:!0,configurable:!0,writable:!0,value:8}),Object.defineProperty(this,"rangeDivision",{enumerable:!0,configurable:!0,writable:!0,value:8}),Object.defineProperty(this,"isSecure",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"wsUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"socket",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"incomingQueue",{enumerable:!0,configurable:!0,writable:!0,value:new Ve}),Object.defineProperty(this,"socketIsReady",{enumerable:!0,configurable:!0,writable:!0,value:_()}),this.syncAppetite=e.appetite;const t=new URL(e.url),n=`${t.host}${t.pathname==="/"?"":t.pathname}`;this.isSecure=t.protocol==="https:"||t.protocol==="wss:",this.wsUrl=`${this.isSecure?"wss://":"ws://"}${n}/'`;const u=new URL(e.appetite,this.wsUrl);this.socket=new Tt(u.toString()),this.socket.onopen=()=>{this.socketIsReady.resolve()},this.socket.binaryType="arraybuffer",this.socket.onmessage=s=>{this.incomingQueue.push(JSON.parse(s.data))},this.socket.onclose=()=>{this.incomingQueue.close()},this.socket.onerror=s=>{if("error"in s){this.incomingQueue.close({withError:s.error});return}this.incomingQueue.close({withError:new De("Websocket error.")})}}async sendEvent(e){if(await this.socketIsReady,!(this.socket.readyState===this.socket.CLOSED||this.socket.readyState===this.socket.CLOSING))return this.socket.send(JSON.stringify(e))}getEvents(){return this.incomingQueue}closeConnection(){return this.socket.close(),Promise.resolve()}getDownload(e){const t=new URL(`${e.syncerId}/download/${e.shareAddress}/${e.doc.format}/${e.doc.author}${e.doc.path}`,this.wsUrl),n=go(t.toString(),u=>u.data instanceof ArrayBuffer?new Uint8Array(u.data):null);return Promise.resolve(n)}handleUploadRequest(e){const t=new URL(`${e.syncerId}/upload/${e.shareAddress}/${e.doc.format}/${e.doc.author}${e.doc.path}`,this.wsUrl),n=mo(t.toString(),u=>u);return Promise.resolve(n)}handleTransferRequest(e,t){return Promise.resolve(new Gt("SyncDriverWebClient does not support external transfer requests."))}}function To(r,e){const[t,n]=r.split(" "),[u,s]=e.split(" "),i=parseInt(t),a=parseInt(u);return i>a?1:i<a?-1:n>s?1:n<s?-1:0}const Io={lift:r=>Sa(r),combine:(r,e)=>r+e,neutral:BigInt(0)};class Oo extends _a{constructor(){super(Io,To)}}class Ro{constructor(){Object.defineProperty(this,"messagingModes",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"eagerMessageThumbnails",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"haveTimeouts",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}getMode(e){const t=this.messagingModes.get(e);if(t)return t;const n=this.messagingModes.size===0?"EAGER":"LAZY";return this.messagingModes.set(e,n),"EAGER"}onEagerMessage(e,t){const n=this.haveTimeouts.get(t.thumbnail);return n?(clearTimeout(n),!1):this.eagerMessageThumbnails.has(t.thumbnail)?(this.messagingModes.set(e,"LAZY"),!0):(this.eagerMessageThumbnails.add(t.thumbnail),!1)}onLazyMessage(e,t){if(!this.haveTimeouts.has(e.thumbnail)){const n=dt(()=>{t(e.thumbnail)},5);this.haveTimeouts.set(e.thumbnail,n)}}onGraftMessage(e){this.messagingModes.set(e,"EAGER")}onPrune(e){this.messagingModes.set(e,"LAZY")}}class Mo{constructor(e){Object.defineProperty(this,"syncers",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"syncerEventBus",{enumerable:!0,configurable:!0,writable:!0,value:new wt}),Object.defineProperty(this,"peer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"docThumbnailTreeAndLookup",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"hasher",{enumerable:!0,configurable:!0,writable:!0,value:new vn}),Object.defineProperty(this,"plumTrees",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),this.peer=e}addPartner(e,t,n){const u=new qs({manager:this,partner:e,formats:n});return this.syncers.set(u.id,{syncer:u,description:t}),this.syncerEventBus.send(this.syncers),u}getSyncers(){return this.syncers}getDocThumbnailTreeAndDocLookup(e,t){const n=t.map(l=>l.id),u=`${e} ${n}`,s=this.docThumbnailTreeAndLookup.get(u);if(s){const[l,d]=s;return{tree:l,lookup:d,treeIsReady:Promise.resolve(!0)}}const i=this.peer.getReplica(e);if(!i)throw new De("A DocThumbnailTree was requested for a share the peer doesn't know about, big problem!");const a=this.hasher,o=i.getQueryStream({historyMode:"all",orderBy:"localIndex ASC"},"everything",t),c=new Oo,f={},h=_();return o.pipeTo(new Ce({write(l){if(l.kind==="processed_all_existing"){h.resolve();return}a.reset(),a.update(`${l.doc.path} ${l.doc.author}`);const d=a.digest().toString(16),D=`${l.doc.timestamp} ${d}`;(l.kind==="existing"||l.kind==="success")&&(f[d]=[l.doc.timestamp,l.doc.path,l.doc.author],c.insert(D)),l.kind==="expire"&&(delete f[d],c.remove(D))}})),{tree:c,lookup:f,treeIsReady:h}}getPlumTree(e){const t=this.plumTrees.get(e);if(t)return t;const n=new Ro;return this.plumTrees.set(e,n),n}onSyncersChange(e){return this.syncerEventBus.on(e)}}const nt=new ce("peer","orangeRed"),Vt=JSON.stringify;class qr{constructor(){Object.defineProperty(this,"replicaEventBus",{enumerable:!0,configurable:!0,writable:!0,value:new wt}),Object.defineProperty(this,"syncerManager",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicaMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),nt.debug("constructor"),this.syncerManager=new Mo(this)}hasShare(e){return this.replicaMap.has(e)}shares(){const e=[...this.replicaMap.keys()];return e.sort(),e}replicas(){const e=[...this.replicaMap.keys()];return e.sort(),e.map(t=>this.replicaMap.get(t))}size(){return this.replicaMap.size}getReplica(e){return this.replicaMap.get(e)}async addReplica(e){if(nt.debug(`addReplica(${Vt(e.share)})`),this.replicaMap.has(e.share))throw nt.debug("already had a replica with that share"),new Error(`Peer.addReplica: already has a replica with share ${Vt(e.share)}.  Don't add another one.`);this.replicaMap.set(e.share,e),await this.replicaEventBus.send(this.replicaMap),nt.debug("    ...addReplica: done")}async removeReplicaByShare(e){nt.debug(`removeReplicaByShare(${Vt(e)})`),this.replicaMap.delete(e),await this.replicaEventBus.send(this.replicaMap)}async removeReplica(e){const t=this.replicaMap.get(e.share);e===t?(nt.debug(`removeReplica(${Vt(e.share)})`),await this.removeReplicaByShare(e.share)):nt.debug(`removeReplica(${Vt(e.share)}) -- same share but it's a different instance now; ignoring`)}sync(e,t=!1,n){try{const u=new Po({url:e,appetite:t?"continuous":"once"});return this.syncerManager.addPartner(u,e,n)}catch{if(e instanceof qr){const u=new ko(e,this,t?"continuous":"once",n);return this.syncerManager.addPartner(u,"Local",n)}console.error("Provided an invalid target for syncing to a peer:",e);return}}addSyncPartner(e,t,n){return this.syncerManager.addPartner(e,t,n)}getSyncers(){return this.syncerManager.getSyncers()}onReplicasChange(e){return this.replicaEventBus.on(e)}onSyncersChange(e){return this.syncerManager.onSyncersChange(e)}discover(e){const t=this;return{async*[Symbol.asyncIterator](){for await(const n of e.events){if(n.kind==="SERVICE_STOPPED")break;if(n.kind==="PEER_EXITED"){yield n;continue}if(n.kind==="PEER_INITIATED_SYNC"){const u=await n.begin(t);yield{kind:"PEER_INITIATED_SYNC",description:n.description,syncer:u};continue}yield{kind:"PEER_DISCOVERED",description:n.description,sync:async u=>await n.begin(t,u!=null&&u.syncContinuously?"continuous":"once")}}}}}}const jo={historyMode:"latest",orderBy:"path ASC",startAfter:void 0,limit:void 0,filter:void 0,formats:["es.5"]},ut=new ce("query","green");function Ws(r){var u,s,i,a;const e={...jo,...r},t={query:{limit:0},isValid:!1,willMatch:"nothing"};if(e.limit!==void 0&&e.limit<0)return ut.debug("cleanUpQuery: unreasonable limit - returning empty invalid query",t),t;if((u=e.orderBy)!=null&&u.startsWith("path")&&((s=e.startAfter)==null?void 0:s.localIndex)!==void 0)return ut.debug('cleanUpQuery: orderBy is "path" but startAfter is not compatible - returning empty invalid query',t),t;if((i=e.orderBy)!=null&&i.startsWith("localIndex")&&((a=e.startAfter)==null?void 0:a.path)!==void 0)return ut.debug('cleanUpQuery: orderBy is "localIndex" but startAfter is not compatible - returning empty invalid query',t),t;if(e.historyMode!==void 0&&e.historyMode!=="all"&&e.historyMode!=="latest")return ut.debug(`cleanUpQuery: unknown historyMode ${JSON.stringify(e.historyMode)} - returning empty invalid query`,t),t;if(e.orderBy!==void 0&&["path ASC","path DESC","localIndex ASC","localIndex DESC"].indexOf(e.orderBy)===-1)return ut.debug(`cleanUpQuery: unrecognized orderBy value ${JSON.stringify(e.orderBy)} - returning empty invalid query`,t),t;let n=e.historyMode==="all"?"all":"all-latest";if(e.filter!==void 0&&!Pr(e.filter,{})&&(n="some"),e.startAfter!==void 0&&!Pr(e.startAfter,{})&&(n="some"),e.limit!==void 0&&(e.limit>0&&(n="some"),e.limit===0&&(n="nothing")),e.filter!==void 0){const o=e.filter;o.path&&o.pathStartsWith&&!o.path.startsWith(o.pathStartsWith)&&(n="nothing"),o.path&&o.pathEndsWith&&!o.path.endsWith(o.pathEndsWith)&&(n="nothing"),o.timestamp&&o.timestampGt&&!(o.timestamp>o.timestampGt)&&(n="nothing"),o.timestamp&&o.timestampLt&&!(o.timestamp<o.timestampLt)&&(n="nothing"),o.timestampGt&&o.timestampLt&&!(o.timestampLt+1<o.timestampGt)&&(n="nothing")}if(n==="nothing"){let o={query:{limit:0},isValid:!0,willMatch:"nothing"};return ut.debug("cleanUpQuery - this query will match nothing, so returning a simpler query that also matches nothing",o),o}return ut.debug(`cleanUpQuery - query is ok!  willMatch = ${n}`),{query:e,isValid:!0,willMatch:n}}function _n(r,e){return!(e.path!==void 0&&r.path!==e.path||e.pathStartsWith!==void 0&&!r.path.startsWith(e.pathStartsWith)||e.pathEndsWith!==void 0&&!r.path.endsWith(e.pathEndsWith)||e.author!==void 0&&r.author!==e.author||e.timestamp!==void 0&&r.timestamp!==e.timestamp||e.timestampGt!==void 0&&!(r.timestamp>e.timestampGt)||e.timestampLt!==void 0&&!(r.timestamp<e.timestampLt))}new ce("query helpers","gold");var Ae;(function(r){r[r.LT=-1]="LT",r[r.EQ=0]="EQ",r[r.GT=1]="GT"})(Ae||(Ae={}));function pn(r,e,t="ASC"){if(Array.isArray(r)&&ms(r,e)||typeof r=="object"&&Pr(r,e)||r===e)return Ae.EQ;if(t==="ASC"||t===void 0)return r<e?Ae.LT:Ae.GT;if(t==="DESC")return r>e?Ae.LT:Ae.GT;throw new Error("unexpected sort order to compareBasic: "+JSON.stringify(t))}function kn(r,e,t){let n=Math.min(r.length,e.length);for(let i=0;i<n;i++){let a=(t==null?void 0:t[i])??"ASC",o=pn(r[i],e[i],a);if(o!==Ae.EQ)return o}if(r.length===e.length)return Ae.EQ;let u=Math.min(r.length,e.length),s=(t==null?void 0:t[u])??"ASC";return pn(r.length,e.length,s)}function pu(r,e="ASC"){return(t,n)=>pn(t[r],n[r],e)}const No=JSON.stringify,he=new ce("replica","gold"),fe=new ce("replica set","gold"),ie=new ce("replica ingest","gold");function mu(r,e){return kn([r.timestamp,r.signature],[e.timestamp,r.signature],["DESC","ASC"])}class Lo{constructor({driver:e,config:t}){var u;Object.defineProperty(this,"replicaId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"share",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicaDriver",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"formatsConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_isClosed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ingestLockStream",{enumerable:!0,configurable:!0,writable:!0,value:new Us}),Object.defineProperty(this,"eventMultiStream",{enumerable:!0,configurable:!0,writable:!0,value:new po("kind",!0)}),Object.defineProperty(this,"eventWriter",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbackSink",{enumerable:!0,configurable:!0,writable:!0,value:new Ls}),Object.defineProperty(this,"eraseInterval",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"expireEventTimeouts",{enumerable:!0,configurable:!0,writable:!0,value:new Map});const n=bt(e.docDriver.share);if(y(n))throw n;he.debug(`constructor.  driver = ${(u=e==null?void 0:e.constructor)==null?void 0:u.name}`),this.replicaId="replica-"+ze(),this.share=e.docDriver.share,this.replicaDriver=e,this.formatsConfig=t||{},this.eventWriter=this.eventMultiStream.getWritableStream().getWriter(),this.eventMultiStream.getReadableStream("*").pipeTo(new Ce(this.callbackSink)),this.eraseInterval=Mr(()=>{this.isClosed()?clearInterval(this.eraseInterval):this.pruneExpiredDocsAndAttachments()},1e3*60*60)}isClosed(){return this._isClosed}async close(e){if(he.debug("closing..."),this._isClosed)throw new K;await this.ingestLockStream.close();for(const t of this.expireEventTimeouts.values())clearTimeout(t);return he.debug("    sending willClose blockingly..."),await this.eventWriter.write({kind:"willClose"}),he.debug("    marking self as closed..."),e===!1&&await this.pruneExpiredDocsAndAttachments(),await this.replicaDriver.attachmentDriver.clearStaging(),this._isClosed=!0,he.debug(`    closing ReplicaDriver (erase = ${e})...`),await this.replicaDriver.docDriver.close(e),await this.replicaDriver.attachmentDriver.close(e),clearInterval(this.eraseInterval),he.debug("    sending didClose nonblockingly..."),await this.eventWriter.write({kind:"didClose"}),he.debug("...closing done"),Promise.resolve()}async getConfig(e){if(this._isClosed)throw new K;return await this.replicaDriver.docDriver.getConfig(e)}async setConfig(e,t){if(this._isClosed)throw new K;return await this.replicaDriver.docDriver.setConfig(e,t)}async listConfigKeys(){if(this._isClosed)throw new K;return await this.replicaDriver.docDriver.listConfigKeys()}async deleteConfig(e){if(this._isClosed)throw new K;return await this.replicaDriver.docDriver.deleteConfig(e)}getMaxLocalIndex(){if(this._isClosed)throw new K;return this.replicaDriver.docDriver.getMaxLocalIndex()}getAllDocs(e){return he.debug("getAllDocs()"),this.queryDocs({historyMode:"all",orderBy:"path ASC"},e)}getLatestDocs(e){return he.debug("getLatestDocs()"),this.queryDocs({historyMode:"latest",orderBy:"path ASC"},e)}getAllDocsAtPath(e,t){return he.debug(`getAllDocsAtPath("${e}")`),this.queryDocs({historyMode:"all",orderBy:"path ASC",filter:{path:e}},t)}async getLatestDocAtPath(e,t){he.debug(`getLatestDocsAtPath("${e}")`);const n=await this.queryDocs({historyMode:"latest",orderBy:"path ASC",filter:{path:e}},t?[t]:void 0);if(n.length!==0)return n[0]}async queryDocs(e={},t){if(he.debug("queryDocs",e),this._isClosed)throw new K;const n=It(t);return await this.replicaDriver.docDriver.queryDocs({...e,formats:n.map(u=>u.id)})}async queryPaths(e={},t){const n=await this.queryDocs(e,t),u=new Set(n.map(({path:s})=>s));return Array.from(u).sort()}async queryAuthors(e={},t){const n=await this.queryDocs(e,t),u=new Set(n.map(({author:s})=>s));return Array.from(u).sort()}async set(e,t,n=Te){if(fe.debug("set",t),this._isClosed)throw new K;fe.debug("...deciding timestamp: getting latest doc at the same path (from any author)");const u=await this.getLatestDocAtPath(t.path);let s;typeof t.timestamp=="number"?s=t.timestamp:u===void 0?s=uu():s=Math.max(uu(),u.timestamp+1),fe.debug("...generating doc");let i;if(u){const c=n.removeExtraFields(u);y(c)||(i=c.doc)}const a=await n.generateDocument({keypair:e,input:{...t,format:n.id},share:this.share,timestamp:s,prevLatestDoc:i,config:this.formatsConfig[n.id]});if(y(a))return{kind:"failure",reason:"invalid_document",err:a};if(fe.debug("...signature =",a.doc.signature),a.attachment){const c=await this.replicaDriver.attachmentDriver.stage(n.id,a.attachment);if(y(c))return{kind:"failure",reason:"invalid_document",err:c};const f=await n.updateAttachmentFields(e,a.doc,c.size,c.hash,this.formatsConfig[n.id]);if(y(f))return await c.reject(),{kind:"failure",reason:"invalid_document",err:f};fe.debug("...ingesting attachment"),fe.debug("-----------------------"),await c.commit(),await this.eventWriter.write({kind:"attachment_ingest",doc:f,hash:c.hash,size:c.size,sourceId:"local"}),fe.debug("...done ingesting attachment"),fe.debug("...ingesting"),fe.debug("-----------------------");const h=await this.ingest(n,f,"local");return fe.debug("...done ingesting"),fe.debug("...set is done."),h}fe.debug("...ingesting"),fe.debug("-----------------------");const o=await this.ingest(n,a.doc,"local");return fe.debug("...done ingesting"),fe.debug("...set is done."),o}async ingest(e,t,n){if(ie.debug("ingest",t),this._isClosed)throw new K;ie.debug("...removing extra fields");const u=e.removeExtraFields(t);if(y(u))return{kind:"failure",reason:"invalid_document",err:u};t=u.doc;const s=u.extras;Object.keys(s).length>0&&ie.debug(`...extra fields found: ${No(s)}`);const i=await e.checkDocumentIsValid(t);if(y(i))return{kind:"failure",reason:"invalid_document",err:i};const a=_();return await this.ingestLockStream.run(async()=>{ie.debug(" >> ingest: start of protected region"),ie.debug("  > getting other history docs at the same path by any author");const o=await this.getAllDocsAtPath(t.path,[e]);ie.debug(`  > ...got ${o.length}`),ie.debug("  > getting prevLatest and prevSameAuthor");const c=o[0]??null,f=o.filter(m=>m.author===t.author)[0]??null;ie.debug("  > checking if new doc is latest at this path"),o.push(t),o.sort(mu);const h=o[0]===t;if(ie.debug(`  > ...isLatest: ${h}`),!h&&f!==null){ie.debug("  > new doc is not latest and there is another one from the same author...");const m=mu(t,f);if(m===Ae.GT){ie.debug("  > new doc is GT prevSameAuthor, so it is obsolete"),a.resolve({kind:"nothing_happened",reason:"obsolete_from_same_author",doc:t});return}if(m===Ae.EQ){ie.debug("  > new doc is EQ prevSameAuthor, so it is redundant (already_had_it)"),a.resolve({kind:"nothing_happened",reason:"already_had_it",doc:t});return}}ie.debug("  > upserting into ReplicaDriver...");const l=await this.replicaDriver.docDriver.upsert(t);ie.debug("  > ...done upserting into ReplicaDriver"),ie.debug("  > ...getting ReplicaDriver maxLocalIndex...");const d=await this.replicaDriver.docDriver.getMaxLocalIndex();ie.debug(" >> ingest: end of protected region, returning a WriteEvent from the lock");const D={kind:"success",maxLocalIndex:d,doc:l,docIsLatest:h,prevDocFromSameAuthor:f,prevLatestDoc:c,sourceId:n};if(a.resolve(D),await this.eventWriter.write(D),l.deleteAfter){const m=`${l.path}|${l.author}`,p=this.expireEventTimeouts.get(m);p&&clearTimeout(p);const w=l.deleteAfter/1e3-Date.now();this.expireEventTimeouts.set(m,dt(()=>{this.eventWriter.write({kind:"expire",doc:l})},w))}}),a}async overwriteAllDocsByAuthor(e,t){const n=Du(t);if(he.debug(`overwriteAllDocsByAuthor("${e.address}")`),this._isClosed)throw new K;const u=await this.queryDocs({filter:{author:e.address},historyMode:"all"},[n]);he.debug(`    ...found ${u.length} docs to overwrite`);let s=0,i=0;for(const a of u){const o=await this.wipeDocument(e,a,Du(t));if(y(o))return o;s+=1}return he.debug(`    ...done; ${s} overwritten to be empty; ${i} were already empty; out of total ${u.length} docs`),s}async wipeDocAtPath(e,t,n=Te){const u=await this.getLatestDocAtPath(t,n);return u?this.wipeDocument(e,u,n):new b("No document exists at that path")}async wipeDocument(e,t,n){const u={...t,timestamp:Math.max(t.timestamp+1,Date.now()*1e3),author:e.address},s=await n.wipeDocument(e,u,this.formatsConfig[n.id]);if(y(s))return{kind:"failure",err:s,reason:"invalid_document"};const i=await this.ingest(n,s,"local");if(i.kind==="success"){const a=n.getAttachmentInfo(t);if(!y(a)){const o=await this.replicaDriver.attachmentDriver.erase(n.id,a.hash);y(o)||await this.eventWriter.write({kind:"attachment_prune",format:n.id,hash:a.hash})}}return i}async pruneExpiredDocsAndAttachments(e=$r){const t=await this.replicaDriver.docDriver.eraseExpiredDocs();for(const i of t)await this.eventWriter.write({kind:"expire",doc:i});const n=Ot(e),u={};await this.getQueryStream({historyMode:"all",orderBy:"localIndex ASC"},"existing",e).pipeTo(new Ce({write(i){if(i.kind==="existing"){const a=n[i.doc.format],o=a.getAttachmentInfo(i.doc);if(!y(o)){const c=u[a.id];c?c.add(o.hash):u[a.id]=new Set([o.hash])}}}}));const s=await this.replicaDriver.attachmentDriver.filter(u);for(const i of s)await this.eventWriter.write({kind:"attachment_prune",format:i.format,hash:i.hash})}getEventStream(e="*"){return this.eventMultiStream.getReadableStream(e)}getQueryStream(e={},t,n){const u=this.queryDocs.bind(this),s=this.getEventStream.bind(this);return new Dt({async start(i){if(t==="existing"||t==="everything"){const c=await u(e,n);for(const f of c)i.enqueue({kind:"existing",doc:f})}if(i.enqueue({kind:"processed_all_existing"}),t==="existing"){i.close();return}const o=s().getReader();for(;;){const{done:c,value:f}=await o.read();if(c)return;if(f.kind==="expire"||f.kind==="success"){if(e.filter&&_n(f.doc,e.filter)){i.enqueue(f);continue}i.enqueue(f);continue}f.kind==="didClose"&&i.close()}}})}onEvent(e){return this.callbackSink.onWrite(e)}async ingestAttachment(e,t,n,u){if(this._isClosed)throw new K;const s=e.removeExtraFields(t);if(y(s))return Promise.resolve(s);t=s.doc;const i=await e.checkDocumentIsValid(t);if(y(i))return Promise.resolve(i);const a=await this.getAttachment(t,e);if(a&&!y(a))return!1;const o=e.getAttachmentInfo(t);if(y(o))return Promise.resolve(o);const c=await this.replicaDriver.attachmentDriver.stage(t.format,n);return y(c)?c:c.hash!==o.hash?(await c.reject(),new b("Attachment's hash did not match the document's")):c.size!==o.size?(await c.reject(),new b("Attachment's size did not match the document's")):(await c.commit(),await this.eventWriter.write({kind:"attachment_ingest",doc:t,hash:c.hash,size:c.size,sourceId:u}),!0)}getAttachment(e,t=Te){if(e.deleteAfter&&e.deleteAfter<Date.now()*1e3)return Promise.resolve(new b("This document has expired"));const n=t.getAttachmentInfo(e);return y(n)?Promise.resolve(n):this.replicaDriver.attachmentDriver.getAttachment(e.format,n.hash)}addAttachments(e,t){const n=It(t),u={};for(const i of n)u[i.id]=i;const s=e.map(i=>new Promise(a=>{const c=u[i.format].getAttachmentInfo(i);if(!y(c))this.replicaDriver.attachmentDriver.getAttachment(i.format,c.hash).then(f=>{a({...i,attachment:f})});else return a({...i,attachment:c})}));return Promise.all(s)}}class Uo extends Lo{constructor(e){super({driver:e.driver,config:{"es.5":{shareSecret:e.shareSecret}}})}}const st=new ce("replica-cache","green");function gu({_localIndex:r}){return r}function bu(r,e){const t=[];for(const n of e)if(!(r.orderBy==="path ASC"&&r.startAfter!==void 0&&r.startAfter.path!==void 0&&n.path<=r.startAfter.path)&&!(r.orderBy==="path DESC"&&r.startAfter!==void 0&&r.startAfter.path!==void 0&&n.path>=r.startAfter.path)&&!(r.orderBy==="localIndex ASC"&&r.startAfter!==void 0&&r.startAfter.localIndex!==void 0&&(n._localIndex||0)<=r.startAfter.localIndex)&&!(r.orderBy==="localIndex DESC"&&r.startAfter!==void 0&&r.startAfter.localIndex!==void 0&&(n._localIndex||0)>=r.startAfter.localIndex)&&(t.push(n),r.limit!==void 0&&t.length>=r.limit))break;return t}class $o{constructor(e,t,n){Object.defineProperty(this,"version",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"replica",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"docCache",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"timeToLive",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onCacheUpdatedCallbacks",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"closed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"onFireCacheUpdatedsWrapper",{enumerable:!0,configurable:!0,writable:!0,value:a=>a()}),Object.defineProperty(this,"attachmentCache",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),this.replica=e,this.timeToLive=t||1e3,n&&(this.onFireCacheUpdatedsWrapper=n);const u=this.onReplicaEvent.bind(this),s=this.close.bind(this),i=this.isClosed.bind(this);this.replica.getEventStream("*").pipeTo(new Ce({async write(a){a.kind==="attachment_ingest"||a.kind==="success"||a.kind==="expire"?await u(a):a.kind==="willClose"&&!i()&&await s()}})).catch(()=>{})}async close(){if(this.closed)throw new Je;this.closed=!0,await Promise.all(Array.from(this.docCache.values()).map(e=>e.close())),this.docCache.clear(),this.onCacheUpdatedCallbacks.clear()}isClosed(){return this.closed}getAllDocs(e){return this.queryDocs({historyMode:"all",orderBy:"path DESC"},e)}getLatestDocs(e){return this.queryDocs({historyMode:"latest",orderBy:"path DESC"},e)}getAllDocsAtPath(e,t){return this.queryDocs({historyMode:"all",orderBy:"path DESC",filter:{path:e}},t)}getLatestDocAtPath(e,t){const n=this.queryDocs({historyMode:"latest",orderBy:"path DESC",filter:{path:e}},t?[t]:void 0);if(n.length!==0)return n[0]}queryDocs(e={},t){if(this.closed)throw new Je;if(this.replica.isClosed())throw new K;const u={...e,formats:(t||$r).map(D=>D.id)},s=Ws(u);if(s.willMatch==="nothing")return[];const i=Ui(s.query),a=this.docCache.get(i);if(a)return Date.now()>a.expires&&this.replica.queryDocs(e,t).then(D=>{const m=D.map(gu).sort(),p=a.docs.map(gu).sort();ms(m,p)||(this.docCache.set(i,{stream:a.stream,close:a.close,docs:D,expires:Date.now()+this.timeToLive}),st.debug("Updated cache because result expired."),this.fireOnCacheUpdateds())}),a.docs;const o=this.replica.getQueryStream(e,"new",t),c=new Ls,f=c.onWrite(D=>{(D.kind==="existing"||D.kind==="success")&&(st.debug({doc:D.doc.path,queryString:i}),this._updateCache(i,D.doc))}),h=new Ce(c),l=new AbortController;o.pipeTo(h,{signal:l.signal});const d=()=>{f()};return this.docCache.set(i,{stream:o,docs:[],expires:Date.now()+this.timeToLive,close:d}),this.replica.queryDocs(u).then(D=>{this.docCache.set(i,{stream:o,close:d,docs:D,expires:Date.now()+this.timeToLive}),st.debug("Updated cache with a new entry."),this.fireOnCacheUpdateds()}),[]}queryPaths(e={},t){const n=this.queryDocs(e,t),u=new Set(n.map(({path:s})=>s));return Array.from(u).sort()}queryAuthors(e={},t){const n=this.queryDocs(e,t),u=new Set(n.map(({author:s})=>s));return Array.from(u).sort()}_updateCache(e,t){const n=this.docCache.get(e);if(!n)return;const u=JSON.parse(e),s=()=>{const d=[...n.docs,t];this.docCache.set(e,{...n,docs:bu(u,d)}),this.fireOnCacheUpdateds()},i=({exact:d})=>{const D=n.docs.map(m=>d&&m.path===t.path&&m.author===t.author||!d&&m.path===t.path?t:m);this.docCache.set(e,{...n,docs:bu(u,D)}),this.fireOnCacheUpdateds()},a=n.docs.filter(d=>d.path===t.path),o=n.docs.filter(d=>d.path===t.path&&d.author===t.author);if(a.length===0){(u.filter&&_n(t,u.filter)||!u.filter)&&(st.debug("Updated cache after appending a doc to a entry with matching filter."),s());return}if((u.historyMode||"latest")==="all"){if(o.length===0){st.debug("Updated cache after appending a version of a doc to a historyMode: all query."),s();return}st.debug("Updated cache after replacing a version of a doc in a historyMode: all query."),i({exact:!0});return}const f=a[0],h=t.author!==(f==null?void 0:f.author)||!Pr(t,f),l=t.timestamp>f.timestamp;if(h&&l){st.debug("Updated cache after replacing a doc with its latest version."),i({exact:!1});return}}fireOnCacheUpdateds(){this.version++,this.onFireCacheUpdatedsWrapper(()=>{this.onCacheUpdatedCallbacks.forEach(e=>{e()})})}onCacheUpdated(e){if(this.closed)throw new Je;if(this.replica.isClosed())throw new K;return this.onCacheUpdatedCallbacks.add(e),()=>{this.onCacheUpdatedCallbacks.delete(e)}}set(e,t,n){if(this.closed)throw new Je;return this.replica.set(e,t,n)}overwriteAllDocsByAuthor(e,t){if(this.closed)throw new Je;if(this.replica.isClosed())throw new K;return this.replica.overwriteAllDocsByAuthor(e,t)}wipeDocAtPath(e,t,n=Te){if(this.closed)throw new Je;return this.replica.wipeDocAtPath(e,t,n)}async onReplicaEvent(e){const t=`${e.doc.path}|${e.doc.author}`,n=this.attachmentCache.get(t);if(!n)return;const u=await this.replica.getAttachment(e.doc,n.format);this.attachmentCache.set(t,{expires:Date.now()+this.timeToLive,attachment:u,format:n.format}),this.fireOnCacheUpdateds()}getAttachment(e,t=Te){if(this.closed)throw new Je;if(this.replica.isClosed())throw new K;const n=t.getAttachmentInfo(e);if(y(n))return n;const u=`${e.path}|${e.author}`,s=this.attachmentCache.get(u);if(s)return Date.now()>s.expires&&this.replica.getAttachment(e,t).then(i=>{this.attachmentCache.set(u,{expires:Date.now()+this.timeToLive,attachment:i,format:t}),this.fireOnCacheUpdateds()}),e.deleteAfter&&Date.now()*1e3>e.deleteAfter?new b("This document has expired"):s.attachment;this.attachmentCache.set(u,{attachment:void 0,expires:Date.now()+this.timeToLive,format:t}),this.replica.getAttachment(e,t).then(i=>{this.attachmentCache.set(u,{expires:Date.now()+this.timeToLive,attachment:i,format:t}),this.fireOnCacheUpdateds()})}addAttachments(e,t){const n=[],u=Ot(t);for(const s of e){const i=this.getAttachment(s,u[s.format]);n.push({...s,attachment:i})}return n}}new ce("storage driver async memory","yellow");async function Ho(r){let e=new Uint8Array;return await r.pipeTo(new Ce({write(t){const n=new Uint8Array(e.length+t.length);n.set(e),n.set(t,e.length),e=n}})),e}async function qo(r){try{const e=new URL(r),t=e.hostname.length>0?e.hostname:e.pathname.replaceAll("/",""),n=Sn(t);if(y(n))return new b("Invitation did not include a valid share address.");const u=new URLSearchParams(e.search),s=u.get("invite"),i=u.get("v");if(s===null)return new b("Not an invitation URL");if(i===null)return new b("Invitation version not specified.");if(i!=="2")return new b(`Invitation version is ${i}, expected version 2.`);const a=u.getAll("server");for(const c of a)try{new URL(c)}catch{return new b(`Invitation's servers included a malformed URL: ${c}`)}const o=u.get("secret");if(o){const c=await X.checkKeypairIsValid({shareAddress:t,secret:o});if(y(c))return new b(`Invitation contains the wrong secret for share ${t}.`)}return{shareAddress:t,secret:o||void 0,servers:a}}catch{return new b("Could not parse the invitation URL.")}}const Wo="earthstar",wr="current_author",zt="shares",Qt="share_secrets",Kt="servers";class Vo{constructor(e){Object.defineProperty(this,"namespace",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"storage",{enumerable:!0,configurable:!0,writable:!0,value:localStorage}),Object.defineProperty(this,"authorChangedCbs",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"sharesChangedCbs",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"shareSecretsChangedCbs",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"serversChangedCbs",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),this.namespace=e==null?void 0:e.namespace,e!=null&&e.sessionOnly&&(this.storage=sessionStorage),addEventListener("storage",t=>{switch(t.key){case te(wr,this.namespace):{this.fireAuthorEvent();break}case te(zt,this.namespace):{this.fireSharesEvent();break}case te(Qt,this.namespace):{this.fireSecretsEvent();break}case te(Kt,this.namespace):{this.fireServersEvent();break}}})}get author(){const e=te(wr,this.namespace);return yr(this.storage,e,zo)||null}set author(e){const t=te(wr,this.namespace);this.storage.setItem(t,JSON.stringify(e)),this.fireAuthorEvent()}get shares(){const e=te(zt,this.namespace);return yr(this.storage,e,Qo)||[]}addShare(e){if(y(bt(e)))return new b("Not a valid share");const t=te(zt,this.namespace),n=new Set([...this.shares,e]),u=Array.from(n);return this.storage.setItem(t,JSON.stringify(u)),this.fireSharesEvent(),u}removeShare(e){const t=this.shares,n=t.findIndex(s=>s===e);if(n===-1)return new b("That share is not known yet");t.splice(n,1);const u=te(zt,this.namespace);return this.storage.setItem(u,JSON.stringify(t)),this.fireSharesEvent(),t}get shareSecrets(){const e=te(Qt,this.namespace);return yr(this.storage,e,Ko)||{}}async addSecret(e,t){if(!this.shares.find(i=>e===i))return new b("This share is not yet known.");if(y(await X.checkKeypairIsValid({shareAddress:e,secret:t})))return new b("Not the right secret for this share.");const u=te(Qt,this.namespace),s={...this.shareSecrets,[e]:t};return this.storage.setItem(u,JSON.stringify(s)),this.fireSecretsEvent(),s}removeSecret(e){const t=this.shareSecrets;if(!t[e])return new b("Unknown share");const u=te(Qt,this.namespace),s={...t};return delete s[e],this.storage.setItem(u,JSON.stringify(s)),this.fireSecretsEvent(),s}get servers(){const e=te(Kt,this.namespace);return yr(this.storage,e,Go)||[]}addServer(e){try{const t=new URL(e),n=new Set([...this.servers,t.toString()]),u=Array.from(n),s=te(Kt,this.namespace);return this.storage.setItem(s,JSON.stringify(u)),this.fireServersEvent(),u}catch{return new b("Not a valid URL.")}}removeServer(e){try{const t=new URL(e),n=this.servers,u=n.findIndex(i=>i===t.toString());if(u===-1)return new b("That server is not known yet");n.splice(u,1);const s=te(Kt,this.namespace);return this.storage.setItem(s,JSON.stringify(n)),this.fireServersEvent(),n}catch{return new b("Not a valid URL")}}clear(){const e=te(wr,this.namespace);this.storage.setItem(e,JSON.stringify(null));const t=te(zt,this.namespace);this.storage.setItem(t,JSON.stringify([]));const n=te(Qt,this.namespace);this.storage.setItem(n,JSON.stringify({}));const u=te(Kt,this.namespace);this.storage.setItem(u,JSON.stringify([])),this.fireAuthorEvent(),this.fireSharesEvent(),this.fireSecretsEvent(),this.fireServersEvent()}onAuthorChanged(e){return this.authorChangedCbs.add(e),()=>{this.authorChangedCbs.delete(e)}}onSharesChanged(e){return this.sharesChangedCbs.add(e),()=>{this.sharesChangedCbs.delete(e)}}onShareSecretsChanged(e){return this.shareSecretsChangedCbs.add(e),()=>{this.shareSecretsChangedCbs.delete(e)}}onServersChanged(e){return this.serversChangedCbs.add(e),()=>{this.serversChangedCbs.delete(e)}}getPeer({sync:e,onCreateReplica:t}){const n=new qr,u=this.shares;for(const c of u){const f=t(c,this.shareSecrets[c]);n.addReplica(f)}const s=this.onSharesChanged(async c=>{const f=n.replicas(),h=n.shares();for(const l of f)c.includes(l.share)||(n.removeReplica(l),await l.close(!1));for(const l of c)if(!h.includes(l)){const d=t(l,this.shareSecrets[l]);n.addReplica(d)}}),i=this.onShareSecretsChanged(async c=>{const f=n.shares(),h=Object.keys(c);for(const l of f)if(!h.includes(l)){const d=n.getReplica(l);d&&(n.removeReplica(d),d.close(!1));const D=t(l);n.addReplica(D)}for(const l of h){const d=n.getReplica(l);if(d!=null&&d.formatsConfig["es.5"]&&d.formatsConfig["es.5"].shareSecret)continue;await(d==null?void 0:d.close(!1)),n.removeReplicaByShare(l);const D=t(l,c[l]);n.addReplica(D)}});if(e)for(const c of this.servers)n.sync(c,e==="continuous");const a=this.onServersChanged(c=>{if(e){const f=n.getSyncers();for(const[h,{description:l,syncer:d}]of f)c.includes(l)||d.cancel();for(const h of c)n.sync(h,e==="continuous")}});return{peer:n,unsubscribeFromSettings:()=>{s(),i(),a()}}}fireAuthorEvent(){const e=this.author;for(const t of this.authorChangedCbs)t(e)}fireSharesEvent(){const e=this.shares;for(const t of this.sharesChangedCbs)t(e)}fireSecretsEvent(){const e=this.shareSecrets;for(const t of this.shareSecretsChangedCbs)t(e)}fireServersEvent(){const e=this.servers;for(const t of this.serversChangedCbs)t(e)}async redeemInvitationURL(e){const t=await qo(e);if(y(t))return t;this.addShare(t.shareAddress);for(const n of t.servers)this.addServer(n);return t.secret&&this.addSecret(t.shareAddress,t.secret),!0}}function te(r,e){return`${Wo}:${e?`${e}:`:""}${r}`}function yr(r,e,t){const n=r.getItem(e);if(n!==null)try{const u=JSON.parse(n);return t(u)?u:void 0}catch{return}}function Vs(r){return!(r==null||typeof r!="object")}function zo(r){return!(!Vs(r)||Object.keys(r).length!==2||!("address"in r)||!("secret"in r))}function Qo(r){return!(!Array.isArray(r)||r.some(e=>typeof e!="string")||r.some(e=>y(bt(e))))}function Ko(r){if(!Vs(r))return!1;for(const e in r){const t=r[e];if(typeof t!="string"||y(X.checkKeypairIsValid({shareAddress:e,secret:t})))return!1}return!0}function Go(r){if(!Array.isArray(r)||r.some(e=>typeof e!="string"))return!1;for(const e of r)try{new URL(e)}catch{return!1}return!0}function Yo(r){const e=r-1;return e*e*e+1}function wu(r,{delay:e=0,duration:t=400,easing:n=Rr}={}){const u=+getComputedStyle(r).opacity;return{delay:e,duration:t,easing:n,css:s=>`opacity: ${s*u}`}}function Oe(r,{delay:e=0,duration:t=400,easing:n=Yo,x:u=0,y:s=0,opacity:i=0}={}){const a=getComputedStyle(r),o=+a.opacity,c=a.transform==="none"?"":a.transform,f=o*(1-i),[h,l]=In(u),[d,D]=In(s);return{delay:e,duration:t,easing:n,css:(m,p)=>`
			transform: ${c} translate(${(1-m)*h}${l}, ${(1-m)*d}${D});
			opacity: ${o-f*p}`}}const Pn=async r=>{const e=new TextEncoder().encode(r),t=await window.crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(t)).map(s=>s.toString(16).padStart(2,"0")).join("")};new ce("storage driver localStorage","gold");const it=new ce("replica driver indexeddb","gold");function Xo(r,e){return kn([r.path,r.timestamp,r.signature],[e.path,e.timestamp,r.signature],["ASC","DESC","ASC"])}function Zo(r,e){return kn([r.path,r.timestamp,r.signature],[e.path,e.timestamp,r.signature],["DESC","DESC","ASC"])}const we="docs",Be="config";class Jo{constructor(e,t){Object.defineProperty(this,"share",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"db",{enumerable:!0,configurable:!0,writable:!0,value:_()}),Object.defineProperty(this,"gotInitialMaxLocalIndex",{enumerable:!0,configurable:!0,writable:!0,value:_()}),Object.defineProperty(this,"localMaxLocalIndex",{enumerable:!0,configurable:!0,writable:!0,value:-1}),Object.defineProperty(this,"closed",{enumerable:!0,configurable:!0,writable:!0,value:!1});const n=bt(e);if(y(n))throw n;if(this.share=e,it.debug("constructor"),!window.indexedDB)throw new De("IndexedDB is not supported by this runtime.");const u=ps.indexedDB.open(`earthstar:share_docs:${this.share}${t?`/${t}`:""}`,1);u.onerror=()=>{throw it.error(`Could not open IndexedDB for ${this.share}'s attachments.`),it.error(u.error),new De(`Could not open IndexedDB for ${this.share}'s attachments.`)},u.onupgradeneeded=function(){const s=u.result,i=s.createObjectStore(we,{keyPath:["path","author"]});i.createIndex("comboIndex",["_localIndex","timestamp","path","author"],{unique:!0}),i.createIndex("pathTimestampIndex",["path","timestamp"],{unique:!1}),i.createIndex("pathAuthorIndex",["path","author"],{unique:!0}),i.createIndex("deleteAfterIndex","deleteAfter",{unique:!1}),i.createIndex("localIndexIndex","_localIndex",{unique:!0}),s.createObjectStore(Be,{keyPath:"key"}).createIndex("keyIndex",["key"],{unique:!0})},u.onsuccess=()=>{this.db.resolve(u.result);const i=u.result.transaction([we],"readonly").objectStore(we).index("localIndexIndex").openCursor(null,"prev");i.onsuccess=()=>{i.result?this.gotInitialMaxLocalIndex.resolve(i.result.value._localIndex):this.gotInitialMaxLocalIndex.resolve(-1)}},this.gotInitialMaxLocalIndex.then(s=>{this.localMaxLocalIndex=s})}isClosed(){return this.closed}async close(e){if(this.closed)throw new K;this.closed=!0;const t=_();if(e){const u=(await this.db).transaction([we,Be],"readwrite"),s=_(),i=_(),a=u.objectStore(we).clear().onsuccess=()=>{s.resolve()},o=u.objectStore(Be).clear().onsuccess=()=>{i.resolve()};await Promise.all([a,o]),t.resolve()}else t.resolve();return(await this.db).close(),await js(20),t}async getMaxLocalIndex(){return await this.gotInitialMaxLocalIndex,this.localMaxLocalIndex}async queryDocs(e){var f,h,l,d,D,m,p,w,B,k,v,H,R;const n=(await this.db).transaction([we],"readonly").objectStore(we),u=_(),{query:s,willMatch:i}=Ws(e);if(it.debug(`    cleanUpQuery.  willMatch = ${i}`),i==="nothing")return[];if((f=s.filter)!=null&&f.path&&s.historyMode==="latest"){const I=IDBKeyRange.bound([s.filter.path,s.filter.timestampGt||0],[s.filter.path,s.filter.timestampLt||Number.MAX_SAFE_INTEGER]),O=n.index("pathTimestampIndex").openCursor(I,"prev");O.onsuccess=()=>{var Q;(Q=O.result)!=null&&Q.value?u.resolve([O.result.value]):u.resolve([])}}else if((h=s.filter)!=null&&h.path&&s.historyMode==="all"){const I=n.index("pathAuthorIndex"),E=IDBKeyRange.bound([s.filter.path," "],[s.filter.path,"~"]),O=I.getAll(E);O.onsuccess=()=>{O.result?u.resolve(Array.from(O.result)):u.resolve([])}}else{const I=((l=s.startAfter)==null?void 0:l.path)||((d=s.filter)==null?void 0:d.path)||((D=s.filter)==null?void 0:D.pathStartsWith)||" ",E=((m=s.filter)==null?void 0:m.author)||" ",O=((p=s.filter)==null?void 0:p.timestamp)||((w=s.filter)==null?void 0:w.timestampGt)||0,Q=((B=s.startAfter)==null?void 0:B.localIndex)||0,q=((k=s.filter)==null?void 0:k.path)||"~",S=((v=s.filter)==null?void 0:v.author)||"~",L=((H=s.filter)==null?void 0:H.timestamp)||((R=s.filter)==null?void 0:R.timestampLt)||Number.MAX_SAFE_INTEGER,G=Number.MAX_SAFE_INTEGER,le=IDBKeyRange.bound([Q,O,I,E],[G,L,q,S]),Vr=n.index("comboIndex").getAll(le);Vr.onsuccess=()=>{Vr.result?u.resolve(Vr.result):u.resolve([])}}const a=await u;if(s.historyMode==="latest"){const I=a.splice(0,a.length),E=new Map;for(const O of I){const Q=E.get(O.path);(!Q||Q.timestamp<O.timestamp)&&E.set(O.path,O)}a.push(...E.values())}const o=[];it.debug("    filtering docs");const c=Date.now()*1e3;for(const I of a)I.deleteAfter&&I.deleteAfter<c||s.filter&&!_n(I,s.filter)||o.push(I);if(it.debug(`    ordering docs: ${s.orderBy}`),s.orderBy==="path ASC")o.sort(Xo);else if(s.orderBy==="path DESC")o.sort(Zo);else if(s.orderBy==="localIndex ASC")o.sort(pu("_localIndex","ASC"));else if(s.orderBy==="localIndex DESC")o.sort(pu("_localIndex","DESC"));else if(s.orderBy)throw new b("unrecognized query orderBy: "+JSON.stringify(s.orderBy));return s.limit!==void 0&&a.length>=s.limit?o.slice(0,s.limit):(it.debug(`    queryDocs is done: found ${o.length} docs.`),o)}async upsert(e){const t=await this.db,u=t.transaction([we],"readwrite").objectStore(we).index("pathAuthorIndex"),s=_(),i=u.openCursor([e.path,e.author]);if(await this.gotInitialMaxLocalIndex,this.localMaxLocalIndex+=1,e._localIndex=this.localMaxLocalIndex,i.onsuccess=()=>{if(i.result){const h=i.result.update(e);h.onsuccess=()=>{s.resolve(!!h.result)}}else s.resolve(!1)},await s)return e;const c=t.transaction([we],"readwrite").objectStore(we).put(e),f=_();return c.onsuccess=()=>{f.resolve()},c.onerror=()=>{throw c.error},await f,e}async eraseExpiredDocs(){const e=[],u=(await this.db).transaction([we],"readwrite").objectStore(we).index("deleteAfterIndex"),s=Date.now()*1e3,i=IDBKeyRange.bound(0,s),a=u.openCursor(i),o=_();return a.onsuccess=()=>{var c;if((c=a.result)!=null&&c.value){const f=a.result.value;if(f.deleteAfter!==null&&f.deleteAfter!==void 0){e.push(f);const h=a.result.delete();h.onsuccess=()=>{var l;(l=a.result)==null||l.continue()}}}else o.resolve()},await o,e}async getConfig(e){const n=(await this.db).transaction([Be],"readonly").objectStore(Be),u=_(),s=n.get(e);return s.onsuccess=()=>{var i;u.resolve((i=s.result)==null?void 0:i.value)},u}async setConfig(e,t){const u=(await this.db).transaction([Be],"readwrite").objectStore(Be),s=_(),i=u.put({key:e,value:t});return i.onsuccess=()=>{s.resolve()},s}async listConfigKeys(){const t=(await this.db).transaction([Be],"readonly").objectStore(Be),n=_(),s=t.index("keyIndex").openKeyCursor(),i=[];return s.onsuccess=()=>{s.result?(i.push(s.result.primaryKey),s.result.continue()):n.resolve(i)},n}async deleteConfig(e){const n=(await this.db).transaction([Be],"readwrite").objectStore(Be),u=_(),s=n.index("keyIndex"),i=IDBKeyRange.bound([e],[e]),a=s.openCursor(i);return a.onsuccess=()=>{if(a.result){const o=a.result.delete();o.onsuccess=()=>{u.resolve(!0)}}else u.resolve(!1)},u}}const yu=new ce("replica driver indexeddb","gold"),Se="attachment_staging_index",ye="attachments_index",pe="attachments_bytes";class ec{constructor(e,t){if(Object.defineProperty(this,"db",{enumerable:!0,configurable:!0,writable:!0,value:_()}),Object.defineProperty(this,"share",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"closed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.share=e,!window.indexedDB)throw new De("IndexedDB is not supported by this runtime.");const n=ps.indexedDB.open(`earthstar:share_attachments:${this.share}${t?`/${t}`:""}`,1);n.onerror=()=>{throw yu.error(`Could not open IndexedDB for ${this.share}'s attachments.`),yu.error(n.error),new De(`Could not open IndexedDB for ${this.share}'s attachments.`)},n.onupgradeneeded=function(){const u=n.result;u.createObjectStore(pe),u.createObjectStore(ye,{keyPath:"id"}),u.createObjectStore(Se,{keyPath:"id"})},n.onsuccess=()=>{this.db.resolve(n.result)}}getIndexKey(e,t){return`${e}___${t}`}async getAttachment(e,t){if(this.closed)throw new K;const n=_(),u=this.getIndexKey(e,t),s=await this.db,a=s.transaction([ye],"readonly").objectStore(ye).get(u),o=_();return a.onerror=()=>{o.reject()},a.onsuccess=()=>{a.result===void 0?o.reject():o.resolve(a.result.blobKey)},o.then(c=>{const h=s.transaction([pe],"readonly").objectStore(pe).get(c);h.onsuccess=()=>{const l=new es([h.result]);n.resolve({bytes:async()=>new Uint8Array(await l.arrayBuffer()),stream:()=>Promise.resolve(l.stream())})},h.onerror=()=>{n.resolve(void 0)}}).catch(()=>{n.resolve(void 0)}),n}async erase(e,t){if(this.closed)throw new K;const n=_(),u=this.getIndexKey(e,t),s=await this.db,a=s.transaction([ye],"readonly").objectStore(ye).get(u),o=_();return a.onerror=()=>{o.reject()},a.onsuccess=()=>{s.transaction([ye],"readwrite").objectStore(ye).delete(u),a.result===void 0?o.reject():o.resolve(a.result.blobKey)},o.then(c=>{const f=s.transaction([pe],"readwrite").objectStore(pe).delete(c);f.onsuccess=()=>{n.resolve(!0)},f.onerror=()=>{n.resolve(void 0)}}).catch(()=>{n.resolve(new b("No attachment found"))}),n}async stage(e,t){if(this.closed)throw new K;const n=await this.db,u=t instanceof Uint8Array?t:await Ho(t),s=await X.sha256base32(u),i=this.getIndexKey(e,s),a=`${i}___${ze()}`,o=n.transaction([pe,Se],"readwrite"),c=o.objectStore(pe).put(u,a),f=o.objectStore(Se).put({id:i,blobKey:a}),h=_(),l=_();return c.onsuccess=()=>h.resolve(),f.onsuccess=()=>l.resolve(),await h,await l,{hash:s,size:u.byteLength,reject:async()=>{const d=n.transaction([pe,Se],"readwrite"),D=d.objectStore(pe).delete(a),m=d.objectStore(Se).delete(i),p=_(),w=_();D.onsuccess=()=>{p.resolve()},m.onsuccess=()=>{w.resolve()},await Promise.all([p,w])},commit:async()=>{const d=n.transaction([ye,Se],"readwrite"),D=d.objectStore(Se).delete(i),m=d.objectStore(ye).put({id:i,blobKey:a}),p=_(),w=_();D.onsuccess=()=>p.resolve(),m.onsuccess=()=>w.resolve(),await Promise.all([p,w])}}}async wipe(){if(this.closed)throw new K;const t=(await this.db).transaction([pe,ye,Se],"readwrite"),n=t.objectStore(pe).clear(),u=t.objectStore(ye).clear(),s=t.objectStore(Se).clear(),i=_(),a=_(),o=_();n.onsuccess=()=>i.resolve(),u.onsuccess=()=>a.resolve(),s.onsuccess=()=>o.resolve(),await Promise.all([i,a,o])}async clearStaging(){if(this.closed)throw new K;const t=(await this.db).transaction([pe,Se]),n=t.objectStore(Se).openCursor(),u=_();return n.onsuccess=()=>{const s=n.result;if(!s){u.resolve();return}const i=s.value.blobKey,a=t.objectStore(pe).delete(i);s.delete(),a.onsuccess=()=>{s.continue()},a.onerror=()=>{s.continue()}},u}async filter(e){if(this.closed)throw new K;const n=(await this.db).transaction([pe,ye],"readwrite"),u=50,s=[],i=[],a=_(),o=(c=null)=>{const f=n.objectStore(ye).getAll(c,u);f.onsuccess=()=>{const h=f.result;for(const l of h){const[d,D]=l.id.split("___");e[d]&&!e[d].has(D)&&(s.push({format:d,hash:D}),i.push(this.erase(d,D)))}if(h.length===u){const l=h[h.length-1],d=IDBKeyRange.lowerBound(l.id,!0);o(d)}else a.resolve()}};return o(),await a,await Promise.all(i),s}isClosed(){return this.closed}async close(e){if(this.closed)throw new K;e&&await this.wipe(),this.closed=!0,(await this.db).close(),await js(20)}}class tc{constructor(e,t){Object.defineProperty(this,"docDriver",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"attachmentDriver",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.docDriver=new Jo(e,t),this.attachmentDriver=new ec(e,t)}}const Et=[];function zs(r,e=W){let t;const n=new Set;function u(a){if(Ze(r,a)&&(r=a,t)){const o=!Et.length;for(const c of n)c[1](),Et.push(c,r);if(o){for(let c=0;c<Et.length;c+=2)Et[c][0](Et[c+1]);Et.length=0}}}function s(a){u(a(r))}function i(a,o=W){const c=[a,o];return n.add(c),n.size===1&&(t=e(u,s)||W),a(r),()=>{n.delete(c),n.size===0&&t&&(t(),t=null)}}return{set:u,update:s,subscribe:i}}var Au={BASE_URL:"/voting-interface/",MODE:"production",DEV:!1,PROD:!0,SSR:!1};const Cr=zs(!1),V=new Vo,sr={address:Au.VITE_ADDRESS,secret:Au.VITE_SECRET};V.addShare(sr.address);V.addSecret(sr.address,sr.secret);const Or=new Uo({driver:new tc(sr.address),shareSecret:sr.secret});function rc(){let r="",e="abcdefghijklmnopqrstuvwxyz",t=e.length,n="abcdefghijklmnopqrstuvwxyz0123456789",u=n.length;r+=e.charAt(Math.floor(Math.random()*t));for(let s=0;s<3;s++)r+=n.charAt(Math.floor(Math.random()*u));return r}async function ir(r){let e;return r=="r"?e=rc():e=r,await X.generateAuthorKeypair(e)}const Yt=r=>typeof window<"u"?new URL(window.location.href).searchParams.get(r):null,nc=r=>{const e=Yt(r);return e&&r.match(/^\d+$/)?e:null},uc=()=>{const r=[];for(let e=0;e<=12;e++){const t=nc(e.toString());t!==null&&r.push(t)}return r},Cu=async r=>{if(r)try{const e=await fetch(`${r}.json`);return e.ok?await e.json():(console.error("Failed to fetch voter list:",e.statusText),null)}catch(e){return console.error("Error fetching voter list:",e),null}return null};function Eu(r,e,t){const n=r.slice();return n[17]=e[t],n}function Fu(r){let e,t;return{c(){e=F("h1"),t=oe(r[2]),C(e,"class","svelte-1igpq5c")},m(n,u){$(n,e,u),A(e,t)},p(n,u){u&4&&Ie(t,n[2])},d(n){n&&j(e)}}}function sc(r){let e,t,n,u,s,i,a,o,c,f,h;return{c(){e=F("div"),t=F("input"),n=M(),u=F("label"),u.textContent="yes 👍",s=M(),i=F("div"),a=F("input"),o=M(),c=F("label"),c.textContent="no 👎",C(t,"type","checkbox"),C(t,"id","yes"),C(t,"class","svelte-1igpq5c"),C(u,"for","yes"),C(u,"class","svelte-1igpq5c"),C(e,"class","svelte-1igpq5c"),C(a,"type","checkbox"),C(a,"id","no"),C(a,"class","svelte-1igpq5c"),C(c,"for","no"),C(c,"class","svelte-1igpq5c"),C(i,"class","svelte-1igpq5c")},m(l,d){$(l,e,d),A(e,t),A(e,n),A(e,u),$(l,s,d),$(l,i,d),A(i,a),A(i,o),A(i,c),f||(h=[xe(t,"change",r[9]),xe(a,"change",r[10])],f=!0)},p:W,d(l){l&&(j(e),j(s),j(i)),f=!1,Re(h)}}}function ic(r){let e,t=_r(r[1]),n=[];for(let u=0;u<t.length;u+=1)n[u]=vu(Eu(r,t,u));return{c(){for(let u=0;u<n.length;u+=1)n[u].c();e=$u()},m(u,s){for(let i=0;i<n.length;i+=1)n[i]&&n[i].m(u,s);$(u,e,s)},p(u,s){if(s&66){t=_r(u[1]);let i;for(i=0;i<t.length;i+=1){const a=Eu(u,t,i);n[i]?n[i].p(a,s):(n[i]=vu(a),n[i].c(),n[i].m(e.parentNode,e))}for(;i<n.length;i+=1)n[i].d(1);n.length=t.length}},d(u){u&&j(e),Uu(n,u)}}}function vu(r){let e,t,n,u,s,i=r[17]+"",a,o,c,f,h;function l(){return r[8](r[17])}return{c(){e=F("div"),t=F("input"),u=M(),s=F("label"),a=oe(i),c=M(),C(t,"type","checkbox"),C(t,"id",n=r[17]),C(t,"class","svelte-1igpq5c"),C(s,"for",o=r[17]),C(s,"class","svelte-1igpq5c"),C(e,"class","m-8 svelte-1igpq5c")},m(d,D){$(d,e,D),A(e,t),A(e,u),A(e,s),A(s,a),A(e,c),f||(h=xe(t,"change",l),f=!0)},p(d,D){r=d,D&2&&n!==(n=r[17])&&C(t,"id",n),D&2&&i!==(i=r[17]+"")&&Ie(a,i),D&2&&o!==(o=r[17])&&C(s,"for",o)},d(d){d&&j(e),f=!1,h()}}}function Bu(r){let e,t,n,u,s=r[3].kind+"",i;return{c(){e=F("p"),e.textContent="There was an error and your vote was not submitted. Please try again.",t=M(),n=F("p"),u=oe("Here is the error message: "),i=oe(s),C(e,"class","error")},m(a,o){$(a,e,o),$(a,t,o),$(a,n,o),A(n,u),A(n,i)},p(a,o){o&8&&s!==(s=a[3].kind+"")&&Ie(i,s)},d(a){a&&(j(e),j(t),j(n))}}}function ac(r){let e,t,n,u,s,i,a,o,c,f,h,l=r[2]&&Fu(r);function d(w,B){return w[1].length>0?ic:sc}let D=d(r),m=D(r),p=!r[5]&&Bu(r);return{c(){e=F("div"),l&&l.c(),t=M(),n=F("h1"),u=M(),s=F("div"),m.c(),i=M(),a=F("button"),o=oe("Submit"),c=M(),p&&p.c(),C(n,"class","mt-12 svelte-1igpq5c"),C(s,"class","flex flex-row flex-wrap max-w-lg svelte-1igpq5c"),C(a,"class","m-4 svelte-1igpq5c"),a.disabled=r[4],C(e,"class","flex flex-col svelte-1igpq5c")},m(w,B){$(w,e,B),l&&l.m(e,null),A(e,t),A(e,n),n.innerHTML=r[0],A(e,u),A(e,s),m.m(s,null),A(e,i),A(e,a),A(a,o),A(e,c),p&&p.m(e,null),f||(h=xe(a,"click",r[7]),f=!0)},p(w,[B]){w[2]?l?l.p(w,B):(l=Fu(w),l.c(),l.m(e,t)):l&&(l.d(1),l=null),B&1&&(n.innerHTML=w[0]),D===(D=d(w))&&m?m.p(w,B):(m.d(1),m=D(w),m&&(m.c(),m.m(s,null))),B&16&&(a.disabled=w[4]),w[5]?p&&(p.d(1),p=null):p?p.p(w,B):(p=Bu(w),p.c(),p.m(e,null))},i:W,o:W,d(w){w&&j(e),l&&l.d(),m.d(),p&&p.d(),f=!1,h()}}}function oc(r,e,t){let{id:n}=e,u=Vu(),s,i,a,o,c,{responses:f=[]}=e,{year:h}=e,l=new Set,d=!1,D=!0;function m(v){l.has(v)?l.delete(v):l.add(v)}async function p(){t(4,d=!0),o=await ir("anon");const v=await Pn(n);console.log("hash",v);for(let H of l){c=Math.round(new Date().getTime()+Math.random());let E={path:"/"+v+"/"+c,text:H};o instanceof b||(i=await Or.set(o,E),i.kind!=="success"&&t(5,D=!1))}if(D){let R={path:"/"+v+"/voter/"+Math.round(new Date().getTime()+Math.random()),text:"Voted"};t(3,s=await Or.set(a,R)),s.kind==="success"?Cr.set(!0):Cr.set(!1),y(s)&&console.error(s)}else Cr.set(!1);return u("success"),s}const w=v=>m(v),B=()=>m("yes"),k=()=>m("no");return r.$$set=v=>{"id"in v&&t(0,n=v.id),"responses"in v&&t(1,f=v.responses),"year"in v&&t(2,h=v.year)},V.author&&(a=V.author),[n,f,h,s,d,D,m,p,w,B,k]}class cc extends gt{constructor(e){super(),mt(this,e,oc,ac,Ze,{id:0,responses:1,year:2})}}function lc(r){let e,t,n,u,s;return{c(){e=F("strong"),e.textContent="➜",t=M(),n=F("button"),n.textContent="Export as CSV",C(n,"class","bg-blue-500 text-white px-4 py-2 rounded svelte-mzllzq")},m(i,a){$(i,e,a),$(i,t,a),$(i,n,a),u||(s=xe(n,"click",r[0]),u=!0)},p:W,i:W,o:W,d(i){i&&(j(e),j(t),j(n)),u=!1,s()}}}function hc(r,e,t){let{data:n={}}=e,{filename:u="export.csv"}=e;const s=a=>typeof a=="string"?`"${a.replace(/"/g,'""')}"`:a,i=()=>{const a=Object.entries(n);let o=`data:text/csv;charset=utf-8,Response,Count
`;a.forEach(([h,l])=>{o+=`${s(h)},${s(l)}
`});const c=encodeURI(o),f=document.createElement("a");f.setAttribute("href",c),f.setAttribute("download",u),document.body.appendChild(f),f.click(),document.body.removeChild(f)};return r.$$set=a=>{"data"in a&&t(1,n=a.data),"filename"in a&&t(2,u=a.filename)},[i,n,u]}class fc extends gt{constructor(e){super(),mt(this,e,hc,lc,Ze,{data:1,filename:2})}}function Su(r,e,t){const n=r.slice();return n[6]=e[t][0],n[7]=e[t][1],n}function xu(r){let e,t;return{c(){e=F("h1"),t=oe(r[2]),C(e,"class","svelte-yuwj0l")},m(n,u){$(n,e,u),A(e,t)},p(n,u){u&4&&Ie(t,n[2])},d(n){n&&j(e)}}}function _u(r){let e,t,n=r[7]+"",u,s,i=r[6]+"",a,o;return{c(){e=F("div"),t=F("span"),u=oe(n),s=M(),a=oe(i),o=M(),C(t,"class","txt svelte-yuwj0l"),C(e,"class","results flex flex-col m-5 svelte-yuwj0l")},m(c,f){$(c,e,f),A(e,t),A(t,u),A(e,s),A(e,a),A(e,o)},p(c,f){f&32&&n!==(n=c[7]+"")&&Ie(u,n),f&32&&i!==(i=c[6]+"")&&Ie(a,i)},d(c){c&&j(e)}}}function ku(r){let e,t,n,u,s,i,a=r[3][0][1]+"",o,c;return{c(){e=F("div"),t=F("h2"),t.textContent="Participants",n=M(),u=F("div"),s=F("div"),i=F("span"),o=oe(a),c=oe(" Voted"),C(t,"class","svelte-yuwj0l"),C(i,"class","txt svelte-yuwj0l"),C(s,"class","results flex flex-col m-5 svelte-yuwj0l"),C(u,"class","flex flex-col sm:flex-row ml-5")},m(f,h){$(f,e,h),A(e,t),A(e,n),A(e,u),A(u,s),A(s,i),A(i,o),A(s,c)},p(f,h){h&8&&a!==(a=f[3][0][1]+"")&&Ie(o,a)},d(f){f&&j(e)}}}function dc(r){let e,t,n,u,s,i,a,o,c,f,h,l,d,D,m,p,w,B,k,v=r[2]&&xu(r),H=_r(r[5]),R=[];for(let E=0;E<H.length;E+=1)R[E]=_u(Su(r,H,E));let I=r[3].length>0&&ku(r);return l=new fc({props:{data:r[1],filename:"vote_results.csv"}}),{c(){e=F("div"),t=F("h2"),t.textContent="Thanks for voting! Your vote has been recorded.",n=M(),v&&v.c(),u=M(),s=F("h1"),i=M(),a=F("h2"),a.textContent="Results",o=M(),c=F("div");for(let E=0;E<R.length;E+=1)R[E].c();f=M(),I&&I.c(),h=M(),Pt(l.$$.fragment),d=M(),D=F("div"),m=F("h2"),m.textContent="Results unique ID",p=M(),w=F("p"),B=oe(r[4]),C(t,"class","svelte-yuwj0l"),C(s,"class","svelte-yuwj0l"),C(a,"class","svelte-yuwj0l"),C(c,"class","flex flex-col lg:flex-row ml-5 max-w-5xl"),C(m,"class","svelte-yuwj0l"),C(e,"class","m-4")},m(E,O){$(E,e,O),A(e,t),A(e,n),v&&v.m(e,null),A(e,u),A(e,s),s.innerHTML=r[0],A(e,i),A(e,a),A(e,o),A(e,c);for(let Q=0;Q<R.length;Q+=1)R[Q]&&R[Q].m(c,null);A(e,f),I&&I.m(e,null),A(e,h),ht(l,e,null),A(e,d),A(e,D),A(D,m),A(D,p),A(D,w),A(w,B),k=!0},p(E,[O]){if(E[2]?v?v.p(E,O):(v=xu(E),v.c(),v.m(e,u)):v&&(v.d(1),v=null),(!k||O&1)&&(s.innerHTML=E[0]),O&32){H=_r(E[5]);let q;for(q=0;q<H.length;q+=1){const S=Su(E,H,q);R[q]?R[q].p(S,O):(R[q]=_u(S),R[q].c(),R[q].m(c,null))}for(;q<R.length;q+=1)R[q].d(1);R.length=H.length}E[3].length>0?I?I.p(E,O):(I=ku(E),I.c(),I.m(e,h)):I&&(I.d(1),I=null);const Q={};O&2&&(Q.data=E[1]),l.$set(Q),(!k||O&16)&&Ie(B,E[4])},i(E){k||(re(l.$$.fragment,E),k=!0)},o(E){ge(l.$$.fragment,E),k=!1},d(E){E&&j(e),v&&v.d(),Uu(R,E),I&&I.d(),ft(l)}}}function Dc(r,e,t){let n,{id:u}=e,{voteCounts:s={}}=e,{year:i}=e,a=[],o="";return r.$$set=c=>{"id"in c&&t(0,u=c.id),"voteCounts"in c&&t(1,s=c.voteCounts),"year"in c&&t(2,i=c.year)},r.$$.update=()=>{r.$$.dirty&2&&t(3,a=Object.entries(s).filter(([c,f])=>c==="Voted")),r.$$.dirty&2&&t(5,n=Object.entries(s).filter(([c,f])=>c!=="Voted"&&c.trim()!=="").sort((c,f)=>f[1]-c[1])),r.$$.dirty&1&&(async()=>t(4,o=await Pn(u)))()},[u,s,i,a,o,n]}class pc extends gt{constructor(e){super(),mt(this,e,Dc,dc,Ze,{id:0,voteCounts:1,year:2})}}function mc(r){let e,t,n,u,s;return{c(){e=F("input"),t=M(),n=F("button"),n.textContent="upload keypair",an(e,"display","none"),C(e,"type","file"),C(e,"accept",".json, .txt"),C(n,"class","svelte-x91wii")},m(i,a){$(i,e,a),r[3](e),$(i,t,a),$(i,n,a),u||(s=[xe(e,"change",r[2]),xe(n,"click",r[4])],u=!0)},p:W,i:W,o:W,d(i){i&&(j(e),j(t),j(n)),r[3](null),u=!1,Re(s)}}}function gc(r){return new Promise((e,t)=>{let n=new FileReader;n.onload=()=>{e(n.result)},n.onerror=t,n.readAsBinaryString(r)})}function bc(r,e,t){const n=Vu();let u;async function s(c){let f=c.target.files[0],h=await gc(f);try{let l=JSON.parse(h);n("newIdentity",l)}catch{n("error")}}const i=c=>s(c);function a(c){on[c?"unshift":"push"](()=>{u=c,t(0,u)})}return[u,s,i,a,()=>{u.click()}]}class wc extends gt{constructor(e){super(),mt(this,e,bc,mc,Ze,{})}}function yc(r){let e,t,n,u;return{c(){e=On("svg"),t=oe(`>
    `),n=On("path"),C(n,"d","M5.5028,4.627 L5.5,6.75 L5.5,17.2542 C5.5,19.0491 6.95507,20.5042 8.75,20.5042 L17.3663,20.5045 C17.0573,21.3782 16.224,22.0042 15.2444,22.0042 L8.75,22.0042 C6.12665,22.0042 4,19.8776 4,17.2542 L4,6.75 C4,5.76929 4.62745,4.93512 5.5028,4.627 Z M17.75,2 C18.9926,2 20,3.00736 20,4.25 L20,17.25 C20,18.4926 18.9926,19.5 17.75,19.5 L8.75,19.5 C7.50736,19.5 6.5,18.4926 6.5,17.25 L6.5,4.25 C6.5,3.00736 7.50736,2 8.75,2 L17.75,2 Z M17.75,3.5 L8.75,3.5 C8.33579,3.5 8,3.83579 8,4.25 L8,17.25 C8,17.6642 8.33579,18 8.75,18 L17.75,18 C18.1642,18 18.5,17.6642 18.5,17.25 L18.5,4.25 C18.5,3.83579 18.1642,3.5 17.75,3.5 Z"),C(e,"class","hover-effect svelte-wug5lv"),C(e,"width","20px"),C(e,"height","20px"),C(e,"viewBox","0 0 20 20"),C(e,"xmlns","http://www.w3.org/2000/svg"),C(e,"fill",u=r[1]?"#9900FC":r[0]),Rn(e,"click-active",r[1])},m(s,i){$(s,e,i),A(e,t),A(e,n)},p(s,[i]){i&3&&u!==(u=s[1]?"#9900FC":s[0])&&C(e,"fill",u),i&2&&Rn(e,"click-active",s[1])},i:W,o:W,d(s){s&&j(e)}}}function Ac(r,e,t){let{fill:n="white"}=e,{isClickActive:u=!1}=e;return r.$$set=s=>{"fill"in s&&t(0,n=s.fill),"isClickActive"in s&&t(1,u=s.isClickActive)},[n,u]}class Cc extends gt{constructor(e){super(),mt(this,e,Ac,yc,Ze,{fill:0,isClickActive:1})}}function Pu(r){let e,t,n,u;return{c(){e=F("div"),t=F("blockquote"),t.innerHTML="<strong>Please upload a valid identity file</strong>",C(e,"class","text-left flex-grow")},m(s,i){$(s,e,i),A(e,t),u=!0},i(s){u||(s&&Fe(()=>{u&&(n||(n=jn(t,Oe,{x:200,duration:2e3},!0)),n.run(1))}),u=!0)},o(s){s&&(n||(n=jn(t,Oe,{x:200,duration:2e3},!1)),n.run(0)),u=!1},d(s){s&&j(e),s&&n&&n.end()}}}function Ec(r){let e,t,n,u,s,i,a,o,c,f,h,l,d,D,m,p,w,B,k,v,H,R,I,E,O,Q,q,S=r[1]===!0&&Pu();return l=new Cc({props:{fill:r[4],isClickActive:r[2]}}),E=new wc({}),E.$on("newIdentity",r[8]),E.$on("error",r[7]),{c(){e=F("div"),S&&S.c(),t=M(),n=F("div"),u=F("h3"),u.textContent="Current Keypair",s=M(),i=F("div"),a=F("b"),a.textContent="Address:",o=M(),c=oe(r[0]),f=M(),h=F("button"),Pt(l.$$.fragment),d=M(),D=F("div"),m=F("b"),m.textContent="Secret:",p=M(),w=oe(r[3]),B=M(),k=F("div"),v=F("button"),v.textContent="download keypair",H=M(),R=F("button"),R.textContent="generate new keypair",I=M(),Pt(E.$$.fragment),C(u,"class","mr-3 svelte-egwkq6"),C(h,"class","copy-button svelte-egwkq6"),C(i,"class","flex flex-row truncate mr-2"),C(D,"class","flex flex-row truncate"),C(n,"class","flex flex-col lg:flex-row items-end"),C(v,"class","svelte-egwkq6"),C(R,"class","svelte-egwkq6"),C(k,"class","flex items-end align-left flex-row button-group svelte-egwkq6"),C(e,"class","flex flex-row justify-between w-full bg-black svelte-egwkq6")},m(L,G){$(L,e,G),S&&S.m(e,null),A(e,t),A(e,n),A(n,u),A(n,s),A(n,i),A(i,a),A(i,o),A(i,c),A(i,f),A(i,h),ht(l,h,null),A(n,d),A(n,D),A(D,m),A(D,p),A(D,w),A(e,B),A(e,k),A(k,v),A(k,H),A(k,R),A(k,I),ht(E,k,null),O=!0,Q||(q=[xe(h,"click",r[10]),xe(v,"click",r[13]),xe(R,"click",r[9])],Q=!0)},p(L,[G]){L[1]===!0?S?G&2&&re(S,1):(S=Pu(),S.c(),re(S,1),S.m(e,t)):S&&(Sr(),ge(S,1,1,()=>{S=null}),xr()),(!O||G&1)&&Ie(c,L[0]);const le={};G&16&&(le.fill=L[4]),G&4&&(le.isClickActive=L[2]),l.$set(le),(!O||G&8)&&Ie(w,L[3])},i(L){O||(re(S),re(l.$$.fragment,L),re(E.$$.fragment,L),O=!0)},o(L){ge(S),ge(l.$$.fragment,L),ge(E.$$.fragment,L),O=!1},d(L){L&&j(e),S&&S.d(),ft(l),ft(E),Q=!1,Re(q)}}}function Fc(r,e,t){let n,u,s,i,a=!1,o=!1,c=zs("white");Mu(r,c,p=>t(4,i=p));function f(){let p=document.createElement("a"),w=new Blob([JSON.stringify(V.author)],{type:"text/plain"}),B=V.author.address+".json";p.href=URL.createObjectURL(w),p.download=B,p.style.display="none",document.body.appendChild(p),p.click()}function h(){t(1,a=!0)}Wu(async()=>{!V.author&&!V.author.address&&ir("r")});function l(p){let w=p.detail;t(11,V.author=w,V)}async function d(){const p=await ir("r");t(11,V.author={...p},V)}function D(){navigator.clipboard.writeText(V.author.address).then(()=>{c.set("#9900FC"),t(2,o=!0),setTimeout(()=>{c.set("white"),t(2,o=!1)},3e3)},p=>{console.error("Could not copy text: ",p)})}const m=()=>f();return r.$$.update=()=>{r.$$.dirty&2048&&t(0,n=V.author.address.slice(0,22)+"..."),r.$$.dirty&2048&&t(3,u=V.author.secret.slice(0,25)+"..."),r.$$.dirty&1&&t(12,s=n.slice(0,5)),r.$$.dirty&4096&&s.slice(1,5)},[n,a,o,u,i,c,f,h,l,d,D,V,s,m]}class vc extends gt{constructor(e){super(),mt(this,e,Fc,Ec,Ze,{})}}var Tu={BASE_URL:"/voting-interface/",MODE:"production",DEV:!1,PROD:!0,SSR:!1};function Bc(r){let e,t,n,u;return{c(){e=F("div"),e.innerHTML="<h2>This is a private vote. The loaded keypair is not authorized to participate in this vote. Click the button in the bottom-right corner of the screen to access keypair management.</h2>"},m(s,i){$(s,e,i),u=!0},p:W,i(s){u||(s&&Fe(()=>{u&&(n&&n.end(1),t=or(e,Oe,{y:1200,duration:1200}),t.start())}),u=!0)},o(s){t&&t.invalidate(),s&&(n=cr(e,Oe,{y:1200,duration:1200})),u=!1},d(s){s&&j(e),s&&n&&n.end()}}}function Sc(r){let e,t,n,u,s;return t=new pc({props:{id:r[8],voteCounts:r[7],year:r[6]}}),{c(){e=F("div"),Pt(t.$$.fragment)},m(i,a){$(i,e,a),ht(t,e,null),s=!0},p(i,a){const o={};a&256&&(o.id=i[8]),a&128&&(o.voteCounts=i[7]),a&64&&(o.year=i[6]),t.$set(o)},i(i){s||(re(t.$$.fragment,i),i&&Fe(()=>{s&&(u&&u.end(1),n=or(e,Oe,{y:1e3,duration:3e3}),n.start())}),s=!0)},o(i){ge(t.$$.fragment,i),n&&n.invalidate(),i&&(u=cr(e,Oe,{y:1200,duration:1200})),s=!1},d(i){i&&j(e),ft(t),i&&u&&u.end()}}}function xc(r){let e,t,n,u,s;return t=new cc({props:{id:r[8],responses:r[5],year:r[6]}}),t.$on("success",r[11]),{c(){e=F("div"),Pt(t.$$.fragment),C(e,"class","absolute flex flex-col items-center w-full h-full lg:justify-start")},m(i,a){$(i,e,a),ht(t,e,null),s=!0},p(i,a){const o={};a&256&&(o.id=i[8]),a&32&&(o.responses=i[5]),a&64&&(o.year=i[6]),t.$set(o)},i(i){s||(re(t.$$.fragment,i),i&&Fe(()=>{s&&(u&&u.end(1),n=or(e,Oe,{y:-400,duration:3e3}),n.start())}),s=!0)},o(i){ge(t.$$.fragment,i),n&&n.invalidate(),i&&(u=cr(e,Oe,{y:-400,duration:3e3})),s=!1},d(i){i&&j(e),ft(t),i&&u&&u.end()}}}function _c(r){let e,t,n,u;return{c(){e=F("h1"),e.textContent="An experimental voting tool built with Earthstar."},m(s,i){$(s,e,i),u=!0},p:W,i(s){u||(s&&Fe(()=>{u&&(n&&n.end(1),t=or(e,wu,{duration:1e3}),t.start())}),u=!0)},o(s){t&&t.invalidate(),s&&(n=cr(e,wu,{duration:250})),u=!1},d(s){s&&j(e),s&&n&&n.end()}}}function kc(r){return{c:W,m:W,p:W,i:W,o:W,d:W}}function Iu(r){let e,t,n,u,s,i,a,o=r[1]&&Ou();return{c(){e=F("div"),t=F("div"),n=F("button"),n.textContent="Keypair management",u=M(),o&&o.c(),C(n,"class","svelte-s8yrda"),C(t,"id","bottomButton"),an(t,"bottom",r[1]?`${r[9]}px`:"0"),C(t,"class","svelte-s8yrda"),C(e,"class","flex flex-col")},m(c,f){$(c,e,f),A(e,t),A(t,n),A(e,u),o&&o.m(e,null),s=!0,i||(a=xe(n,"click",r[10]),i=!0)},p(c,f){(!s||f&514)&&an(t,"bottom",c[1]?`${c[9]}px`:"0"),c[1]?o?f&2&&re(o,1):(o=Ou(),o.c(),re(o,1),o.m(e,null)):o&&(Sr(),ge(o,1,1,()=>{o=null}),xr())},i(c){s||(re(o),s=!0)},o(c){ge(o),s=!1},d(c){c&&j(e),o&&o.d(),i=!1,a()}}}function Ou(r){let e,t,n,u,s;return t=new vc({}),{c(){e=F("div"),Pt(t.$$.fragment),C(e,"id","IdentityFooter"),C(e,"class","svelte-s8yrda")},m(i,a){$(i,e,a),ht(t,e,null),s=!0},i(i){s||(re(t.$$.fragment,i),i&&Fe(()=>{s&&(u&&u.end(1),n=or(e,Oe,{y:300,duration:900}),n.start())}),s=!0)},o(i){ge(t.$$.fragment,i),n&&n.invalidate(),i&&(u=cr(e,Oe,{y:300,duration:900})),s=!1},d(i){i&&j(e),ft(t),i&&u&&u.end()}}}function Pc(r){let e,t,n,u,s,i,a;const o=[kc,_c,xc,Sc,Bc],c=[];function f(l,d){return l[4]?0:l[8]?l[2]?2:l[0]?3:4:1}n=f(r),u=c[n]=o[n](r);let h=r[3]&&Iu(r);return{c(){e=F("main"),t=F("div"),u.c(),s=M(),h&&h.c(),i=$u(),C(t,"class","absolute flex flex-col items-center w-full h-full lg:justify-start"),C(e,"class","svelte-s8yrda")},m(l,d){$(l,e,d),A(e,t),c[n].m(t,null),$(l,s,d),h&&h.m(l,d),$(l,i,d),a=!0},p(l,[d]){let D=n;n=f(l),n===D?c[n].p(l,d):(Sr(),ge(c[D],1,1,()=>{c[D]=null}),xr(),u=c[n],u?u.p(l,d):(u=c[n]=o[n](l),u.c()),re(u,1),u.m(t,null)),l[3]?h?(h.p(l,d),d&8&&re(h,1)):(h=Iu(l),h.c(),re(h,1),h.m(i.parentNode,i)):h&&(Sr(),ge(h,1,1,()=>{h=null}),xr())},i(l){a||(re(u),re(h),a=!0)},o(l){ge(u),ge(h),a=!1},d(l){l&&(j(e),j(s),j(i)),c[n].d(),h&&h.d(l)}}}function Tc(r,e,t){let n;Mu(r,Cr,S=>t(12,n=S));let u=!1,s=!1,i=!1,a=!1,o=!0,c=!1,f=null,h=[],l,d=[],D,m={},p,w,B=new $o(Or),k=0;async function v(){t(1,u=!u),await ui();const S=document.getElementById("IdentityFooter");t(9,k=S?S.clientHeight:0)}function H(S){w&&(S!=null&&S.address)&&t(0,i=w.some(L=>L.author===S.address))}async function R(){const S=Yt("v");if(S)await Q(S),q();else{if(t(8,p=Yt("q")),t(5,d=uc()),await I(),Yt("identity")==="true"&&t(3,a=!0),!V.author){const G=await ir("r");G instanceof b||(V.author=G)}p&&(await O(),H(V.author),E(),q())}}async function I(){var S;f=Yt("r"),f&&(c=!0,h=await Cu(f),l=(S=V.author)==null?void 0:S.address,h&&l&&!h.includes(l)&&(console.log("voter is not part of allowedVoters"),t(3,a=!0)))}async function E(){var S;if(c){if(l=(S=V.author)==null?void 0:S.address,!l){const L=await ir("r");L instanceof b||(V.author=L,l=V.author.address)}c&&f&&l&&(h.includes(l)?i?(t(2,s=!1),console.log("voter has already voted")):(t(2,s=!0),console.log("voter has not voted yet and is allowed to vote")):(t(2,s=!1),console.log("voter is not part of allowedVoters")))}}async function O(){let S=await Pn(p);const L=await B.queryDocs({filter:{pathStartsWith:"/"+S}}),G=L.filter(le=>le.text.trim()!=="");G.length>=0&&(w=L.filter(le=>le.text.includes("Voted")),d&&d.length>0&&(t(7,m={}),G.forEach(le=>{const Wr=le.text;t(7,m[Wr]=(m[Wr]||0)+1,m)})),H(V.author))}async function Q(S){try{const G=await(await fetch(`./configs/${S}`)).json();t(8,p=G.id),t(5,d=Object.entries(G).filter(([le])=>/^\d+$/.test(le)).map(([,le])=>le)),t(6,D=G.year),G.identity==="true"&&t(3,a=!0),G.r&&(console.log("fetching allowed voters"),c=!0,f=await Cu(G.r)),await O(),H(V.author),E()}catch(L){console.error("Error loading vote configuration:",L)}finally{t(4,o=!1)}}function q(){const S=new qr;S.addReplica(Or),S.sync(Tu.VITE_SERVER_ADDRESS,!0),V.addServer(Tu.VITE_SERVER_ADDRESS),B.onCacheUpdated(O)}return Wu(async()=>{await R(),t(4,o=!1)}),r.$$.update=()=>{r.$$.dirty&4097&&(n===!0||i===!0)&&t(2,s=!1)},[i,u,s,a,o,d,D,m,p,k,v,O,n]}class Ic extends gt{constructor(e){super(),mt(this,e,Tc,Pc,Ze,{})}}new Ic({target:document.getElementById("app")});
